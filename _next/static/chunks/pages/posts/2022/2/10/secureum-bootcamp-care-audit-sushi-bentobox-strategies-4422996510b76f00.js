(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6883],{24115:function(e,s,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/2022/2/10/secureum-bootcamp-care-audit-sushi-bentobox-strategies",function(){return t(8040)}])},8040:function(e,s,t){"use strict";t.r(s),t.d(s,{__toc:function(){return c}});var i=t(35250),n=t(47147),a=t(77298),r=t(18363),o=t(13423);let c=[{depth:2,value:"Scope",id:"scope"},{depth:2,value:"Timeline",id:"timeline"},{depth:2,value:"Findings",id:"findings"},{depth:3,value:"#1 Major: Utility function enables privilege escalation/abuse",id:"1-major-utility-function-enables-privilege-escalationabuse"},{depth:4,value:"Description",id:"description"},{depth:4,value:"Exploit Scenario",id:"exploit-scenario"},{depth:4,value:"Recommendation",id:"recommendation"},{depth:3,value:"#1 MediumFIXED: setAllowedPath() incorrectly logs array length instead of index",id:"1-mediumfixed-setallowedpath-incorrectly-logs-array-length-instead-of-index"},{depth:4,value:"Description",id:"description-1"},{depth:4,value:"Recommendation",id:"recommendation-1"},{depth:4,value:"Resolution",id:"resolution"},{depth:3,value:"#2 Medium: Unclear, possibly incorrect, Access Control",id:"2-medium-unclear-possibly-incorrect-access-control"},{depth:4,value:"Description",id:"description-2"},{depth:4,value:"Recommendation",id:"recommendation-2"},{depth:3,value:"#3 Medium: Lack of Specification",id:"3-medium-lack-of-specification"},{depth:4,value:"Description",id:"description-3"},{depth:4,value:"Recommendation",id:"recommendation-3"},{depth:3,value:"#4 Medium: Lack of Documentation",id:"4-medium-lack-of-documentation"},{depth:4,value:"Description",id:"description-4"},{depth:4,value:"Recommendation",id:"recommendation-4"},{depth:3,value:"#5 Medium: Lack of Test Coverage",id:"5-medium-lack-of-test-coverage"},{depth:4,value:"Description",id:"description-5"},{depth:4,value:"Recommendation",id:"recommendation-5"},{depth:3,value:"#1 Minor: Unnecessarily copied and adjusted code",id:"1-minor-unnecessarily-copied-and-adjusted-code"},{depth:4,value:"Description",id:"description-6"},{depth:4,value:"Recommendation",id:"recommendation-6"},{depth:3,value:"#2 Minor: Missing Address Validation",id:"2-minor-missing-address-validation"},{depth:4,value:"Description",id:"description-7"},{depth:4,value:"Recommendation",id:"recommendation-7"},{depth:3,value:"#3 Minor: Emergency exits delayed by setStrategy",id:"3-minor-emergency-exits-delayed-by-setstrategy"},{depth:4,value:"Description",id:"description-8"},{depth:4,value:"Recommendation",id:"recommendation-8"},{depth:3,value:"#4 Minor: Limit usage of new Strategies",id:"4-minor-limit-usage-of-new-strategies"},{depth:4,value:"Description",id:"description-9"},{depth:4,value:"Recommendation",id:"recommendation-9"},{depth:3,value:"#5 Minor: Administrative functions should emit events",id:"5-minor-administrative-functions-should-emit-events"},{depth:4,value:"Description",id:"description-10"},{depth:4,value:"Recommendation",id:"recommendation-10"},{depth:3,value:"#6 MinorFIXED: Public functions should be external",id:"6-minorfixed-public-functions-should-be-external"},{depth:4,value:"Description",id:"description-11"},{depth:4,value:"Recommendation",id:"recommendation-11"},{depth:3,value:"#7 MinorFIXED: Redundant check can be removed",id:"7-minorfixed-redundant-check-can-be-removed"},{depth:4,value:"Description",id:"description-12"},{depth:4,value:"Recommendation",id:"recommendation-12"},{depth:3,value:"#8 Minor: Making afterExit() payable",id:"8-minor-making-afterexit-payable"},{depth:4,value:"Description",id:"description-13"},{depth:4,value:"Recommendation",id:"recommendation-13"},{depth:3,value:"#9 MinorFIXED: Incorrect usage of Unlocked Pragma",id:"9-minorfixed-incorrect-usage-of-unlocked-pragma"},{depth:4,value:"Description",id:"description-14"},{depth:4,value:"Recommendation",id:"recommendation-14"},{depth:3,value:"#10 Minor: Avoid variable shadowing",id:"10-minor-avoid-variable-shadowing"},{depth:4,value:"Description",id:"description-15"},{depth:4,value:"Recommendation",id:"recommendation-15"},{depth:3,value:"#11 MinorFIXED: Use SafeERC20 in ExampleImplementation",id:"11-minorfixed-use-safeerc20-in-exampleimplementation"},{depth:4,value:"Recommendation",id:"recommendation-16"},{depth:2,value:"Missed Findings",id:"missed-findings"},{depth:2,value:"Disclosure",id:"disclosure"},{depth:2,value:"Resources",id:"resources"}];function _createMdxContent(e){let s=Object.assign({h1:"h1",a:"a",p:"p",hr:"hr",h2:"h2",code:"code",ul:"ul",li:"li",blockquote:"blockquote",strong:"strong",table:"table",thead:"thead",tr:"tr",th:"th",tbody:"tbody",td:"td",h3:"h3",h4:"h4",ol:"ol",pre:"pre",span:"span"},(0,a.a)(),e.components);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.h1,{children:"Secureum Bootcamp CARE: Sushi's BentoBox Strategies"}),"\n",(0,i.jsxs)("p",{className:"text-xs text-right",children:["February 10, 2022 by ",(0,i.jsx)(s.a,{href:"/about#patrickd",children:"patrickd"})]}),"\n",(0,i.jsxs)(s.p,{children:["This report is the result of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/secureum-bootcamp-for-smart-contract",children:"Secureum Bootcamp's Epoch 0, second phase"}),", CARE (Comprehensive Audit Readiness Evaluation) which is intended as a way to improve a project's security stance in preparation for an Audit, allowing Auditors to spend more time looking for critical issues. As such, this review centers mostly around the ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-101",children:"Security 201 Pitfalls"})," & ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-201",children:"Best Practices"})," that were taught during the Bootcamp. Despite that, and the fact that the review is done by me alone, this is still a best-effort approach to find as many issues beyond that as possible."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"scope",children:"Scope"}),"\n",(0,i.jsxs)(s.p,{children:["Focus of this review are ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/",children:"BentoBox"})," ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies",children:"Strategy"})," contracts belonging to the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap",children:"Sushi/SushiSwap ecosystem"}),", of the commit hash ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/commit/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e",children:(0,i.jsx)(s.code,{children:"be407e27cd1a9ca8060ef9a389d1cf01b4e5540e"})}),":"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol",children:(0,i.jsx)(s.code,{children:"contracts/BaseStrategy.sol"})})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/strategies/AaveStrategy.sol",children:(0,i.jsx)(s.code,{children:"contracts/strategies/AaveStrategy.sol"})})}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"The following additional information was provided:"}),"\n",(0,i.jsxs)(s.blockquote,{children:["\n",(0,i.jsx)(s.p,{children:"Knowledge of how BentoBox interacts with the strategies is crucial for understanding the bentobox-strategies. Pay special attention to the BentoBox “harvest” and “setStrategy” methods."}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Tests and Utilities:"}),"\nSet up a .env file and include an alchemy API key. (note: the block number used for forks might have to be updated if there is no access to an archive node)."]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"Key risks:"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Ensure Base strategy does not misreport profit or losses to BentoBox."}),"\n",(0,i.jsx)(s.li,{children:"Ensure no loss of funds can happen from external actors."}),"\n",(0,i.jsx)(s.li,{children:"Ensure BentoBox can always swap a strategy for a new one (‘strategy.exit()’ call should never fail)"}),"\n",(0,i.jsx)(s.li,{children:"Ensure the Aave strategy correctly deposits and withdrawals from the Aave lending platform."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"timeline",children:"Timeline"}),"\n",(0,i.jsxs)(s.p,{children:["The review was conducted in ",(0,i.jsx)(s.strong,{children:"December 2021"})," over a period of two weeks, from Monday the 6th until Friday the 17th. In the first week, the focus was on gaining a general understanding of the BentoBox project and the Sushi ecosystem from reading documentation, blog posts and exploring the codebase. After checking for 201 Secureum Security Pitfalls & Best Practices on contracts in scope, analyzers such as ",(0,i.jsx)(s.a,{href:"https://github.com/crytic/slither/releases/tag/0.8.2",children:"Slither v0.8.2"}),", ",(0,i.jsx)(s.a,{href:"https://mythx.io/",children:"MythX"}),", and ",(0,i.jsx)(s.a,{href:"https://github.com/smartdec/smartcheck",children:"smartdec's SmartCheck"})," were run. The second week was focused on manual review for the above-mentioned Key Risks and finished by setting up fuzzable properties for them in ",(0,i.jsx)(s.a,{href:"https://github.com/crytic/echidna",children:"Echidna"}),"."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"findings",children:"Findings"}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Count"}),(0,i.jsx)(s.th,{children:"Severity"}),(0,i.jsx)(s.th,{children:"Description"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"0"}),(0,i.jsx)(s.td,{children:(0,i.jsx)("span",{s:4,children:(0,i.jsx)(s.code,{children:"Critical"})})}),(0,i.jsx)(s.td,{children:"Directly exploitable security vulnerabilities that need to be fixed."})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"1"}),(0,i.jsx)(s.td,{children:(0,i.jsx)("span",{s:3,children:(0,i.jsx)(s.code,{children:"Major"})})}),(0,i.jsx)(s.td,{children:"Security vulnerabilities that may not be directly exploitable or may require certain conditions in order to be exploited. All major issues should be addressed."})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"5"}),(0,i.jsx)(s.td,{children:(0,i.jsx)("span",{s:2,children:(0,i.jsx)(s.code,{children:"Medium"})})}),(0,i.jsx)(s.td,{children:"Objective in nature but are not security vulnerabilities. Should be addressed unless there is a clear reason not to."})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"11"}),(0,i.jsx)(s.td,{children:(0,i.jsx)("span",{s:1,children:(0,i.jsx)(s.code,{children:"Minor"})})}),(0,i.jsx)(s.td,{children:"Subjective in nature. They are typically suggestions around best practices or readability. Code maintainers should use their own judgment as to whether to address such issues."})]})]})]}),"\n",(0,i.jsxs)(s.p,{children:["Before publishing the report, the code was roughly checked for whether and which issues have been addressed. Those findings have been marked as ",(0,i.jsx)("span",{s:0,children:(0,i.jsx)(s.code,{children:"FIXED"})})," fixed when sufficient mitigation was found."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"1-major-utility-function-enables-privilege-escalationabuse",children:[(0,i.jsx)("a",{id:"maj-1",href:"#maj-1",children:(0,i.jsx)("span",{s:3,children:(0,i.jsx)(s.code,{children:"#1 Major"})})}),": Utility function enables privilege escalation/abuse"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified during manual review. Related checklist items would be ",(0,i.jsx)(s.strong,{children:"160. Trusted actors"}),", ",(0,i.jsx)(s.strong,{children:"161. Privileged roles and EOAs"})," and ",(0,i.jsx)(s.strong,{children:"181. Trust issues"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-201",children:"Security Pitfalls & Best Practices 201"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"description",children:"Description"}),"\n",(0,i.jsxs)(s.p,{children:["Governance of the BentoBox contract and its Strategies is, ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L15",children:"according to documentation"}),", under control of the ",(0,i.jsx)(s.a,{href:"https://docs.sushi.com/governance/current-governance-model",children:"Sushi Operations MultiSig"}),", which requires at least 3 signatures for a change to pass."]}),"\n",(0,i.jsxs)(s.p,{children:["This is rather centralized and requires some trust of the users in the Ops Team. To restrict the powers of the operations team, some measures were taken such as the 2-weeks-delay when setting new Strategies (",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/bentobox/BentoBoxV1.sol#L709",children:(0,i.jsx)(s.code,{children:"STRATEGY_DELAY"})}),") allowing the Sushi community to review Strategies before they take effect. There's also the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L254-L263",children:(0,i.jsx)(s.code,{children:"BaseStrategy.afterExit()"})})," function that allows powerful arbitrary calls to be made for the purposes of rescuing funds, but it can only be used once the Strategy has been exited and all funds have been withdrawn from the Strategy."]}),"\n",(0,i.jsxs)(s.p,{children:["The utility function ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L283",children:(0,i.jsx)(s.code,{children:"swapExactTokensForUnderlying()"})})," introduced by the abstract BaseStrategy contract allows bypassing these measures and will affect all Strategy implementations inheriting it. The requirement of the exploit scenario is that either the Ops MultiSig Wallet has been compromised or that at least 3 bad actors within the Operations Team collude."]}),"\n",(0,i.jsx)(s.h4,{id:"exploit-scenario",children:"Exploit Scenario"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["Ops MultiSig (OMS) calls ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/blob/master/contracts/BentoBox.sol#L419",children:(0,i.jsx)(s.code,{children:"BentoBox.setStrategy()"})})," in order to replace the current AaveStrategy with a new Strategy, waits for the 2-week-delay to pass, but does not call it again yet for the Strategy-change to take effect."]}),"\n",(0,i.jsxs)(s.li,{children:["OMS adds a new path via ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L269",children:(0,i.jsx)(s.code,{children:"BaseStrategy.setAllowedPath()"})})," allowing swapping of aTokens to WETH (or any other asset that is not the invested ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L21",children:(0,i.jsx)(s.code,{children:"strategyToken"})})," itself)."]}),"\n",(0,i.jsxs)(s.li,{children:["OMS adds an Executor it has full control over via ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L136",children:(0,i.jsx)(s.code,{children:"BaseStrategy.setStrategyExecutor()"})}),", if one isn't already under control of OMS."]}),"\n",(0,i.jsxs)(s.li,{children:["OMS uses Executor and calls ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L283",children:(0,i.jsx)(s.code,{children:"BaseStrategy.swapExactTokensForUnderlying()"})})," to swap all aTokens with newly added swapping path."]}),"\n",(0,i.jsxs)(s.li,{children:["OMS now calls ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/blob/master/contracts/BentoBox.sol#L419",children:(0,i.jsx)(s.code,{children:"BentoBox.setStrategy()"})})," again for the Strategy-change to take effect, which makes BentoBox call ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/blob/master/contracts/BentoBox.sol#L431",children:(0,i.jsx)(s.code,{children:"BaseStrategy.exit()"})}),"."]}),"\n",(0,i.jsx)(s.li,{children:"Exit appears to have succeeded, but all of the Strategy's funds are still in the Strategy contract."}),"\n",(0,i.jsxs)(s.li,{children:["OMS is now able to do arbitrary calls via ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L254",children:(0,i.jsx)(s.code,{children:"BentoBox.afterExit()"})}),", allowing all of the Strategy funds to be stolen."]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["The impact of this scenario can further be increased by raising the Strategy target percentage (via ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/blob/master/contracts/BentoBox.sol#L400",children:(0,i.jsx)(s.code,{children:"setStrategyTargetPercentage()"})}),") to 95% (",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/blob/master/contracts/BentoBox.sol#L81",children:(0,i.jsx)(s.code,{children:"MAX_TARGET_PERCENTAGE"})}),") of the BentoBox's funds and rebalancing them into the active Strategy (using ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/blob/master/contracts/BentoBox.sol#L463",children:(0,i.jsx)(s.code,{children:"harvest(token, true, 0)"})}),")."]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation",children:"Recommendation"}),"\n",(0,i.jsxs)(s.p,{children:["To prevent this specific exploit scenario, ensure that all swap paths must end with the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L21",children:(0,i.jsx)(s.code,{children:"strategyToken"})})," to be valid. This should ensure that when swapping happens with Strategy funds, they will be withdrawn by BentoBox when the Strategy is exited. That way the powers of the Sushi Operations MultiSig should again be appropriately restricted, at least within expectations."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"1-mediumfixed-setallowedpath-incorrectly-logs-array-length-instead-of-index",children:[(0,i.jsxs)("a",{id:"med-1",href:"#med-1",children:[(0,i.jsx)("span",{s:2,children:(0,i.jsx)(s.code,{children:"#1 Medium"})}),(0,i.jsx)("span",{s:0,children:(0,i.jsx)(s.code,{children:"FIXED"})})]}),": ",(0,i.jsx)(s.code,{children:"setAllowedPath()"})," incorrectly logs array length instead of index"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified during manual review. A possible corresponding checklist item would be ",(0,i.jsx)(s.strong,{children:"173. Auditing/logging issues"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-201",children:"Security Pitfalls & Best Practices 201"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"description-1",children:"Description"}),"\n",(0,i.jsxs)(s.p,{children:["The ",(0,i.jsx)(s.code,{children:"LogSetAllowedPath"})," event logs the ",(0,i.jsx)(s.code,{children:"pathId"})," which is the index of a path within the ",(0,i.jsx)(s.code,{children:"_allowedSwapPaths"})," array:"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L43",children:(0,i.jsx)(s.strong,{children:"contracts/BaseStrategy.sol#L43"})})}),"\n",(0,i.jsx)(s.pre,{"data-language":"solidity","data-theme":"default",children:(0,i.jsx)(s.code,{"data-language":"solidity","data-theme":"default",children:(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"event"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"LogSetAllowedPath"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"uint256"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"indexed"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" pathId, "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"bool"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" allowed);"})]})})}),"\n",(0,i.jsxs)(s.p,{children:["The ",(0,i.jsx)(s.code,{children:"setAllowedPath()"})," function incorrectly logs the array length after a new path was added instead of the index of the new path:"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L269-L272",children:(0,i.jsx)(s.strong,{children:"contracts/BaseStrategy.sol#L269-L272"})})}),"\n",(0,i.jsx)(s.pre,{"data-language":"solidity","data-theme":"default",children:(0,i.jsxs)(s.code,{"data-language":"solidity","data-theme":"default",children:[(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"setAllowedPath"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"[] "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"calldata"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" path) "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"external"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"onlyOwner"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    _allowedSwapPaths."}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"push"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(path);"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"emit"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"LogSetAllowedPath"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(_allowedSwapPaths.length"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"true"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,i.jsxs)(s.p,{children:["Incorrect logging of the ",(0,i.jsx)(s.code,{children:"pathId"})," could cause wrong assumptions for the operations team (owner) when maintaining the ",(0,i.jsx)(s.code,{children:"_allowedSwapPaths"})," array contents. It could for example lead to an incorrect path being disabled via ",(0,i.jsx)(s.code,{children:"disallowPath()"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-1",children:"Recommendation"}),"\n",(0,i.jsxs)(s.p,{children:["Correctly log the index as ",(0,i.jsx)(s.code,{children:"pathId"})," instead, for example, by calculating ",(0,i.jsx)(s.code,{children:"_allowedSwapPaths.length - 1"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"resolution",children:"Resolution"}),"\n",(0,i.jsxs)(s.p,{children:["Allowed swap path logic has been changed and the ",(0,i.jsx)(s.code,{children:"LogSetAllowedPath"})," event does no longer exist."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"2-medium-unclear-possibly-incorrect-access-control",children:[(0,i.jsx)("a",{id:"med-2",href:"#med-2",children:(0,i.jsx)("span",{s:2,children:(0,i.jsx)(s.code,{children:"#2 Medium"})})}),": Unclear, possibly incorrect, Access Control"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified during manual review. The corresponding checklist items would be ",(0,i.jsx)(s.strong,{children:"148. Access control specification"}),", possibly also ",(0,i.jsx)(s.strong,{children:"4. Incorrect access control"})," and ",(0,i.jsx)(s.strong,{children:"150 Missing modifiers"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-101",children:"Security Pitfalls & Best Practices 101"})," and ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-201",children:"Security Pitfalls & Best Practices 201"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"description-2",children:"Description"}),"\n",(0,i.jsx)(s.p,{children:"There's no specification regarding Access Control, the system actors, and the actions they are allowed to take. This forces Auditors to infer intention from the implementation making it difficult to distinguish between oversight and a purposeful choice."}),"\n",(0,i.jsxs)(s.p,{children:["An example of this issue would be the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L142-L144",children:(0,i.jsx)(s.code,{children:"BaseStrategy.skim()"})})," function, which has no access control at all, allowing any external actors to trigger the investment of funds, even if the caller isn't the BentoBox contract or even when the strategy was already exited and is therefore considered inactive:"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L142-L144",children:(0,i.jsx)(s.strong,{children:"contracts/BaseStrategy.sol#L142-L144"})})}),"\n",(0,i.jsx)(s.pre,{"data-language":"solidity","data-theme":"default",children:(0,i.jsxs)(s.code,{"data-language":"solidity","data-theme":"default",children:[(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"skim"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"uint256"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" amount) "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"external"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"override"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"_skim"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(amount);"})]}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/strategies/AaveStrategy.sol#L73-L75",children:(0,i.jsx)(s.strong,{children:"contracts/strategies/AaveStrategy.sol#L73-L75"})})}),"\n",(0,i.jsx)(s.pre,{"data-language":"solidity","data-theme":"default",children:(0,i.jsxs)(s.code,{"data-language":"solidity","data-theme":"default",children:[(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"_skim"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"uint256"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" amount) "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"internal"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"override"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    aaveLendingPool."}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"deposit"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(strategyToken)"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" amount"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:")"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,i.jsxs)(s.p,{children:["While this is not a direct vulnerability that could cause a loss of funds under normal circumstances, I was unable to infer a good reason for this function to lack all of the modifiers similar functions such as ",(0,i.jsx)(s.code,{children:"harvest()"}),", ",(0,i.jsx)(s.code,{children:"withdraw()"})," and ",(0,i.jsx)(s.code,{children:"exit()"})," have."]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-2",children:"Recommendation"}),"\n",(0,i.jsx)(s.p,{children:"Create an Access control specification that describes how the various system actors, their access control privileges and trust assumptions are intended to be in great detail."}),"\n",(0,i.jsxs)(s.p,{children:["Add appropriate modifiers (most likely ",(0,i.jsx)(s.code,{children:"isActive"})," and ",(0,i.jsx)(s.code,{children:"onlyBentoBox"}),") to the ",(0,i.jsx)(s.code,{children:"skim()"})," function or add inline documentation on why these were skipped on purpose."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"3-medium-lack-of-specification",children:[(0,i.jsx)("a",{id:"med-3",href:"#med-3",children:(0,i.jsx)("span",{s:2,children:(0,i.jsx)(s.code,{children:"#3 Medium"})})}),": Lack of Specification"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified during manual review. The corresponding checklist item is ",(0,i.jsx)(s.strong,{children:"136. System specification"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-201",children:"Security Pitfalls & Best Practices 201"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"description-3",children:"Description"}),"\n",(0,i.jsxs)(s.p,{children:["The lack of any specification forces Auditors to infer the intent from the implementation and the context of it being a BentoBox Strategy. In comparison, the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox",children:"BentoBox contracts"})," have ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/tree/master/spec",children:"formal specifications"}),", validated by the ",(0,i.jsx)(s.a,{href:"https://www.certora.com/",children:"Certora prover"}),". The BentoBox repository also contains a ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/blob/master/contracts/strategies/CompoundStrategy.sol",children:(0,i.jsx)(s.code,{children:"CompoundStrategy.sol"})})," implementation with its corresponding specification ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/blob/master/spec/compoundStrategy.spec",children:"compoundStrategy.spec"}),". It's likely that these specifications can be reused for the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies",children:"github.com/sushiswap/bentobox-strategies"})," repository with reasonable effort."]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-3",children:"Recommendation"}),"\n",(0,i.jsx)(s.p,{children:"While it would have been best to create a human-readable specification before the implementation was done, in this case, it would still be beneficial to create a formal specification that can prove, together with automated tests, that the implementation was done correctly and will stay so after future changes."}),"\n",(0,i.jsxs)(s.p,{children:["I would recommend creating a formal specification based on the Certora prover specs already available in the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox",children:"BentoBox"})," repository."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"4-medium-lack-of-documentation",children:[(0,i.jsx)("a",{id:"med-4",href:"#med-4",children:(0,i.jsx)("span",{s:2,children:(0,i.jsx)(s.code,{children:"#4 Medium"})})}),": Lack of Documentation"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified during manual review. The corresponding checklist items are ",(0,i.jsx)(s.strong,{children:"137. System documentation"})," and possibly ",(0,i.jsx)(s.strong,{children:"188. Clarity issues"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-201",children:"Security Pitfalls & Best Practices 201"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"description-4",children:"Description"}),"\n",(0,i.jsxs)(s.p,{children:["The documentation of the contracts in scope currently consists only of their inline comments and a single ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/README.md",children:"README.md"})," file. While these have decent quality, there's still a lack of higher-level documentation, especially compared to the documentation that the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/",children:"BentoBox repository"})," is offering in comparison (eg. on ",(0,i.jsx)(s.a,{href:"https://dev.sushi.com/bentobox-1/bentobox-vault",children:"dev.sushi.com"}),")."]}),"\n",(0,i.jsx)(s.p,{children:"Specific examples of a lack of documentation:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["While some instructions on how to run the tests were provided together with the CARE project information, they should have been part of the public documentation in the repository. Additionally, the instructions were insufficient and unclear requiring a lot more setup and investigation until I was finally able to run the tests locally. For example, it is not sufficient to specify an Alchemy API key, a ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/.env.example#L5",children:"Infura Key"})," was required as well to get them running. And while it is mentioned that the block number used for the fork might need to be adjusted if the user doesn't have a very expensive infura subscription to access mainnet archive data, it is not explained that this needs to be done within the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/test/AaveStrategyMainnet.ts#L43",children:"JavaScript code of the tests"})," themselves. These difficulties in combination with the fact that on ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/runs/4417891520?check_suite_focus=true",children:"GitLab CI the tests are currently failing"})," as well, does not induce confidence in the testsuite."]}),"\n",(0,i.jsxs)(s.li,{children:["Whether Aave's V1 or V2 contracts are used is not clearly documented anywhere and requires some research to be determined. Similarly, there's the question of why Uniswap V2 is used instead of the current V3, especially since in the code it is specified as being \"",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L63",children:"legacy"}),'".']}),"\n",(0,i.jsxs)(s.li,{children:["There's also an apparent lack of documentation on how to use and handle the lifecycle of a BentoBox Strategy for Sushi's operations team. Setting and replacing strategies, harvesting rewards properly, handling emergencies, and available ways to attempt the rescue of funds, are all manual steps members of the Ops Team have to understand and apply properly. A lack of clarity on how to handle them can lead to security issues or loss of funds, especially if people in the team, and therefore implicit knowledge, are lost. A specific example would be the fact that Strategies are one-time use, once exited, they can still be set as valid Strategy and they will still be able to receive tokens from BentoBox, but skimming will fail, requiring the use of ",(0,i.jsx)(s.code,{children:"afterExit()"})," to rescue the funds. The fact that Strategies must not be re-used should be clearly documented both for the Ops Team and the community."]}),"\n"]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-4",children:"Recommendation"}),"\n",(0,i.jsx)(s.p,{children:"Additionally to what already exists, write high-level documentation similarly to how it was done for BentoBox."}),"\n",(0,i.jsx)(s.p,{children:"Specific recommendations for the mentioned examples:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Create public and more detailed instructions on how tests can be run and explain how to do so while lacking access to costly subscriptions. Consider the introduction of more environment variables that allow easily tweaking test parameters without the need of changing hardcoded constants. Fix the CI pipelines on GitHub and add badges for test success and coverage to the readme file."}),"\n",(0,i.jsx)(s.li,{children:"Document the versions used of all external contracts and libraries, and explain the choice of using versions that are older than what is currently available. Additionally to documenting the commit hash that was used during deployment in the readme, also document the configuration values that were passed to the constructor during deployment and link them to the appropriate transaction on etherscan."}),"\n",(0,i.jsx)(s.li,{children:"Create public, playbook-like documentation for the Sushi Ops Team to ensure that even after a long time or after the team was replaced by new members, knowledge on the maintenance and incident handling for BentoBox Strategies isn't forgotten and can be made use of without requiring long investigations. Especially during emergency-like situations, where time is of the essence to save funds, this will likely prove useful."}),"\n"]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"5-medium-lack-of-test-coverage",children:[(0,i.jsx)("a",{id:"med-5",href:"#med-5",children:(0,i.jsx)("span",{s:2,children:(0,i.jsx)(s.code,{children:"#5 Medium"})})}),": Lack of Test Coverage"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified during manual review. The corresponding checklist item is ",(0,i.jsx)(s.strong,{children:"155. Tests"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-201",children:"Security Pitfalls & Best Practices 201"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"description-5",children:"Description"}),"\n",(0,i.jsx)(s.p,{children:"The coverage of the existing automated tests is lacking, especially in regards to the key risks that were identified for CARE."}),"\n",(0,i.jsx)(s.p,{children:"Specific cases that have been identified as lacking a test:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Function and access control of BaseStrategy's ",(0,i.jsxs)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L265-L278",children:[(0,i.jsx)(s.code,{children:"getAllowedPath()"}),", ",(0,i.jsx)(s.code,{children:"setAllowedPath()"}),", ",(0,i.jsx)(s.code,{children:"disallowPath()"})]})," and ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L136-L139",children:(0,i.jsx)(s.code,{children:"setStrategyExecutor()"})})," functions."]}),"\n",(0,i.jsxs)(s.li,{children:["Whether BaseStrategy's ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L115",children:(0,i.jsx)(s.code,{children:"isActive"})})," modifier functions correctly, preventing access after the Strategy was exited, and is applied to all appropriate functions."]}),"\n",(0,i.jsxs)(s.li,{children:["Whether the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L254-L263",children:(0,i.jsx)(s.code,{children:"BaseStrategy.afterExit()"})})," function can only be accessed by the contract owner (testing for ",(0,i.jsx)(s.code,{children:"onlyOwner"})," modifier) and that it can only be successfully called once the Strategy was exited."]}),"\n",(0,i.jsxs)(s.li,{children:["Whether the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L37",children:(0,i.jsx)(s.code,{children:"maxChangeAmount"})})," parameter, set by ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L164",children:(0,i.jsx)(s.code,{children:"BaseStrategy.safeHarvest()"})})," and used by ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L180",children:(0,i.jsx)(s.code,{children:"BaseStrategy.harvest()"})}),", works as expected."]}),"\n",(0,i.jsxs)(s.li,{children:["Whether the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L297-L299",children:"slippage protection"})," offered by the ",(0,i.jsx)(s.code,{children:"amountOutMin"})," parameter of ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L283-L304",children:(0,i.jsx)(s.code,{children:"BaseStrategy.swapExactTokensForUnderlying()"})})," functions correctly."]}),"\n",(0,i.jsxs)(s.li,{children:["Whether the internal ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L307-L320",children:(0,i.jsx)(s.code,{children:"BaseStrategy._swap()"})})," function still works correctly for paths with more than 2 assets."]}),"\n",(0,i.jsxs)(s.li,{children:["Whether ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L240-L250",children:(0,i.jsx)(s.code,{children:"BaseStrategy.exit()"})})," still works as expected during exceptional situations (eg. ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/strategies/AaveStrategy.sol#L93-L95",children:"Aave protocol was hacked and less strategy tokens are available than the contract has aTokens"}),", ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/strategies/AaveStrategy.sol#L91-L92",children:"withdrawal failed with error but exit still succeeds"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Whether checks in ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L179",children:(0,i.jsx)(s.code,{children:"BaseStrategy.harvest()"})}),", preventing harvest of senders other than the strategy itself, are implemented correctly."]}),"\n"]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-5",children:"Recommendation"}),"\n",(0,i.jsx)(s.p,{children:"Improve test coverage by implementing the specific cases above and by checking the coverage report. Aim for a minimum measured coverage of 100% and make sure that paths aren't only covered but also properly tested. At the moment many of the tests make simple greater-than-checks instead of checking for specific values, which counts towards coverage but might still allow for issues to slip through in regards to profit reporting. The tests currently also always assume that a profit was made, the handling of losses is currently not tested."}),"\n",(0,i.jsxs)(s.p,{children:["Furthermore, I'd recommend a separation of tests between the AaveStrategy implementations and the BaseStrategy. Many tests are specific to the base contract but are duplicated in both ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/test/AaveStrategyMainnet.ts",children:(0,i.jsx)(s.code,{children:"AaveStrategyMainnet.ts"})})," and ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/test/AaveStrategyPolygon.ts",children:(0,i.jsx)(s.code,{children:"AaveStrategyPolygon.ts"})}),". To do that, you could create a barebones implementation contract or simply use the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/ExampleImplementation.sol",children:(0,i.jsx)(s.code,{children:"ExampleImplementation.sol"})})," contract that already exists."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"1-minor-unnecessarily-copied-and-adjusted-code",children:[(0,i.jsx)("a",{id:"min-1",href:"#min-1",children:(0,i.jsx)("span",{s:1,children:(0,i.jsx)(s.code,{children:"#1 Minor"})})}),": Unnecessarily copied and adjusted code"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified during manual review. The corresponding checklist item is ",(0,i.jsx)(s.strong,{children:"190. Cloning issues"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-201",children:"Security Pitfalls & Best Practices 201"})," and ",(0,i.jsx)(s.strong,{children:"3. Multiple Solidity pragma"})," as a side effect, see ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-101",children:"Security Pitfalls & Best Practices 101"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"description-6",children:"Description"}),"\n",(0,i.jsxs)(s.p,{children:["The file ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/bentobox/BentoBoxV1.sol",children:"contracts/bentobox/BentoBoxV1.sol"})," is a copy from ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/blob/master/contracts/flat/BentoBoxFlat.sol",children:"contracts/flat/BentoBoxFlat.sol"})," of the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox",children:"BentoBox"}),". However, the ",(0,i.jsxs)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/bentobox/BentoBoxV1.sol#L709",children:[(0,i.jsx)(s.code,{children:"STRATEGY_DELAY"})," constant was adjusted from ",(0,i.jsx)(s.code,{children:"2 weeks"})," to ",(0,i.jsx)(s.code,{children:"0"})]}),", which was not documented (except for the inline comment ",(0,i.jsx)(s.code,{children:"// yeehaw"}),"). This was likely done to be able to more easily set and change strategies during testing, it can however cause incorrect assumptions and confusion for developers and auditors. It also causes issues with some analysis tools that are unable to handle multiple incompatible Solidity versions within the same project, requiring manual assistance to be run."]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-6",children:"Recommendation"}),"\n",(0,i.jsxs)(s.p,{children:["The BentoBoxV1 contract appears to be only used within tests, and in those, it is not actually deployed but only attached to an existing BentoBox contract from a chain fork. Using an Interface here instead should be sufficient and allow the removal of ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/bentobox/BentoBoxV1.sol",children:"BentoBoxV1.sol"}),"."]}),"\n",(0,i.jsx)(s.p,{children:"If there's a reason for keeping the copied code in the repository, this should be properly documented, especially where it was copied from, which version, and what changes were made for what reasons."}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"2-minor-missing-address-validation",children:[(0,i.jsx)("a",{id:"min-2",href:"#min-2",children:(0,i.jsx)("span",{s:1,children:(0,i.jsx)(s.code,{children:"#2 Minor"})})}),": Missing Address Validation"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified during manual review. The corresponding checklist item is ",(0,i.jsx)(s.strong,{children:"49. Missing zero address validation"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-101",children:"Security Pitfalls & Best Practices 101"})," and potentially ",(0,i.jsx)(s.strong,{children:"165. Configuration issues"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-201",children:"Security Pitfalls & Best Practices 201"}),"."]}),"\n",(0,i.jsxs)(s.p,{children:["Also identified by ",(0,i.jsx)(s.a,{href:"https://github.com/crytic/slither/releases/tag/0.8.2",children:"Slither v0.8.2"}),":"]}),"\n",(0,i.jsx)(s.pre,{"data-language":"text","data-theme":"default",children:(0,i.jsxs)(s.code,{"data-language":"text","data-theme":"default",children:[(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"BaseStrategy.afterExit(address,uint256,bytes).to (contracts/BaseStrategy.sol#255) lacks a zero-check on :"})}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"                - (success,None) = to.call{value: value}(data) (contracts/BaseStrategy.sol#262)"})}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#missing-zero-address-validation"})})]})}),"\n",(0,i.jsx)(s.h4,{id:"description-7",children:"Description"}),"\n",(0,i.jsxs)(s.p,{children:["The ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L254-L263",children:(0,i.jsx)(s.code,{children:"BaseStrategy.afterExit()"})})," function is available to the Sushi Ops Team as a way to rescue funds after usage of the Strategy has ended. One such case would be rescuing ether funds that were sent to the contract on accident. Due to the missing zero-address validation, it might happen that instead of rescuing the funds they will be burned on accident."]}),"\n",(0,i.jsxs)(s.p,{children:["Other than that, due to the usage of a send-funds-and-skim pattern, invalid ",(0,i.jsxs)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L70-L71",children:[(0,i.jsx)(s.code,{children:"strategyToken"})," and ",(0,i.jsx)(s.code,{children:"bentoBox"})]})," parameters used during construction could lead to a scenario where funds have already been sent to the strategy but cannot be skimmed. In such a case the ",(0,i.jsx)(s.code,{children:"exit()"})," function might not be callable either, which would prevent any rescue of the funds using the ",(0,i.jsx)(s.code,{children:"afterExit()"})," function."]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-7",children:"Recommendation"}),"\n",(0,i.jsxs)(s.p,{children:["Consider introducing a zero-address validation for the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L254-L263",children:(0,i.jsx)(s.code,{children:"BaseStrategy.afterExit()"})})," function and constructor parameters."]}),"\n",(0,i.jsx)(s.p,{children:"Introduce a process that makes sure the correct values have been set post-deployment before a strategy is used."}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"3-minor-emergency-exits-delayed-by-setstrategy",children:[(0,i.jsx)("a",{id:"min-3",href:"#min-3",children:(0,i.jsx)("span",{s:1,children:(0,i.jsx)(s.code,{children:"#3 Minor"})})}),": Emergency exits delayed by setStrategy"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified during manual review. The issue is related to checklist item ",(0,i.jsx)(s.strong,{children:"135. Guarded launch via emergency shutdown"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-201",children:"Security Pitfalls & Best Practices 201"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"description-8",children:"Description"}),"\n",(0,i.jsxs)(s.p,{children:["BentoBox's ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/blob/master/contracts/BentoBox.sol#L419",children:(0,i.jsx)(s.code,{children:"setStrategy()"})})," function enforces a two-week delay for setting new strategies allowing the community to review them before they actually take effect. But since Strategies can only be exited when a new one is set, this also prevents emergency exits eg. when there are issues with the Strategie's underlying protocol."]}),"\n",(0,i.jsxs)(s.p,{children:["A way to bypass this restriction is using ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/blob/master/contracts/BentoBox.sol#L400",children:(0,i.jsx)(s.code,{children:"setStrategyTargetPercentage()"})}),", setting the percentage to ",(0,i.jsx)(s.code,{children:"0"}),", and triggering a harvest for re-balancing."]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-8",children:"Recommendation"}),"\n",(0,i.jsx)(s.p,{children:"Since BentoBox has already been deployed and further code changes are difficult to introduce, it would make sense to at least document the bypass for the Sushi Ops Team to ensure awareness of this measure once an emergency happens and urgent action needs to be taken."}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"4-minor-limit-usage-of-new-strategies",children:[(0,i.jsx)("a",{id:"min-4",href:"#min-4",children:(0,i.jsx)("span",{s:1,children:(0,i.jsx)(s.code,{children:"#4 Minor"})})}),": Limit usage of new Strategies"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified during manual review. The corresponding checklist item is ",(0,i.jsx)(s.strong,{children:"128. Guarded launch via asset limits"})," of and ",(0,i.jsx)(s.strong,{children:"129. Guarded launch via asset types"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-201",children:"Security Pitfalls & Best Practices 201"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"description-9",children:"Description"}),"\n",(0,i.jsxs)(s.p,{children:["Each BentoBox Strategy implementation is likely to use different underlying protocols which means that there could be undiscovered issues when first using one. The ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox/blob/master/contracts/BentoBox.sol#L81",children:(0,i.jsx)(s.code,{children:"MAX_TARGET_PERCENTAGE"})})," limit of 95% is extremely high and its immediate usage could lead to a near-total loss of funds when used with a vulnerable Strategy. There's also no restriction to how many BentoBox assets can be using the same Strategy code at once."]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-9",children:"Recommendation"}),"\n",(0,i.jsx)(s.p,{children:"The process of introducing a new Strategy to a BentoBox asset should always include an initial limitation to the target percentage to ensure that the impact of undiscovered issues is limited. This limit to the percentage can then slowly be raised over time with increased confidence in the Strategy's implementation. It would also be better to initially only use a Strategy for a single or few assets and only increase the number of assets once confidence in the Strategy is sufficient."}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"5-minor-administrative-functions-should-emit-events",children:[(0,i.jsx)("a",{id:"min-5",href:"#min-5",children:(0,i.jsx)("span",{s:1,children:(0,i.jsx)(s.code,{children:"#5 Minor"})})}),": Administrative functions should emit events"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified during manual review. The corresponding checklist items are ",(0,i.jsx)(s.strong,{children:"45. Missing events"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-101",children:"Security Pitfalls & Best Practices 101"})," and ",(0,i.jsx)(s.strong,{children:"173. Auditing/logging issues"}),", ",(0,i.jsx)(s.strong,{children:"201. Principle of Compromise Recording"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-201",children:"Security Pitfalls & Best Practices 201"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"description-10",children:"Description"}),"\n",(0,i.jsxs)(s.p,{children:["No events are emitted in ",(0,i.jsx)(s.code,{children:"BaseStrategy"})," for ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L254-L263",children:(0,i.jsx)(s.code,{children:"afterExit()"})})," function that allows arbitrary calls to be made by the owner and ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L283-L304",children:(0,i.jsx)(s.code,{children:"swapExactTokensForUnderlying()"})})," which allows executors to convert funds."]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-10",children:"Recommendation"}),"\n",(0,i.jsx)(s.p,{children:"Add events for these administrative functions and ensure they are being monitored for misusage."}),"\n",(0,i.jsxs)(s.p,{children:["The other critical functions ",(0,i.jsx)(s.code,{children:"harvest()"}),", ",(0,i.jsx)(s.code,{children:"withdraw()"})," and ",(0,i.jsx)(s.code,{children:"exit()"}),", can only be called by the BentoBox contract which already has separate events for logging after calling these functions."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"6-minorfixed-public-functions-should-be-external",children:[(0,i.jsxs)("a",{id:"min-6",href:"#min-6",children:[(0,i.jsx)("span",{s:1,children:(0,i.jsx)(s.code,{children:"#6 Minor"})}),(0,i.jsx)("span",{s:0,children:(0,i.jsx)(s.code,{children:"FIXED"})})]}),": Public functions should be external"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified by ",(0,i.jsx)(s.a,{href:"https://github.com/crytic/slither/releases/tag/0.8.2",children:"Slither v0.8.2"}),":"]}),"\n",(0,i.jsx)(s.pre,{"data-language":"text","data-theme":"default",children:(0,i.jsxs)(s.code,{"data-language":"text","data-theme":"default",children:[(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"afterExit(address,uint256,bytes) should be declared external:"})}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        - BaseStrategy.afterExit(address,uint256,bytes) (contracts/BaseStrategy.sol#254-263)"})}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"swapExactTokensForUnderlying(uint256,uint256) should be declared external:"})}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        - BaseStrategy.swapExactTokensForUnderlying(uint256,uint256) (contracts/BaseStrategy.sol#283-304)"})}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#public-function-that-could-be-declared-external"})})]})}),"\n",(0,i.jsxs)(s.p,{children:["The corresponding checklist item is ",(0,i.jsx)(s.strong,{children:"72. Uncalled public functions"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-101",children:"Security Pitfalls & Best Practices 101"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"description-11",children:"Description"}),"\n",(0,i.jsxs)(s.p,{children:["Visibility of BaseStrategy's ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L283-L304",children:(0,i.jsx)(s.code,{children:"swapExactTokensForUnderlying()"})})," and ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L254-L263",children:(0,i.jsx)(s.code,{children:"afterExit()"})})," can be changed from ",(0,i.jsx)(s.code,{children:"public"})," to ",(0,i.jsx)(s.code,{children:"external"})," since they are not called internally and it's also unlikely that inheriting contracts will attempt calling them due to their modifiers."]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-11",children:"Recommendation"}),"\n",(0,i.jsx)(s.p,{children:"Consider changing the visibility of mentioned functions or document why a public visibility was chosen."}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"7-minorfixed-redundant-check-can-be-removed",children:[(0,i.jsxs)("a",{id:"min-7",href:"#min-7",children:[(0,i.jsx)("span",{s:1,children:(0,i.jsx)(s.code,{children:"#7 Minor"})}),(0,i.jsx)("span",{s:0,children:(0,i.jsx)(s.code,{children:"FIXED"})})]}),": Redundant check can be removed"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified during manual review. The corresponding checklist item is ",(0,i.jsx)(s.strong,{children:"157. Redundant constructs"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-201",children:"Security Pitfalls & Best Practices 201"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"description-12",children:"Description"}),"\n",(0,i.jsxs)(s.p,{children:["The ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L274-L278",children:(0,i.jsx)(s.code,{children:"BaseStrategy.disallowPath()"})})," checks whether the ",(0,i.jsx)(s.code,{children:"pathIndex"}),"\nis within the bounds of the ",(0,i.jsx)(s.code,{children:"_allowedSwapPaths"})," array before setting a zero-value. This check is already done by Solidity and therefore unnecessarily increasing gas cost."]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L274-L278",children:(0,i.jsx)(s.strong,{children:"contracts/BaseStrategy.sol#L274-L278"})})}),"\n",(0,i.jsx)(s.pre,{"data-language":"solidity","data-theme":"default",children:(0,i.jsxs)(s.code,{"data-language":"solidity","data-theme":"default",children:[(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"disallowPath"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"uint256"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" pathIndex) "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"external"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"onlyOwner"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"require"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(pathIndex "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" _allowedSwapPaths.length"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Out of bounds"'}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    _allowedSwapPaths[pathIndex] "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"[]("}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"emit"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"LogSetAllowedPath"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(pathIndex"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"false"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,i.jsxs)(s.p,{children:["Solidity 0.8.x does also not yield an INVALID opcode when accessing an array out of its bounds, consuming all available gas, as older versions did. It will instead REVERT, the same way that a ",(0,i.jsx)(s.code,{children:"require()"})," would."]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-12",children:"Recommendation"}),"\n",(0,i.jsx)(s.p,{children:"Remove the redundant require statement."}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"8-minor-making-afterexit-payable",children:[(0,i.jsx)("a",{id:"min-8",href:"#min-8",children:(0,i.jsx)("span",{s:1,children:(0,i.jsx)(s.code,{children:"#8 Minor"})})}),": Making ",(0,i.jsx)(s.code,{children:"afterExit()"})," payable"]}),"\n",(0,i.jsx)(s.p,{children:"Identified during manual review. This is a subjective suggestion with no reference to any best practice."}),"\n",(0,i.jsx)(s.h4,{id:"description-13",children:"Description"}),"\n",(0,i.jsxs)(s.p,{children:["The ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L254-L263",children:(0,i.jsx)(s.code,{children:"BaseStrategy.afterExit()"})})," function allows making arbitrary calls for the purpose of rescuing funds, allows sending a value too. There are currently only two ways how any ether funds can be sent to a strategy: As the beneficiary (coinbase) of the block reward or via ",(0,i.jsx)(s.code,{children:"selfdestruct()"})," of another contract."]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L254-L263",children:(0,i.jsx)(s.strong,{children:"contracts/BaseStrategy.sol#L254-L263"})})}),"\n",(0,i.jsx)(s.pre,{"data-language":"solidity","data-theme":"default",children:(0,i.jsxs)(s.code,{"data-language":"solidity","data-theme":"default",children:[(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"afterExit"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" to"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"uint256"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" value"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"bytes"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"memory"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" data"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"onlyOwner"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"returns"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ("}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"bool"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" success) {"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ("}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"!"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"exited) {"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"revert"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"StrategyNotExited"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    (success"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ) "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" to.call{value"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" value}(data);"})]}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,i.jsx)(s.p,{children:"Aside from rescuing locked ether funds from a Strategy contract, there might be a case where ether value needs to be sent for a call to be made. Then one of the above-mentioned workarounds would be necessary to inject the required balance."}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-13",children:"Recommendation"}),"\n",(0,i.jsxs)(s.p,{children:["Consider making the ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L254-L263",children:(0,i.jsx)(s.code,{children:"BaseStrategy.afterExit()"})})," function ",(0,i.jsx)(s.code,{children:"payable"}),". Additionally, to increasing flexibility, it also reduces gas usage since Solidity's 0-value-check is skipped."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"9-minorfixed-incorrect-usage-of-unlocked-pragma",children:[(0,i.jsxs)("a",{id:"min-9",href:"#min-9",children:[(0,i.jsx)("span",{s:1,children:(0,i.jsx)(s.code,{children:"#9 Minor"})}),(0,i.jsx)("span",{s:0,children:(0,i.jsx)(s.code,{children:"FIXED"})})]}),": Incorrect usage of Unlocked Pragma"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified during manual review. This suggestion is related to checklist items ",(0,i.jsx)(s.strong,{children:"2. Unlocked pragma"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-101",children:"Security Pitfalls & Best Practices 101"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"description-14",children:"Description"}),"\n",(0,i.jsxs)(s.p,{children:["The file ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/BaseStrategy.sol#L3",children:(0,i.jsx)(s.code,{children:"BaseStrategy.sol"})})," makes use of an unlocked pragma (",(0,i.jsx)(s.code,{children:"pragma solidity >=0.8;"}),"). While the intention might have been to regard this abstract contract like a library, leaving it up to the actual Strategy implementations to choose a specific version, in practice that won't be possible since the dependencies included (",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/interfaces/IStrategy.sol#L3",children:"IStrategy"}),", ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/interfaces/IUniswapV2Pair.sol#L3",children:"IUniswapV2Pair"}),", ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/interfaces/IBentoBoxMinimal.sol#L3",children:"IBentoBoxMinimal"}),", and ",(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/libraries/UniswapV2Library.sol#L3",children:"UniswapV2Library"}),") all have a locked pragma, forcing implementations to use that specific version."]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-14",children:"Recommendation"}),"\n",(0,i.jsx)(s.p,{children:"Either purposely use an unlocked pragma for BaseStrategy and its dependencies, to allow Strategy implementations to choose their specific version (and documenting that intention), or use the same locked pragma throughout all contracts."}),"\n",(0,i.jsxs)(s.p,{children:["It might also be a good idea to explicitly mention the practice of specifying a locked pragma for implementations within ",(0,i.jsx)(s.code,{children:"ExampleImplementation.sol"})," as an inline code comment."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"10-minor-avoid-variable-shadowing",children:[(0,i.jsx)("a",{id:"min-10",href:"#min-10",children:(0,i.jsx)("span",{s:1,children:(0,i.jsx)(s.code,{children:"#10 Minor"})})}),": Avoid variable shadowing"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified by ",(0,i.jsx)(s.a,{href:"https://github.com/crytic/slither/releases/tag/0.8.2",children:"Slither v0.8.2"}),":"]}),"\n",(0,i.jsx)(s.pre,{"data-language":"text","data-theme":"default",children:(0,i.jsxs)(s.code,{"data-language":"text","data-theme":"default",children:[(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"AaveStrategyMainnet.constructor(IStkAave,ILendingPool,IAaveIncentivesController,BaseStrategy.ConstructorParams).aaveLendingPool (contracts/strategies/AaveStrategyMainnet.sol#24) shadows:"})}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        - AaveStrategy.aaveLendingPool (contracts/strategies/AaveStrategy.sol#58) (state variable)"})}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"AaveStrategyMainnet.constructor(IStkAave,ILendingPool,IAaveIncentivesController,BaseStrategy.ConstructorParams).incentiveController (contracts/strategies/AaveStrategyMainnet.sol#25) shadows:"})}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        - AaveStrategy.incentiveController (contracts/strategies/AaveStrategy.sol#59) (state variable)"})}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#local-variable-shadowing"})})]})}),"\n",(0,i.jsxs)(s.p,{children:["This issue is related to the checklist items ",(0,i.jsx)(s.strong,{children:"39. Dangerous shadowing"})," and ",(0,i.jsx)(s.strong,{children:"40. Dangerous state variable shadowing"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-101",children:"Security Pitfalls & Best Practices 101"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"description-15",children:"Description"}),"\n",(0,i.jsxs)(s.p,{children:["The state variables ",(0,i.jsx)(s.code,{children:"aaveLendingPool"})," and ",(0,i.jsx)(s.code,{children:"incentiveController"})," of ",(0,i.jsx)(s.code,{children:"AaveStrategy"})," are shadowed within the constructor of ",(0,i.jsx)(s.code,{children:"AaveStrategyMainnet"}),"."]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/strategies/AaveStrategy.sol#L54-L60",children:(0,i.jsx)(s.strong,{children:"contracts/strategies/AaveStrategy.sol#L54-L60"})})}),"\n",(0,i.jsx)(s.pre,{"data-language":"solidity","data-theme":"default",children:(0,i.jsxs)(s.code,{"data-language":"solidity","data-theme":"default",children:[(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"contract"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"AaveStrategy"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"is"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"BaseStrategy"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,i.jsx)(s.span,{className:"line",children:" "}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"using"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"SafeERC20"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"for"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"IERC20"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,i.jsx)(s.span,{className:"line",children:" "}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    ILendingPool "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"internal"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"immutable"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" aaveLendingPool;"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    IAaveIncentivesController "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"internal"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"immutable"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" incentiveController;"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    IERC20 "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"immutable"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" aToken;"})]})]})}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/strategies/AaveStrategyMainnet.sol#L22-L31",children:(0,i.jsx)(s.strong,{children:"contracts/strategies/AaveStrategyMainnet.sol#L22-L31"})})}),"\n",(0,i.jsx)(s.pre,{"data-language":"solidity","data-theme":"default",children:(0,i.jsxs)(s.code,{"data-language":"solidity","data-theme":"default",children:[(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"constructor"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"IStkAave"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-parameter)"},children:"_stkAave"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"ILendingPool"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" aaveLendingPool"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"IAaveIncentivesController"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" incentiveController"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"BaseStrategy"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"."}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"ConstructorParams"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"memory"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" params"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"AaveStrategy"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(aaveLendingPool, incentiveController, params) {"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    stkAave "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" _stkAave;"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    COOLDOWN_SECONDS "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" _stkAave."}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"COOLDOWN_SECONDS"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,i.jsxs)(s.span,{className:"line",children:[(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    UNSTAKE_WINDOW "}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" _stkAave."}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"UNSTAKE_WINDOW"}),(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-15",children:"Recommendation"}),"\n",(0,i.jsxs)(s.p,{children:["Avoid shadowing of variables whether local or state. Instead prefix or suffix said variables with ",(0,i.jsx)(s.code,{children:"_"}),"."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h3,{id:"11-minorfixed-use-safeerc20-in-exampleimplementation",children:[(0,i.jsxs)("a",{id:"min-11",href:"#min-11",children:[(0,i.jsx)("span",{s:1,children:(0,i.jsx)(s.code,{children:"#11 Minor"})}),(0,i.jsx)("span",{s:0,children:(0,i.jsx)(s.code,{children:"FIXED"})})]}),": Use SafeERC20 in ExampleImplementation"]}),"\n",(0,i.jsxs)(s.p,{children:["Identified with the help of ",(0,i.jsx)(s.a,{href:"https://github.com/crytic/slither/releases/tag/0.8.2",children:"Slither v0.8.2"}),":"]}),"\n",(0,i.jsx)(s.pre,{"data-language":"text","data-theme":"default",children:(0,i.jsx)(s.code,{"data-language":"text","data-theme":"default",children:(0,i.jsx)(s.span,{className:"line",children:(0,i.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"ExampleImplementation.constructor(address,BaseStrategy.ConstructorParams) (contracts/ExampleImplementation.sol#15-20) ignores return value by baseStrategyParams.strategyToken.approve(investmentContract,type()(uint256).max) (contracts/ExampleImplementation.sol#19)"})})})}),"\n",(0,i.jsxs)(s.p,{children:["Related to the checklist items ",(0,i.jsx)(s.strong,{children:"142. Function return values"})," of ",(0,i.jsx)(s.a,{href:"https://secureum.substack.com/p/security-pitfalls-and-best-practices-201",children:"Security Pitfalls & Best Practices 201"}),"."]}),"\n",(0,i.jsx)(s.h4,{id:"recommendation-16",children:"Recommendation"}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsxs)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies/blob/be407e27cd1a9ca8060ef9a389d1cf01b4e5540e/contracts/ExampleImplementation.sol#L19",children:[(0,i.jsx)(s.code,{children:"ExampleImplementation"})," constructor"]})," should use ",(0,i.jsx)(s.code,{children:"SafeERC20.safeApprove()"})," to promote correct usage of approval calls for Strategy developers. It currently uses the normal ERC20 ",(0,i.jsx)(s.code,{children:"approve()"})," function and doesn't check its return value."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"missed-findings",children:"Missed Findings"}),"\n",(0,i.jsx)(s.p,{children:"The following is a list of findings that were additionally found by other participants of the Sushi CARE process (based on Report Draft from 08.01.2022):"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Preferring less risky two-step instead of single-step change of contract ownership"}),"\n",(0,i.jsx)(s.li,{children:"Typographical errors in code comments, inaccurate comments, missing NatSpec comments"}),"\n",(0,i.jsx)(s.li,{children:"Return values of various function calls are ignored"}),"\n",(0,i.jsx)(s.li,{children:"Public variable visitbility can be made private to prevent deriving contracts from accidental modification"}),"\n",(0,i.jsxs)(s.li,{children:["Downcasting (from ",(0,i.jsx)(s.code,{children:"uint256"})," to ",(0,i.jsx)(s.code,{children:"int256"}),") is not checked for potential overflow scenarios"]}),"\n",(0,i.jsx)(s.li,{children:"Checks-Effects-Interactions (CEI) pattern is not followed"}),"\n",(0,i.jsx)(s.li,{children:"Missing sanity/threshold checks for various inputs"}),"\n",(0,i.jsx)(s.li,{children:"Implicit check for disabled swap paths could be confusing"}),"\n",(0,i.jsx)(s.li,{children:"Code readability could be improved"}),"\n",(0,i.jsx)(s.li,{children:"Account existence check for low-level calls"}),"\n",(0,i.jsx)(s.li,{children:"Changing critical parameters should be time-delayed"}),"\n",(0,i.jsx)(s.li,{children:"Avoid usage of named returns or use them consistently"}),"\n",(0,i.jsx)(s.li,{children:"Missing new != old checks in setter functions"}),"\n",(0,i.jsx)(s.li,{children:"Prefer custom errors, instead of messages to save gas"}),"\n",(0,i.jsxs)(s.li,{children:["Use OpenZeppelin's Address library for ",(0,i.jsx)(s.code,{children:"afterExit"})," function"]}),"\n",(0,i.jsxs)(s.li,{children:["Incorrect operator (",(0,i.jsx)(s.code,{children:">="}),") causing breakeven to be reported as profit"]}),"\n",(0,i.jsx)(s.li,{children:"Put vendor (eg. IAaveIncentivesController) interfaces into separate files"}),"\n"]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"disclosure",children:"Disclosure"}),"\n",(0,i.jsx)(s.p,{children:"This Report was created as part of the Secureum Smart Contract Auditor Bootcamp Epoch 0 without compensation. Publication was held back until the Sushi Team had reviewed the findings and enough time to make corrections."}),"\n",(0,i.jsx)(s.p,{children:"The Report is not an endorsement of the Sushi project, its ecosystem or products, and does not guarantee its safety. The purpose of this Report is to help the Sushi Team improve the security and best practices of the BentoBox Strategy contracts before an actual Audit is undertaken, allowing those Auditors to focus on critical issues."}),"\n",(0,i.jsx)(s.h2,{id:"resources",children:"Resources"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://sushi.com/",children:"sushi.com"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://github.com/sushiswap",children:"github.com/sushiswap"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://docs.sushi.com/",children:"docs.sushi.com"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://dev.sushi.com/",children:"dev.sushi.com"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://app.sushi.com/bentobox",children:"app.sushi.com/bentobox"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox",children:"github.com/sushiswap/bentobox"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://github.com/sushiswap/bentobox-strategies",children:"github.com/sushiswap/bentobox-strategies"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://medium.com/sushiswap-org/sushi-third-course-2021-q3-update-254b8c408de0",children:"Sushi Third Course — 2021 Q3 Update"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://medium.com/sushiswap-org/introducing-the-sushi-next-generation-amm-trident-7dea6aa3cbc2",children:"Introducing, The Sushi Next Generation AMM: Trident"})}),"\n"]}),"\n",(0,i.jsx)(s.hr,{}),"\n","\n",(0,i.jsxs)(r.oy,{children:[(0,i.jsx)(r.Zb,{icon:(0,i.jsx)(o.H8,{}),title:"← Secureum Bootcamp Epoch∞ - February RACE #4",href:"/posts/2022/2/9/secureum-bootcamp-february-race-4/"}),(0,i.jsx)(r.Zb,{icon:(0,i.jsx)(o.H8,{}),title:"Secureum Bootcamp Epoch∞ - February RACE #5 →",href:"/posts/2022/3/8/secureum-bootcamp-epoch-march-race-5"})]})]})}s.default=(0,n.j)({MDXContent:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:s}=Object.assign({},(0,a.a)(),e.components);return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(_createMdxContent,{...e})}):_createMdxContent(e)},pageOpts:{filePath:"pages/posts/2022/2/10/secureum-bootcamp-care-audit-sushi-bentobox-strategies.mdx",route:"/posts/2022/2/10/secureum-bootcamp-care-audit-sushi-bentobox-strategies",timestamp:1731290394e3,title:"Secureum Bootcamp CARE: Sushi's BentoBox Strategies",headings:c},pageNextRoute:"/posts/2022/2/10/secureum-bootcamp-care-audit-sushi-bentobox-strategies"})}},function(e){e.O(0,[3220,1589,9774,2888,179],function(){return e(e.s=24115)}),_N_E=e.O()}]);