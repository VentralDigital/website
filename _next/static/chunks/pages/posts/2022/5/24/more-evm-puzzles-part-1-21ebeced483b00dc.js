(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9053],{16508:function(e,s,l){(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/2022/5/24/more-evm-puzzles-part-1",function(){return l(24109)}])},24109:function(e,s,l){"use strict";l.r(s),l.d(s,{__toc:function(){return r}});var n=l(35250),t=l(47147),a=l(77298),i=l(18363),o=l(13423);let r=[{depth:2,value:"Puzzle #1",id:"puzzle-1"},{depth:2,value:"Puzzle #2",id:"puzzle-2"}];function _createMdxContent(e){let s=Object.assign({h1:"h1",a:"a",p:"p",h2:"h2",pre:"pre",code:"code",span:"span",em:"em",hr:"hr"},(0,a.a)(),e.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.h1,{children:"More EVM Puzzles - Part 1"}),"\n",(0,n.jsxs)("p",{className:"text-xs text-right",children:["May 24, 2022 by ",(0,n.jsx)(s.a,{href:"/about#patrickd",children:"patrickd"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.a,{href:"https://twitter.com/DaltonSweeney9",children:"Dalton Sweeney"})," has recently published his own collection of EVM puzzles: ",(0,n.jsx)(s.a,{href:"https://github.com/daltyboy11/more-evm-puzzles",children:'"10 more EVM puzzles"'}),"! Promising to be even more challenging than the ones of ",(0,n.jsx)(s.a,{href:"https://twitter.com/fvictorio_nan",children:"Franco Victorio"}),"'s original ",(0,n.jsx)(s.a,{href:"https://github.com/fvictorio/evm-puzzles",children:"collection"}),". Since we've solved all the other one's on this blog already and they've been good fun, let's do these too!"]}),"\n",(0,n.jsxs)(s.p,{children:["Note that it's probably best to read my ",(0,n.jsx)(s.a,{href:"/posts/2022/3/12/evm-puzzles-second-wind",children:"previous blog posts"})," first, or that you've already solved the original version yourself, since I'll not explain all of the opcodes that were already discussed there in detail again."]}),"\n",(0,n.jsx)(s.h2,{id:"puzzle-1",children:"Puzzle #1"}),"\n",(0,n.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"plaintext","data-theme":"default",children:[(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"00      36      CALLDATASIZE"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"01      34      CALLVALUE"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"02      0A      EXP"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"03      56      JUMP"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"04      FE      INVALID"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"05      FE      INVALID"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"06      FE      INVALID"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"... (all INVALID opcodes) ..."})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"3D      FE      INVALID"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"3E      FE      INVALID"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"3F      FE      INVALID"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"40      5B      JUMPDEST"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"41      58      PC"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"42      36      CALLDATASIZE"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"43      01      ADD"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"44      56      JUMP"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"45      FE      INVALID"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"46      FE      INVALID"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"47      5B      JUMPDEST"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"48      00      STOP"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"? Enter the value to send:"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"? Enter the calldata:"})})]})}),"\n",(0,n.jsxs)(s.p,{children:["The first puzzle is already quite complex, but as usual, we know that the goal is to ensure that the transaction doesn't revert, meaning it needs to reach the ",(0,n.jsx)(s.code,{children:"STOP"})," opcode. And since there are each two ",(0,n.jsx)(s.code,{children:"JUMP"})," and ",(0,n.jsx)(s.code,{children:"JUMPDEST"})," opcodes, we most likely need to make sure to send a transaction that will ensure that both destinations are successfully jumped to."]}),"\n",(0,n.jsxs)(s.p,{children:["A ",(0,n.jsx)(s.code,{children:"JUMP"})," consumes one item from the stack: The offset it should jump to, at which location needs to be a ",(0,n.jsx)(s.code,{children:"JUMPDEST"})," opcode."]}),"\n",(0,n.jsxs)(s.p,{children:["The first 4 lines can be rewritten to the following pseudocode: ",(0,n.jsx)(s.code,{children:"jumpTo(CALLVALUE ** CALLDATASIZE)"})," - and first thing to wonder about is: Can we jump directly to the last ",(0,n.jsx)(s.code,{children:"JUMPDEST"})," skipping half of the challenge? Well, its offset is at ",(0,n.jsx)(s.code,{children:"0x47"})," which is 71 in decimal, so sending a wei value of 71 and 1 byte as calldata should work? (because 71**1=71)"]}),"\n",(0,n.jsx)(s.pre,{"data-language":"text","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"text","data-theme":"default",children:[(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"? Enter the value to send: 71"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"? Enter the calldata: 0x01"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"Puzzle solved!"})})]})}),"\n",(0,n.jsxs)(s.p,{children:["Indeed! That worked, but it's kind of cheating so let's take a look at how this was probably intended to be solved and first jump to the ",(0,n.jsx)(s.code,{children:"JUMPDEST"})," at ",(0,n.jsx)(s.code,{children:"0x40"})," which is 64 - that means we can actually send any power of 2 that results in 64: 2*",(0,n.jsx)(s.em,{children:"6, 4*"}),"3, 8**2"]}),"\n",(0,n.jsxs)(s.p,{children:["After jumping there, the Program Counter's current value is pushed on the stack with the ",(0,n.jsx)(s.code,{children:"PC"})," opcode. The handy ",(0,n.jsx)(s.a,{href:"https://www.evm.codes/",children:"evm.codes"})," website tells us that this is \"the value of the program counter prior to the increment corresponding to this instruction\". So the Program Counter is basically a simple integer offset within the EVM that always keeps increasing by 1 while working through the contract's bytecode, except when it hits some kind of jump that overwrites the offset to point to a different location. We'll get the ",(0,n.jsx)(s.code,{children:"PC"})," opcodes own address here, which is ",(0,n.jsx)(s.code,{children:"0x41"}),"."]}),"\n",(0,n.jsxs)(s.p,{children:["This is then added to ",(0,n.jsx)(s.code,{children:"CALLDATASIZE"})," and this sum becomes the offset the following ",(0,n.jsx)(s.code,{children:"JUMP"})," will take us to. So to get to the final ",(0,n.jsx)(s.code,{children:"JUMPDEST"})," at ",(0,n.jsx)(s.code,{children:"0x47"})," we need to add 6 to the ",(0,n.jsx)(s.code,{children:"PC"})," opcode's location at ",(0,n.jsx)(s.code,{children:"0x41"}),". That means we need a ",(0,n.jsx)(s.code,{children:"CALLDATASIZE"})," of 6 and we already know that we can send 2**6 to keep the first jump working."]}),"\n",(0,n.jsx)(s.pre,{"data-language":"text","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"text","data-theme":"default",children:[(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"? Enter the value to send: 2"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"? Enter the calldata: 0x010203040506"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"Puzzle solved!"})})]})}),"\n",(0,n.jsx)(s.p,{children:"It appears we have now found the intended solution!"}),"\n",(0,n.jsx)(s.h2,{id:"puzzle-2",children:"Puzzle #2"}),"\n",(0,n.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"plaintext","data-theme":"default",children:[(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"00      36        CALLDATASIZE"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"01      6000      PUSH1 00"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"03      6000      PUSH1 00"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"05      37        CALLDATACOPY"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"06      36        CALLDATASIZE"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"07      6000      PUSH1 00"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"09      6000      PUSH1 00"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"0B      F0        CREATE"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"0C      6000      PUSH1 00"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"0E      80        DUP1"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"0F      80        DUP1"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"10      80        DUP1"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"11      80        DUP1"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"12      94        SWAP5"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"13      5A        GAS"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"14      F1        CALL"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"15      3D        RETURNDATASIZE"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"16      600A      PUSH1 0A"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"18      14        EQ"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"19      601F      PUSH1 1F"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"1B      57        JUMPI"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"1C      FE        INVALID"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"1D      FE        INVALID"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"1E      FE        INVALID"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"1F      5B        JUMPDEST"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"20      00        STOP"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"? Enter the calldata:"})})]})}),"\n",(0,n.jsxs)(s.p,{children:["The ",(0,n.jsx)(s.code,{children:"CREATE"})," opcode, previously reserved for the most challenging puzzles, is back and that already in the second one! This makes the puzzle a whole lot more intimidating, but the goal hasn't changed: Make a jump to the one and final ",(0,n.jsx)(s.code,{children:"JUMPDEST"})," at offset ",(0,n.jsx)(s.code,{children:"0x1F"}),"."]}),"\n",(0,n.jsxs)(s.p,{children:["This offset is already pushed onto the stack as target before the ",(0,n.jsx)(s.code,{children:"JUMPI"}),", so what we have to do is making sure that the jump condition is met and the second item on the stack is a non-zero value. For that to be the case ",(0,n.jsx)(s.code,{children:"RETURNDATASIZE"})," needs to be equal to ",(0,n.jsx)(s.code,{children:"0x0A"}),". That means the size of the output data resulting from the previous ",(0,n.jsx)(s.code,{children:"CALL"})," opcode should be 10 bytes long."]}),"\n",(0,n.jsxs)(s.p,{children:["To understand what's happening with the ",(0,n.jsx)(s.code,{children:"CREATE"})," and ",(0,n.jsx)(s.code,{children:"CALL"})," opcodes, it's best to look at how the stack builds up and what each item will end up being used for:"]}),"\n",(0,n.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"plaintext","data-theme":"default",children:[(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"00      36        CALLDATASIZE   [CALLDATASIZE]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"01      6000      PUSH1 00       [0x0, CALLDATASIZE]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"03      6000      PUSH1 00       [0x0, 0x0, CALLDATASIZE]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"05      37        CALLDATACOPY   []"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"06      36        CALLDATASIZE   [CALLDATASIZE]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"07      6000      PUSH1 00       [0x0, CALLDATASIZE]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"09      6000      PUSH1 00       [0x0, 0x0, CALLDATASIZE]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"0B      F0        CREATE         [ADDRESS]"})})]})}),"\n",(0,n.jsxs)(s.p,{children:["First of all ",(0,n.jsx)(s.code,{children:"CALLDATACOPY"})," copies calldata to memory at offset ",(0,n.jsx)(s.code,{children:"0x0"})," from the calldata starting at offset ",(0,n.jsx)(s.code,{children:"0x0"}),". The size of this copy operation is ",(0,n.jsx)(s.code,{children:"CALLDATASIZE"}),", meaning the entirety of the calldata we send is copied to memory."]}),"\n",(0,n.jsxs)(s.p,{children:["After that, ",(0,n.jsx)(s.code,{children:"CREATE"})," is executed with an ether value of zero (",(0,n.jsx)(s.code,{children:"0x0"}),") to send to the new contract, and to use the entirety of the calldata that we have just copied to memory at offset ",(0,n.jsx)(s.code,{children:"0x0"})," as construction bytecode."]}),"\n",(0,n.jsx)(s.p,{children:"So whatever we send as calldata will be executed as construction bytecode. And whatever the result of that is will be deployed as a smart contract. And finally we'll have the address of it as the top item on our stack."}),"\n",(0,n.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"plaintext","data-theme":"default",children:[(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"0C      6000      PUSH1 00       [0x0, ADDRESS]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"0E      80        DUP1           [0x0, 0x0, ADDRESS]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"0F      80        DUP1           [0x0, 0x0, 0x0, ADDRESS]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"10      80        DUP1           [0x0, 0x0, 0x0, 0x0, ADDRESS]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"11      80        DUP1           [0x0, 0x0, 0x0, 0x0, 0x0, ADDRESS]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"12      94        SWAP5          [ADDRESS, 0x0, 0x0, 0x0, 0x0, 0x0]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"13      5A        GAS            [GAS, ADDRESS, 0x0, 0x0, 0x0, 0x0, 0x0]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"14      F1        CALL           [SUCCESS]"})})]})}),"\n",(0,n.jsxs)(s.p,{children:["This contract is then called with all of the gas that is still available at this point. All of the zeros the stack was filled with, tell ",(0,n.jsx)(s.code,{children:"CALL"})," that there are no arguments to copy from memory (as new calldata for the call to the new contract) and that none of the return data should be copied to memory either. And finally, we'll have either 1 or 0 on the stack, telling us whether the call succeeded."]}),"\n",(0,n.jsxs)(s.p,{children:["But this success value isn't actually used. Instead, it gets the size of the data that was returned by the previous call with ",(0,n.jsx)(s.code,{children:"RETURNDATASIZE"})," (data which is buffered somewhere for us within the EVM)."]}),"\n",(0,n.jsx)(s.p,{children:"So in summary: We need to send bytecode as calldata, that'll return a contract, that'll return 10 bytes of data when called."}),"\n",(0,n.jsx)(s.p,{children:"First: We need to build a runtime bytecode that returns 10 bytes."}),"\n",(0,n.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"plaintext","data-theme":"default",children:[(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"00      600A      PUSH1 0A        [0x0A]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"02      6000      PUSH1 00        [0x00, 0x0A] (offset, size)"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"04      F3        RETURN          []"})})]})}),"\n",(0,n.jsx)(s.p,{children:"We don't actually have to write anything to memory first in order to return it. Since the memory is already zero-initialized we can just return 10 zeros from it."}),"\n",(0,n.jsxs)(s.p,{children:["Runtime bytecode: ",(0,n.jsx)(s.code,{children:"0x600A6000F3"})]}),"\n",(0,n.jsx)(s.p,{children:"Second: We need to build a construction bytecode that returns our runtime bytecode."}),"\n",(0,n.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"plaintext","data-theme":"default",children:[(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"00      64600A6000F3      PUSH5 600A6000F3        [0x600A6000F3]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"06      6000              PUSH1 00                [0x0, 0x600A6000F3] (offset, value)"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"08      52                MSTORE                  []"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"00      600A              PUSH1 0A                [0x0A]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"02      601B              PUSH1 1B                [0x1B, 0x0A] (offset, size)"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"04      F3                RETURN                  []"})})]})}),"\n",(0,n.jsxs)(s.p,{children:["Here we're writing the bytecode to memory and then we return it. You might wonder why the starting offset of the return data begins at ",(0,n.jsx)(s.code,{children:"0x1B"})," although we stored the runtime bytecode at ",(0,n.jsx)(s.code,{children:"0x0"})," - that's because it'll look like this is memory: ",(0,n.jsx)(s.code,{children:"0x000000000000000000000000000000000000000000000000000000600A6000F3"}),"."]}),"\n",(0,n.jsxs)(s.p,{children:["We have to skip the 27 zeros that are at the beginning of the value to reach the bytecode. We could have prevented that using ",(0,n.jsx)(s.code,{children:"PUSH32 0x600A6000F3000000000000000000000000000000000000000000000000000000"}),", but that'd have significantly increased the construction bytecode's size."]}),"\n",(0,n.jsxs)(s.p,{children:["Construction bytecode: ",(0,n.jsx)(s.code,{children:"0x64600A6000F3600052600A601BF3"})]}),"\n",(0,n.jsx)(s.pre,{"data-language":"text","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"text","data-theme":"default",children:[(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"? Enter the calldata: 0x64600A6000F3600052600A601BF3"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"Puzzle solved!"})})]})}),"\n",(0,n.jsx)(s.p,{children:"But that was somewhat boring, right? Wouldn't it be more fun if we only had one bytecode.. bytecode that returns itself and can be used for both construction and runtime.. and is 10 bytes long?"}),"\n",(0,n.jsxs)(s.p,{children:["We can actually do that quite easily because with the ",(0,n.jsx)(s.code,{children:"CODECOPY"})," opcode the bytecode can copy itself:"]}),"\n",(0,n.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"plaintext","data-theme":"default",children:[(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"00      600A      PUSH1 0A        [0x0A]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"02      6000      PUSH1 00        [0x00, 0x0A]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"04      6000      PUSH1 00        [0x00, 0x00, 0x0A] (destOffset, offset, size)"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"06      39        CODECOPY        []"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"07      600A      PUSH1 0A        [0x0A]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"09      6000      PUSH1 00        [0x00, 0x0A] (offset, size)"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"0B      F3        RETURN          []"})})]})}),"\n",(0,n.jsx)(s.p,{children:"This is 12 bytes long though, so we have to do some optimizations. A simple one is using duplication opcodes instead of pushing duplicate items onto the stack:"}),"\n",(0,n.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"plaintext","data-theme":"default",children:[(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"00      600A      PUSH1 0A        [0x0A]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"02      80        DUP1            [0x0A, 0x0A]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"03      6000      PUSH1 00        [0x00, 0x0A, 0x0A]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"05      80        DUP1            [0x00, 0x00, 0x0A, 0x0A] (destOffset, offset, size), size"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"06      39        CODECOPY        [0x0A]"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"07      6000      PUSH1 00        [0x00, 0x0A] (offset, size)"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"09      F3        RETURN          []"})})]})}),"\n",(0,n.jsx)(s.p,{children:"The bytecode is now exactly 10 bytes long and able to deploy itself:"}),"\n",(0,n.jsx)(s.pre,{"data-language":"text","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"text","data-theme":"default",children:[(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"? Enter the calldata: 0x600A80600080396000F3"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"Puzzle solved!"})})]})}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsx)(s.p,{children:"This was a lot of stuff and we're only 2 puzzles in, so let's not overdo it and make it a series instead!"}),"\n",(0,n.jsx)(s.hr,{}),"\n","\n",(0,n.jsxs)(i.oy,{children:[(0,n.jsx)(i.Zb,{icon:(0,n.jsx)(o.aA,{}),title:"← EVM Puzzles – Second Wind",href:"/posts/2022/3/12/evm-puzzles-second-wind/"}),(0,n.jsx)(i.Zb,{icon:(0,n.jsx)(o.aA,{}),title:"More EVM Puzzles - Part 2 →",href:"/posts/2022/5/26/more-evm-puzzles-part-2/"})]})]})}s.default=(0,t.j)({MDXContent:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:s}=Object.assign({},(0,a.a)(),e.components);return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(_createMdxContent,{...e})}):_createMdxContent(e)},pageOpts:{filePath:"pages/posts/2022/5/24/more-evm-puzzles-part-1.mdx",route:"/posts/2022/5/24/more-evm-puzzles-part-1",timestamp:1702204664e3,title:"More EVM Puzzles - Part 1",headings:r},pageNextRoute:"/posts/2022/5/24/more-evm-puzzles-part-1"})}},function(e){e.O(0,[3220,1589,9774,2888,179],function(){return e(e.s=16508)}),_N_E=e.O()}]);