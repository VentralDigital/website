(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9430],{29540:function(e,s,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/2022/6/27/ethernaut-26-doubleentrypoint",function(){return t(25165)}])},25165:function(e,s,t){"use strict";t.r(s),t.d(s,{__toc:function(){return i}});var n=t(35250),o=t(47147),r=t(77298),l=t(18363);let i=[{depth:2,value:"Code Review",id:"code-review"},{depth:2,value:"Writing the 'Detection Bot'",id:"writing-the-detection-bot"}];function _createMdxContent(e){let s=Object.assign({h1:"h1",a:"a",p:"p",strong:"strong",hr:"hr",blockquote:"blockquote",code:"code",h2:"h2",pre:"pre",span:"span"},(0,r.a)(),e.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.h1,{children:"Ethernaut: #26 DoubleEntryPoint"}),"\n",(0,n.jsxs)("p",{className:"text-xs text-right",children:["June 27, 2022 by ",(0,n.jsx)(s.a,{href:"/about#patrickd",children:"patrickd"})]}),"\n",(0,n.jsxs)(s.p,{children:["Some time ago Ethernaut got the new ",(0,n.jsx)(s.a,{href:"https://ethernaut.openzeppelin.com/level/0x128BA32Ec698610f2fF8f010A7b74f9985a6D17c",children:(0,n.jsx)(s.strong,{children:"DoubleEntryPoint"})})," level based on a novel compound vulnerability. I've avoided reading anything about it until I finally have to time solve this challenge in an unbiased manner, and today is the day!"]}),"\n","\n",(0,n.jsx)(l.UW,{type:"info",children:(0,n.jsx)(s.p,{children:"Since some have asked: There's no write-up series of Ethernaut on this Blog, I didn't see the point since there were already so many existing ones on the Internet when I solved it"})}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.blockquote,{children:["\n",(0,n.jsxs)(s.p,{children:["This level features a ",(0,n.jsx)(s.code,{children:"CryptoVault"})," with special functionality, the ",(0,n.jsx)(s.code,{children:"sweepToken"})," function. This is a common function to retrieve tokens stuck in a contract. The ",(0,n.jsx)(s.code,{children:"CryptoVault"})," operates with an ",(0,n.jsx)(s.code,{children:"underlying"})," token that can't be swept, being it an important core's logic component of the ",(0,n.jsx)(s.code,{children:"CryptoVault"}),", any other token can be swept."]}),"\n",(0,n.jsxs)(s.p,{children:["The underlying token is an instance of the DET token implemented in ",(0,n.jsx)(s.code,{children:"DoubleEntryPoint"})," contract definition and the ",(0,n.jsx)(s.code,{children:"CryptoVault"})," holds 100 units of it. Additionally the ",(0,n.jsx)(s.code,{children:"CryptoVault"})," also holds 100 of ",(0,n.jsx)(s.code,{children:"LegacyToken LGT"}),"."]}),"\n",(0,n.jsxs)(s.p,{children:["In this level you should figure out where the bug is in ",(0,n.jsx)(s.code,{children:"CryptoVault"})," and protect it from being drained out of tokens."]}),"\n",(0,n.jsxs)(s.p,{children:["The contract features a ",(0,n.jsx)(s.code,{children:"Forta"})," contract where any user can register its own ",(0,n.jsx)(s.code,{children:"detection bot"})," contract. Forta is a decentralized, community-based monitoring network to detect threats and anomalies on DeFi, NFT, governance, bridges and other Web3 systems as quickly as possible. Your job is to implement a ",(0,n.jsx)(s.code,{children:"detection bot"})," and register it in the ",(0,n.jsx)(s.code,{children:"Forta"})," contract. The bot's implementation will need to raise correct alerts to prevent potential attacks or bug exploits."]}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:'Right away I was a little confused, so we\'re not supposed to exploit this to pass the level but write a "detection bot" with Forta? Huh, maybe it\'ll make sense once we understand the bug... From the description alone it sounds like there might be some unintended way to "sweep" the underlying token despite the Vault\'s attempts to prevent that.'}),"\n",(0,n.jsx)(s.h2,{id:"code-review",children:"Code Review"}),"\n",(0,n.jsxs)(s.p,{children:["Looking at the source code, the first thing popping out was the definition of a ",(0,n.jsx)(s.code,{children:"DelegateERC20"}),' interface. Maybe the challenge has something to do with the Vault delegate-calling into a Token whose source code we can control? But then why is there an "original Sender" parameter passed? That wouldn\'t be necessary for a delegate-call since the ',(0,n.jsx)(s.code,{children:"msg.sender"})," would be preserved..."]}),"\n",(0,n.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"interface"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"DelegateERC20"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"delegateTransfer"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(address to"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" uint256 value"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" address origSender) "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"external"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"returns"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" (bool);"})]}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,n.jsx)(s.p,{children:"I've only heard high level explanations about what Forta is and does so far and had assumed, like it sounds in the description too, that it was an off-chain monitoring network - so seeing detection bots apparently being executed on-chain here is rather confusing to me. Maybe it's just for demonstrative purposes in this challenge? Let's skip over it for now."}),"\n",(0,n.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"interface"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"IDetectionBot"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"handleTransaction"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(address user"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" bytes calldata msgData) "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"external"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:" "}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"interface"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"IForta"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"setDetectionBot"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(address detectionBotAddress) "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"external"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"notify"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(address user"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" bytes calldata msgData) "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"external"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"raiseAlert"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(address user) "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"external"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:" "}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"contract Forta is IForta { "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"..."}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" }"})]})]})}),"\n",(0,n.jsxs)(s.p,{children:["Then we find the ",(0,n.jsx)(s.code,{children:"CryptoVault"})," contract with that ",(0,n.jsx)(s.code,{children:"sweepToken"})," function this challenge seems to be centered around:"]}),"\n",(0,n.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"sweepToken"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(IERC20 token) "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"public"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"require"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(token "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"!="}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" underlying"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Can\'t transfer underlying token"'}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"token"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".transfer"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(sweptTokensRecipient"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"token"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".balanceOf"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"address"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:")));"})]}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,n.jsxs)(s.p,{children:["It's clear that this will simply transfer out the full balance of any token specified as long as it's not the underlying token. It should also be said that both the ",(0,n.jsx)(s.code,{children:"underlying"})," and ",(0,n.jsx)(s.code,{children:"sweptTokensRecipient"})," appear to be unchangeable once set during construction/initialization of the Vault. But this also means that even if we're able to \"drain\" the Vault of its underlying token, it would just go into a wallet of the Vault creators and not into ours. So, assuming they're not gonna run away with it, that wouldn't mean a loss of funds but at least a disruption of Vault services. Now it makes sense why the goal is to write a monitoring bot here, it's good to be notified when something like this happens!"]}),"\n",(0,n.jsx)(s.p,{children:"But I don't see any issues with this code by itself, so most likely we'll be able to find something weird in the \"Legacy Token\" contract. And indeed:"}),"\n",(0,n.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"delegateToNewContract"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(DelegateERC20 newContract) "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"public"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"onlyOwner"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    delegate "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newContract;"})]}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:" "}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"transfer"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(address to"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" uint256 value) "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"public"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"override"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"returns"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" (bool) {"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ("}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"address"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(delegate) "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=="}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"address"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:")) {"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"super.transfer"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(to"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" value);"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    } "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"else"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"delegate"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".delegateTransfer"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(to"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" value"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"msg"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".sender);"})]}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,n.jsxs)(s.p,{children:["The \"Legacy Token\" appears to be just that, it's a normal ERC20 Token at the beginning and then over the course of its lifetime the owner may decide to have transfers point to a new Token (presumably the underlying DET Token in this case). To do so it's not using anything fancy like a delegate-call as I had expected at first. It's simply calling a privileged ",(0,n.jsx)(s.code,{children:"delegateTransfer()"})," function on the new Token to freely transfer funds (which should make sure that only the Legacy Token can call this)."]}),"\n",(0,n.jsxs)(s.p,{children:['As expected, the Vault\'s underlying "DoubleEntryPointToken" makes sure that ',(0,n.jsx)(s.code,{children:"delegateTransfer()"})," can only be called by the ",(0,n.jsx)(s.code,{children:"legacyToken"})," by using a modifier. There's also a ",(0,n.jsx)(s.code,{children:"fortaNotify"})," middleware that sets the whole detection bot thing in motion and can revert the call if it detects evil function calls."]}),"\n",(0,n.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"constructor"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(address legacyToken"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" address vaultAddress"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" address fortaAddress"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" address playerAddress) public {"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    delegatedFrom "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" legacyToken;"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"..."})]}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:" "}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"..."})}),"\n",(0,n.jsx)(s.span,{className:"line",children:" "}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"delegateTransfer"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    address to"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    uint256 value"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    address origSender"})}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"public"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"override"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"onlyDelegateFrom"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"fortaNotify"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"returns"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" (bool) {"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"_transfer"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(origSender"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" to"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" value);"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"true"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,n.jsx)(s.h2,{id:"writing-the-detection-bot",children:"Writing the 'Detection Bot'"}),"\n",(0,n.jsxs)(s.p,{children:["So in summary: The vulnerability is that it's possible to bypass the ",(0,n.jsx)(s.code,{children:'require(token != underlying, "Can\'t transfer underlying token");'})," check by calling the ",(0,n.jsx)(s.code,{children:"sweepToken()"})," function with the Legacy Token. The legacy token will tell the underlying token to sweep the entire Vault's balance to the ",(0,n.jsx)(s.code,{children:"sweptTokensRecipient"}),", likely causing a disturbance for Vault users."]}),"\n",(0,n.jsxs)(s.p,{children:['Now we need to write a "DetectionBot" contract that reacts to funds being moved out of the Vault. This contract should implement a ',(0,n.jsx)(s.code,{children:"handleTransaction()"})," function which gets passed the Ethernaut player's address and the raw calldata of the ",(0,n.jsx)(s.code,{children:"delegateTransfer()"})," function call."]}),"\n",(0,n.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"interface"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"IDetectionBot"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"handleTransaction"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(address user"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" bytes calldata msgData) "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"external"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,n.jsxs)(s.p,{children:["Using that calldata we can determine if the ",(0,n.jsx)(s.code,{children:"origSender"})," is the address of the CryptoVault contract and if so we can call ",(0,n.jsx)(s.code,{children:"raiseAlert()"})," on Forta with the ",(0,n.jsx)(s.code,{children:"user"})," that was passed to us to make sure the ",(0,n.jsx)(s.code,{children:"delegateTransfer()"})," function call will revert:"]}),"\n",(0,n.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,n.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"contract MyDetectionBot is IDetectionBot {"})}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    address constant "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"VAULT"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"0x1533776a77f494131709c3320220B54810553dce"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"handleTransaction"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(address user"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" bytes calldata msgData) "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"external"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        ("}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:",,"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"address origSender) "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"abi"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".decode"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(msgData["}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"4"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:":]"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" (address"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" uint256"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" address));"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" (origSender "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=="}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"VAULT"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,n.jsxs)(s.span,{className:"line",children:[(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"IForta"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"msg"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".sender)"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".raiseAlert"}),(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(user);"})]}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        }"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,n.jsx)(s.span,{className:"line",children:(0,n.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,n.jsxs)(s.p,{children:["Don't forget that calldata from ",(0,n.jsx)(s.code,{children:"msg.data"})," is prefixed by the 4-byte function signature! Luckily byte arrays located in calldata can be easily sliced in Solidity with brackets: ",(0,n.jsx)(s.code,{children:"[start:length]"}),". In this case we'll skip the first 4 bytes and omit the length, this will default to return the full length. After removing the signature we can use ",(0,n.jsx)(s.code,{children:"abi.decode()"})," on the leftover ABI encoded part of the byte array."]}),"\n",(0,n.jsxs)(s.p,{children:["After deploying this, it has to be registered with the Forta contract by calling ",(0,n.jsx)(s.code,{children:"setDetectionBot()"}),' from the player address\' wallet. Then we click the big "Submit Instance" Button and..']}),"\n",(0,n.jsxs)(s.blockquote,{children:["\n",(0,n.jsx)(s.p,{children:"Congratulations!"}),"\n",(0,n.jsxs)(s.p,{children:["This is the ",(0,n.jsx)(s.strong,{children:"first experience you have with a"})," ",(0,n.jsx)(s.a,{href:"https://docs.forta.network/en/latest/",children:(0,n.jsx)(s.strong,{children:"Forta bot"})}),"."]}),"\n",(0,n.jsx)(s.p,{children:"Forta comprises a decentralized network of independent node operators who scan all transactions and block-by-block state changes for outlier transactions and threats. When an issue is detected, node operators send alerts to subscribers of potential risks, which enables them to take action."}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"The presented example is just for educational purpose since Forta bot is not modeled into smart contracts. In Forta, a bot is a code script to detect specific conditions or events, but when an alert is emitted it does not trigger automatic actions - at least not yet."})," In this level, the bot's alert effectively trigger a revert in the transaction, deviating from the intended Forta's bot design."]}),"\n",(0,n.jsxs)(s.p,{children:["Detection bots heavily depends on contract's final implementations and some might be upgradeable and break bot's integrations, but to mitigate that you can even create a specific bot to look for contract upgrades and react to it. Learn how to do it ",(0,n.jsx)(s.a,{href:"https://docs.forta.network/en/latest/quickstart/",children:"here"}),"."]}),"\n",(0,n.jsxs)(s.p,{children:["You have also passed through a recent security issue that has been uncovered during OpenZeppelin's latest ",(0,n.jsx)(s.a,{href:"https://compound.finance/governance/proposals/76",children:"collaboration with Compound protocol"}),"."]}),"\n",(0,n.jsxs)(s.p,{children:["Having tokens that present a double entry point is a non-trivial pattern that might affect many protocols. This is because it is commonly assumed to have one contract per token. But it was not the case this time :) You can read the entire details of what happened ",(0,n.jsx)(s.a,{href:"https://blog.openzeppelin.com/compound-tusd-integration-issue-retrospective/",children:"here"}),"."]}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"Thankfully this congratulation message clears up my confusion about Forta Bots - they do actually run off-chain and are apparently written in TypeScript, JavaScript or Python. So then, this wasn't a real Forta Bot experience though? And the bug itself wasn't well hidden at all? Wait, was this whole thing just part of Fortas marketing campaign?!"}),"\n",(0,n.jsx)(s.p,{children:"Oh well."})]})}s.default=(0,o.j)({MDXContent:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:s}=Object.assign({},(0,r.a)(),e.components);return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(_createMdxContent,{...e})}):_createMdxContent(e)},pageOpts:{filePath:"pages/posts/2022/6/27/ethernaut-26-doubleentrypoint.mdx",route:"/posts/2022/6/27/ethernaut-26-doubleentrypoint",timestamp:1701640359e3,title:"Ethernaut: #26 DoubleEntryPoint",headings:i},pageNextRoute:"/posts/2022/6/27/ethernaut-26-doubleentrypoint"})},47147:function(e,s,t){"use strict";t.d(s,{j:function(){return setupNextraPage}});var n,o=t(44619),r=t.n(o),l=t(54594),i=t(70079);t(77298);var a=t(35250),c=(0,i.createContext)(!1),h=t(65263);function Nextra({__nextra_pageMap:e,__nextra_dynamic_opts:s,...t}){let{context:n,Layout:o}=function(){let e=globalThis[l.eZ],{route:s}=(0,h.useRouter)();(0,i.useState)({})[1];let t=e.context[s];if(!t)throw Error("No content found for the current route. This is a Nextra bug.");return{context:t,Layout:e.Layout}}(),{Content:r,...d}=n;if(e&&(d.pageOpts={...d.pageOpts,pageMap:e}),s){let{headings:e,title:t,frontMatter:n}=JSON.parse(s);d.pageOpts={...d.pageOpts,headings:e,title:t,frontMatter:n}}return(0,a.jsx)(o,{...d,pageProps:t,children:(0,a.jsx)(c.Provider,{value:t,children:(0,a.jsx)(r,{...t})})})}var d=t(86264),p=t(99199),x=t(20439);function pageTitleFromFilename(e){return x(e.replaceAll(/[-_]/g," "))}function isFolder(e){return!!e&&"object"==typeof e&&"folder"===e.type}function normalizeMetaData(e){return Object.fromEntries(Object.entries(e).map(([e,s])=>{if(isFolder(s)){let t=e.replace("/","");return[t,s.title||pageTitleFromFilename(t)]}return[e,s||pageTitleFromFilename(e)]}))}function setupNextraPage({pageNextRoute:e,pageOpts:s,nextraLayout:t,themeConfig:o,MDXContent:i,hot:a,pageOptsChecksum:c,dynamicMetaModules:h=[]}){var x;"undefined"==typeof window&&(globalThis.__nextra_resolvePageMap=async()=>{if(n)return n;let e=JSON.parse(JSON.stringify(k.pageMap));return await Promise.all(h.map(async([s,{metaObjectKeyPath:t,metaParentKeyPath:n}])=>{let o=await s,l=await o.default(),i=r()(e,t);i.data=l;let a=r()(e,n);!function collectCatchAllRoutes(e,s,t=!0){if(t){collectCatchAllRoutes(e,{kind:"Meta",data:s.data,locale:s.locale},!1),s.data=normalizeMetaData(s.data);return}for(let[t,o]of Object.entries(s.data)){if(!isFolder(o)){var n;if("*"===t)continue;e.children.push({kind:"MdxPage",...s.locale&&{locale:s.locale},name:t,route:(n=e.route,p(d.join(n,t.replace(/^index$/,""))))});continue}let r=t.replace("/",""),l={kind:"Folder",name:r,route:`${e.route}/${r}`,children:[{kind:"Meta",...s.locale&&{locale:s.locale},data:normalizeMetaData(o.items)}]};e.children.push(l),collectCatchAllRoutes(l,{kind:"Meta",data:o.items,locale:s.locale},!1)}}(a,i)})),n=e});let k=globalThis[x=l.eZ]||(globalThis[x]=Object.create(null));return s.pageMap?(k.pageMap=s.pageMap,k.Layout=t):(s={...s,pageMap:k.pageMap,flexsearch:k.flexsearch},o=k.themeConfig),s={frontMatter:{},...s},k.route=s.route,k.context||(k.context=Object.create(null)),k.context[e]={Content:i,pageOpts:s,themeConfig:o},Nextra}}},function(e){e.O(0,[3220,9774,2888,179],function(){return e(e.s=29540)}),_N_E=e.O()}]);