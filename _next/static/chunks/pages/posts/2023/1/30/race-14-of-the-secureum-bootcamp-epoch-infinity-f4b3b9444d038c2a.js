(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9252],{58672:function(e,s,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/2023/1/30/race-14-of-the-secureum-bootcamp-epoch-infinity",function(){return n(93626)}])},64751:function(e,s){"use strict";s.Z={src:"/_next/static/media/secureum-banner.b3ad8557.jpg",height:630,width:1200,blurDataURL:"data:image/jpeg;base64,/9j/2wBDAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYIx8lJCIfIiEmKzcvJik0KSEiMEExNDk7Pj4+JS5ESUM8SDc9Pjv/2wBDAQoLCw4NDhwQEBw7KCIoOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozv/wAARCAAEAAgDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAf/xAAbEAACAgMBAAAAAAAAAAAAAAAAAgEDBCEyE//EABUBAQEAAAAAAAAAAAAAAAAAAAQF/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAECEf/aAAwDAQACEQMRAD8AnGFcviyPjUWS1PTJuOtgAcT9auj/2Q==",blurWidth:8,blurHeight:4}},93626:function(e,s,n){"use strict";n.r(s),n.d(s,{HiddenSolution:function(){return HiddenSolution},__toc:function(){return p}});var t=n(35250),i=n(65910),a=n.n(i),l=n(47147),r=n(77298),o=n(18363),c=n(30746),h=n.n(c),d=n(64751),x=n(13423);function HiddenSolution(e){let{children:s}=e,n=Object.assign({details:"details",summary:"summary",strong:"strong",div:"div"},(0,r.a)());return(0,t.jsxs)(n.details,{closed:!0,className:"last-of-type:mb-0 rounded-lg bg-neutral-50 dark:bg-neutral-800 p-2 mt-4",children:[(0,t.jsx)(n.summary,{children:(0,t.jsx)(n.strong,{className:"text-lg",children:"Solution"})}),(0,t.jsx)(n.div,{className:"nx-p-2",children:s})]})}let p=[{depth:3,value:"Code",id:"code"},{depth:3,value:"Question 1 of 8",id:"question-1-of-8"},{depth:3,value:"Question 2 of 8",id:"question-2-of-8"},{depth:3,value:"Question 3 of 8",id:"question-3-of-8"},{depth:3,value:"Question 4 of 8",id:"question-4-of-8"},{depth:3,value:"Question 5 of 8",id:"question-5-of-8"},{depth:3,value:"Question 6 of 8",id:"question-6-of-8"},{depth:3,value:"Question 7 of 8",id:"question-7-of-8"},{depth:3,value:"Question 8 of 8",id:"question-8-of-8"}];function _createMdxContent(e){let s=Object.assign({h1:"h1",p:"p",a:"a",strong:"strong",hr:"hr",h3:"h3",pre:"pre",code:"code",span:"span",math:"math",semantics:"semantics",mrow:"mrow",mn:"mn",mi:"mi",annotation:"annotation"},(0,r.a)(),e.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h1,{children:"RACE #14 Of The Secureum Bootcamp Epoch∞"}),"\n","\n",(0,t.jsxs)(h(),{children:[(0,t.jsx)("meta",{property:"og:image",content:"https://ventral.digital"+d.Z.src,className:"jsx-ea2c409626c7be76"}),(0,t.jsx)("meta",{name:"twitter:image",content:"https://ventral.digital"+d.Z.src,className:"jsx-ea2c409626c7be76"})]}),"\n",(0,t.jsxs)(s.p,{children:["This is a Write-Up of RACE-14, Quiz of the ",(0,t.jsx)(s.a,{href:"https://twitter.com/0xRajeev/status/1470910752085065731",children:"Secureum Bootcamp"})," for Ethereum Smart Contract Auditors."]}),"\n",(0,t.jsxs)(o.UW,{type:"info",children:[(0,t.jsxs)(s.p,{children:["This one was designed by Secureum Mentors ",(0,t.jsx)(s.a,{href:"https://twitter.com/joranhonig",children:"Joran Honig"})," and ",(0,t.jsx)(s.a,{href:"https://twitter.com/GNSPS",children:"Gon\xe7alo"})," from ",(0,t.jsx)(s.a,{href:"https://twitter.com/ConsenSysAudits",children:"ConsenSys Diligence"}),". I imagine it was very hard to ",(0,t.jsx)(s.strong,{children:"solve all 8 questions within the strict timelimit of 16 minutes"}),", but I recommend you’ll try to see how far you come with using more time before looking at the solutions."]}),(0,t.jsx)(s.p,{children:"As usual, I waited for submissions to close before publishing it and, to stay true to the original, I omitted syntax highlighting. Feel free to copy it into your favorite editor, but do so after starting the timer!"})]}),"\n",(0,t.jsxs)("p",{className:"jsx-ea2c409626c7be76 text-xs text-right",children:["January 30, 2023 by ",(0,t.jsx)(s.a,{href:"/about#patrickd",children:"patrickd"})]}),"\n",(0,t.jsx)(a(),{id:"ea2c409626c7be76",children:"input[type=checkbox].jsx-ea2c409626c7be76{width:15px;height:15px}li.jsx-ea2c409626c7be76{padding:.5em}"}),"\n","\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"code",children:"Code"}),"\n",(0,t.jsx)(o.UW,{type:"info",children:(0,t.jsx)(s.p,{children:"Questions 1 & 2 are based on the below code snippet. You will see the same code snippet for these two questions. The questions are below the code snippet."})}),"\n",(0,t.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-line-numbers":"","data-language":"plaintext","data-theme":"default","data-line-numbers-max-digits":"2",children:[(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"contract USDCCollateral {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // This is a contract that's part of a larger system implementing a lending protocol"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // This particular contract concerns itself with allowing people to deposit USDC as collateral for their loans"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // A list of all the addresses lending"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    address[] lenders;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // A mapping to allow efficient is lender checks"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    mapping(address => bool) isLender;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    address immutable lendingPlatform;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    address token = ERC20(USDC_ADDRESS);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // We use a mapping to store the deposits of all lenders"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    mapping (address => bool) balance;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // USDC is very stable, so for every 1 USDC you can borrow 1 DAI or 1 USD worth of the other currency"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // Similar to other lending platforms, this lending system uses an oracle to determine how much one can borrow. "})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // The following describes how the system determines the max borrow value (ignoring precision for simplicity)."})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // maxBorrow = (collateralRatio * underlying * underlyingValueUSD) / otherValueUSD "})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // This encodes the margin requirement of the system."})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    uint collateralRatio = 100_000_000; "})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    constructor() {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        periodicFee = 1;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // approved collateral contracts are deployed by the lending platform"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // assume it is implemented correctly, and doesn't allow false collateral contracts."})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        lendingPlatform = msg.sender;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function deposit(uint amount) external {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        require(!isLender[msg.sender]);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        isLender[msg.sender] = true;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        lenders.push(msg.sender);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        ..."})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function computeFee(uint periodicFee, uint balance) internal returns (uint) {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // Assume this is a correctly implemented function that computes the share of fees that someone should receive based on their balance."})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // this function is called monthly by the lending platform"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // We compute how much fees the lender should receive and send it to them"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function payFees() external onlyLendingPlatform {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        for (uint i=0; i<lenders.length; i++) {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"            // Compute fee uses the balance of each lender"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"            uint fee = computeFee(periodicFee, balance[lenders[i]])"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"            token.transferFrom(lendingPlatform, lenders[i], fee);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    ..."})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,t.jsx)(s.h3,{id:"question-1-of-8",children:"Question 1 of 8"}),"\n",(0,t.jsx)(s.p,{children:"Lending platforms have a few options to configure when it comes to adding new tokens as collateral. For example, you’ll have to set up an oracle for the price of the collateral, and you have to configure a margin requirement. The security concern with using the given collateral configuration is:"}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. The periodic fee parameter is static "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. The collateral ratio of loans is too low "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. USDC should not be used as collateral for loans "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. None of the above "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is B."})}),(0,t.jsxs)(s.p,{children:["It's unknown whether the ",(0,t.jsx)(s.code,{children:"periodicFee"})," paramter is static or not from the given code, but either way it wouldn't be a security issue."]}),(0,t.jsx)(s.p,{children:"While it might seem okay to keep collateralisation of a stable coin at 100% it has a problem: The user can borrow at a price determined by an oracle without slippage. A smart arbitrageur would, after every trade on every other AMM, go in and trade until the price of the AMM is the same as the price reported by the oracle used by this lending platform. It would even be possible to sandwich oracle updates for profit. It's also risky to maintain collateralisation of positions."}),(0,t.jsx)(s.p,{children:"There's no general reason to not use USDC as collateral."})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"question-2-of-8",children:"Question 2 of 8"}),"\n",(0,t.jsxs)(s.p,{children:["Assuming ",(0,t.jsx)(s.code,{children:"payFees()"})," is periodically called by a function, which iteratively calls ",(0,t.jsx)(s.code,{children:"payFees()"})," of all collateral contracts, the security concern(s) is/are:"]}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. Collateral tokens can define their own fee rewards and have the protocol pay too much fees "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. There could be many lenders "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. ",(0,t.jsx)(s.code,{children:"payFees()"})," might re-enter the contract, paying all fees again "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. You can deposit at any point during the period "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is B, D."})}),(0,t.jsx)(s.p,{children:"The collateral contracts are deployed via the lending platform which is assumed to be correctly implemented. Under this assumption it wouldn't be possible for one of them to be malicious in terms of reward distribution."}),(0,t.jsx)(s.p,{children:"There could be so many lenders to iterate that the gas necessary for the function to complete is too large preventing the function to be called, effectively causing a Denial of Service."}),(0,t.jsx)(s.p,{children:"The token in question is USDC, an ERC20 token that does not have hooks allowing a receiver to reenter the function. A good recommendation would be the use of safeTransferFrom(), but it's not necessarily required."}),(0,t.jsx)(s.p,{children:"Nothing prevents someone to game the reward system by sandwiching the payFees() call with a large deposit() and withdrawal(). The current reward system does not incentivice that depositors keep their money in the system for a long time."})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"question-3-of-8",children:"Question 3 of 8"}),"\n",(0,t.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-line-numbers":"","data-language":"plaintext","data-theme":"default","data-line-numbers-max-digits":"1",children:[(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"modifier noETH {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    require(balanceOf(this) == 0);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    _;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,t.jsxs)(s.p,{children:["The developers want to prevent people from accidentally sending ETH instead of WETH and have implemented a ",(0,t.jsx)(s.code,{children:"noETH"})," modifier, as defined above, and annotated the deposit function with it. They have also not implemented a ",(0,t.jsx)(s.code,{children:"receive"})," function. Which of the following statements is true?"]}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. Developers can either use the modifier or achieve the same effect by omitting the payable keyword on deposit function "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. Developers should use the modifier because it achieves a different effect from omitting the payable keyword on deposit function "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. Developers should remove the modifier but achieve the required effect by omitting the payable keyword on deposit function "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. None of the above "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is C."})}),(0,t.jsxs)(s.p,{children:["Omitting the payable keyword does not have the same effect. The modifier checks the contract's current balance while the payable keyword checks the actual ether that was sent with the message (",(0,t.jsx)(s.code,{children:"msg.value"}),")."]}),(0,t.jsxs)(s.p,{children:["The developers should NOT use the modifier because of this difference since it will lead to Denial of Service once the contract's balance becomes non-zero (it's possible forcefully injecting ether into a contract, eg. via ",(0,t.jsx)(s.code,{children:"SELFDESTRUCT"}),")."]})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"question-4-of-8",children:"Question 4 of 8"}),"\n",(0,t.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-language":"plaintext","data-theme":"default",children:[(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"modifier checkedPool{"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    address pool;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    assembly { "})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        let size := calldatasize()"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        pool := calldataload(sub(size, 32))"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    require(isValid(pool));"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    _;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"function isValid(pool) internal {...}"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"function somePoolOperation(...., address pool) public checkedPool { ... }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"function anotherPoolOperation(...., address pool) public checkedPool { ... }"})})]})}),"\n",(0,t.jsx)(s.p,{children:"Developers have used assembly to make their code a bit less repetitive. They use it to annotate a bunch of functions that have as their last argument a pool address. Unfortunately they made a mistake. Which of the following options fixes the bug?"}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. Replace the modifier with ",(0,t.jsx)(s.code,{children:"require(isValid(pool));"})," in every function with the modifier "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. Make all functions using ",(0,t.jsx)(s.code,{children:"checkedPool"})," external "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. Everything is fine; this code has no problems "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. None of the above "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is A."})}),(0,t.jsxs)(s.p,{children:["Dropping the modifier in favor of a single ",(0,t.jsx)(s.code,{children:"require()"})," fixes the issue and even improves code readability to what was attempted here with assembly. If the developers insist on the use of modifiers they should pass the pool value directly as an argument to it instead: ",(0,t.jsx)(s.code,{children:"checkedPool(pool)"}),"."]}),(0,t.jsx)(s.p,{children:"Making all of the function external (therefore preventing them to be called internally) would certainly increase the likelihood that the assembly snippet will pick up the correct value. But there's still no guarantee that the last 32 bytes of the calldata are always the pool argument. A caller can send more data than defined in the function's signature and the ABI decoding would work just fine while ignoring the extra data. But the modifier would load the extra data instead of the pool value. This would potentially allow to bypass the pool validation and allow for exploitation."}),(0,t.jsx)(s.p,{children:"As mentioned, the code snippet is certainly not fine. It attempts loading the pool parameter from the calldata and assumes that it would always be located in the last 32 bytes - there's no guarantee for that being the case."})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(o.UW,{type:"info",children:(0,t.jsx)(s.p,{children:"Questions 5 & 6 are based on the below code snippet. You will see the same code snippet for these two questions. The questions are below the code snippet."})}),"\n",(0,t.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-language":"plaintext","data-theme":"default",children:[(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"interface Lender {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function onLiquidation() external;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"interface IERC20 {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    event Transfer(address indexed from, address indexed to, uint256 value);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    event Approval(address indexed owner, address indexed spender, uint256 value);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function totalSupply() external view returns (uint256);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function balanceOf(address account) external view returns (uint256);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function transfer(address to, uint256 amount) external returns (bool);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function allowance(address owner, address spender) external view returns (uint256);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function approve(address spender, uint256 amount) external returns (bool);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function transferFrom(address from, address to, uint256 amount) external returns (bool);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"contract ERC20Collateral {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // This contract is different from the one in Questions 1 & 2, please read it carefully!!!"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // This is a contract that's part of a larger system implementing a lending protocol"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // A list of all the addresses lending"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    address[] lenders;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // A mapping to allow efficient is lender checks"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    mapping(address => bool) isLender;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    address immutable lendingPlatform = msg.sender;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    IERC20 token;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // We use a mapping to store the deposits of all lenders"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    mapping (address => uint256) balance;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    event Liquidation(address indexed lender, uint256 liquidatedAmount);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    constructor(IERC20 _token) {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // Consider this contract is now part of a new permissionless factory"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // built by the protocol. The factory behaves very much like a UniswapV2 factory"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // that allows anyone to deploy their own collateral contract"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        token = _token;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function deposit(uint amount) external {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        isLender[msg.sender] = true;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        lenders.push(msg.sender);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        token.transferFrom(msg.sender, lendingPlatform, amount);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        balance[msg.sender] += amount;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function liquidate(address lender) external {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // We call the protocol factory to check for under-collateralization conditions"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        require(lendingPlatform.undercollateralized(lender, balance[lender]));"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        uint256 oldDeposit = balance[lender];"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        balance[lender] = 0;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        uint256 fee = oldDeposit / 1000; // fee ratio == 1/1000"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // Give the caller his liquidation execution fee"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        token.transferFrom(address(this), msg.sender, fee);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // Transfer the rest of the collateral to the platform"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        token.transferFrom(address(this), lendingPlatform, oldDeposit - fee);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // Now ping the liquidated lender for him to be able to react to the liquidation"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // We need to use a low-level call because the lender might not be a contract"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // and the compiler checks code size on high-level calls, reverting if it's 0"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        address(lender).call(abi.encodePacked(Lender.onLiquidation.selector));"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        emit Liquidation(lender, oldDeposit - balance[lender]);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"question-5-of-8",children:"Question 5 of 8"}),"\n",(0,t.jsx)(s.p,{children:"The lending protocol has also built in a liquidation function to be called in the case of under-collateralization. Anyone can call the function and be rewarded for calling it by taking a small percentage of the liquidation. The liquidation function has a vulnerability which can be exploited because:"}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. The lender can open a position with a low amount of collateral and the fee payout reverts "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. The lender can make the position “unliquidatable” with reentrancy "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. The lender can liquidate other positions with his callback and make more money "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. The liquidator can take the full collateral amount with reentrancy "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is B."})}),(0,t.jsxs)(s.p,{children:["At first the code might look like the checks-effects-interactions pattern is followed (ie. no harmful reentrancy is possible) but there's actually another check happening when the Liquidation event is emitted: If the current ",(0,t.jsx)(s.code,{children:"balance"})," is suddenly larger than the ",(0,t.jsx)(s.code,{children:"oldDeposit"}),". Since the lender is called before this check happens, they could reenter via the ",(0,t.jsx)(s.code,{children:"deposit()"})," function and increase the balance causing the liquidation to fail (ie. potentially making the position “unliquidatable”)."]}),(0,t.jsx)(s.p,{children:"Aside from answer B, the other options are mostly nonsensical decoys."})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"question-6-of-8",children:"Question 6 of 8"}),"\n",(0,t.jsxs)(s.p,{children:["Assume that the vulnerability referenced in the previous question has been fixed by changing the line with the ",(0,t.jsx)(s.code,{children:"Liquidation"})," event emission to emit ",(0,t.jsx)(s.code,{children:"Liquidation(lender, oldDeposit)"}),". The protocol team has built a bot that monitors and liquidates under-collateralized positions automatically. Even though the bot does not monitor the mempool, it simulates the full transaction and, if successful, sends transactions with the exact amount to be able to execute the function + 100000 gas for minimal execution in the ",(0,t.jsx)(s.code,{children:"onLiquidation()"})," callback. Which of these attacks can be executed in a harmful way towards the protocol?"]}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. An attacker can liquidate positions, reenter the contract and steal tokens "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. The liquidated lender can monitor the mempool and frontrun the protocol bot with a deposit, griefing it "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. The lender can make their position “unliquidatable” by consuming all the gas provided in the callback "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. The liquidated lender can tokenize the extra gas in the callback and make a profit "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is B."})}),(0,t.jsx)(s.p,{children:"First option is nonsensical."}),(0,t.jsxs)(s.p,{children:["Although the revert via reentrancy in the ",(0,t.jsx)(s.code,{children:"deposit()"})," function has been fixed, it's still possible that the bot is simply frontrun by a lender who increases their collateral via ",(0,t.jsx)(s.code,{children:"deposit()"})," just in time to make the bot's liquidation attempt fail."]}),(0,t.jsxs)(s.p,{children:["A liquidated lender could, when called, only use up all of the gas it was given via the ",(0,t.jsx)(s.code,{children:"CALL"}),", which is ",(0,t.jsxs)(s.span,{className:"katex",children:[(0,t.jsx)(s.span,{className:"katex-mathml",children:(0,t.jsx)(s.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,t.jsxs)(s.semantics,{children:[(0,t.jsxs)(s.mrow,{children:[(0,t.jsx)(s.mn,{children:"63"}),(0,t.jsx)(s.mi,{mathvariant:"normal",children:"/"}),(0,t.jsx)(s.mn,{children:"64"})]}),(0,t.jsx)(s.annotation,{encoding:"application/x-tex",children:"63/64"})]})})}),(0,t.jsx)(s.span,{className:"katex-html","aria-hidden":"true",children:(0,t.jsxs)(s.span,{className:"base",children:[(0,t.jsx)(s.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,t.jsx)(s.span,{className:"mord",children:"63/64"})]})})]})," of the total gas. With a sufficiently high gas limit it is still possible to liquidate the lender."]}),(0,t.jsx)(s.p,{children:"Gas tokenization is no longer viable since EIP-3529 has reduced refunds."})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"question-7-of-8",children:"Question 7 of 8"}),"\n",(0,t.jsxs)(s.p,{children:["In the context of Questions 5 and 6, someone built a MEV frontrunner bot that is exploiting liquidations in different protocols. It monitors the mempool for collateral contracts deployed from the lending factory and simulates transactions in a mainnet fork within Foundry to check whether it should attack them. The logic behind the bot is that it checks only the token’s ",(0,t.jsx)(s.code,{children:"“Transfer”"})," events for its success conditions. More precisely, it checks if there is liquidity in an AMM to exchange to ETH and make sure it turns a profit at the end. If so, it sends a Flashbot bundle to make a profit by frontrunning the liquidator. Knowing the factory for this new contract is permissionless, how could you extract assets out of this bot?"]}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. Open a position with a low collateral amount to grief the bot "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. Build a similar bot that frontruns this one "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. Deploy a collateral contract with your own custom token and seed an AMM pool with some ETH and this token, tricking the bot "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. There is no way to do it "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:"Correct is C."}),(0,t.jsx)(s.p,{children:"Griefing the bot would not extract assets from it."}),(0,t.jsxs)(s.p,{children:['Option C actually happened on mainnet and was labelled "',(0,t.jsx)(s.a,{href:"https://github.com/Defi-Cartel/salmonella",children:"Salmonella Attack"}),'"']}),(0,t.jsx)(s.p,{children:"Since it's using Flashbot Bundles, frontrunning it should not be possible since the transaction would be private."})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"question-8-of-8",children:"Question 8 of 8"}),"\n",(0,t.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-language":"plaintext","data-theme":"default",children:[(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"// Assume as adding to the code shown for Questions 5 & 6"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"contract ERC20Collateral {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // This is a contract that's part of a larger system implementing a lending protocol"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    ..."})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function transferCollateral("})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        address signer,"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        address receiver,"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        uint256 amount,"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        bytes32 sigR,"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        bytes32 sigS,"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        uint8 sigV"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    ) external {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:'        require(signer != address(0), "INVALID_SIGNER");'})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // Check that the signer is the one who actually signed the message"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        require(signer == ecrecover("})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"            keccak256(abi.encodePacked(receiver, amount)),"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"            sigV,"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"            sigR,"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"            sigS"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        ));"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        deposits[receiver] += amount;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        deposits[signer] -= amount;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    ..."})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,t.jsx)(s.p,{children:"The protocol implemented a function to transfer collateral from lender A to lender B with a signature from A, as shown above. Is there a way you can break it?"}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. Lender B can get more than the intended amount from lender A (assuming there is more than double the amount in A’s account) "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. Lender A can pretend to transfer to lender B but then steal amount from him "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. Lender A can grief lender B by sending a malformed signature (assuming the S parameter is correct) "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. Lender B can steal from another lender C, by submitting a malformed signature. "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is A."})}),(0,t.jsxs)(s.p,{children:["There's nothing preventing the same signature to be re-used over and over again. So as long as the ",(0,t.jsx)(s.code,{children:"signer"})," has a balance higher than the signed ",(0,t.jsx)(s.code,{children:"amount"}),", the ",(0,t.jsx)(s.code,{children:"receiver"})," can transfer their collateral."]}),(0,t.jsxs)(s.p,{children:["Even if the code would keep track of the signatures that were already used once, the code would still be exploitable via signature malleability. A correct way to fix it would be to track a nonce for each ",(0,t.jsx)(s.code,{children:"signer"}),"."]}),(0,t.jsxs)(s.p,{children:["A malformed signature would cause ",(0,t.jsx)(s.code,{children:"ecrecover"})," to return a zero-address, but is prevented since the return value must be equal to the ",(0,t.jsx)(s.code,{children:"signer"})," who may not be the zero-address."]})]}),"\n",(0,t.jsx)(s.hr,{}),"\n","\n",(0,t.jsxs)(o.oy,{children:[(0,t.jsx)(o.Zb,{icon:(0,t.jsx)(x.H8,{}),title:"← RACE #13 Of The Secureum Bootcamp Epoch∞",href:"/posts/2023/1/3/race-13-of-the-secureum-bootcamp-epoch/"}),(0,t.jsx)(o.Zb,{icon:(0,t.jsx)(x.H8,{}),title:"RACE #15 Of The Secureum Bootcamp Epoch∞ →",href:"/posts/2023/2/27/race-15-of-the-secureum-bootcamp-epoch-infinity"})]})]})}s.default=(0,l.j)({MDXContent:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:s}=Object.assign({},(0,r.a)(),e.components);return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(_createMdxContent,{...e})}):_createMdxContent(e)},pageOpts:{filePath:"pages/posts/2023/1/30/race-14-of-the-secureum-bootcamp-epoch-infinity.mdx",route:"/posts/2023/1/30/race-14-of-the-secureum-bootcamp-epoch-infinity",timestamp:1731290394e3,title:"RACE #14 Of The Secureum Bootcamp Epoch∞",headings:p},pageNextRoute:"/posts/2023/1/30/race-14-of-the-secureum-bootcamp-epoch-infinity"})},96139:function(e,s,n){var t=n(94869);n(26228);var i=n(70079),a=i&&"object"==typeof i&&"default"in i?i:{default:i};function _defineProperties(e,s){for(var n=0;n<s.length;n++){var t=s[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}var l=void 0!==t&&t.env&&!0,isString=function(e){return"[object String]"===Object.prototype.toString.call(e)},r=function(){function StyleSheet(e){var s=void 0===e?{}:e,n=s.name,t=void 0===n?"stylesheet":n,i=s.optimizeForSpeed,a=void 0===i?l:i;invariant$1(isString(t),"`name` must be a string"),this._name=t,this._deletedRulePlaceholder="#"+t+"-deleted-rule____{}",invariant$1("boolean"==typeof a,"`optimizeForSpeed` must be a boolean"),this._optimizeForSpeed=a,this._serverSheet=void 0,this._tags=[],this._injected=!1,this._rulesCount=0;var r=document.querySelector('meta[property="csp-nonce"]');this._nonce=r?r.getAttribute("content"):null}var e,s=StyleSheet.prototype;return s.setOptimizeForSpeed=function(e){invariant$1("boolean"==typeof e,"`setOptimizeForSpeed` accepts a boolean"),invariant$1(0===this._rulesCount,"optimizeForSpeed cannot be when rules have already been inserted"),this.flush(),this._optimizeForSpeed=e,this.inject()},s.isOptimizeForSpeed=function(){return this._optimizeForSpeed},s.inject=function(){var e=this;if(invariant$1(!this._injected,"sheet already injected"),this._injected=!0,this._optimizeForSpeed){this._tags[0]=this.makeStyleTag(this._name),this._optimizeForSpeed="insertRule"in this.getSheet(),this._optimizeForSpeed||(l||console.warn("StyleSheet: optimizeForSpeed mode not supported falling back to standard mode."),this.flush(),this._injected=!0);return}this._serverSheet={cssRules:[],insertRule:function(s,n){return"number"==typeof n?e._serverSheet.cssRules[n]={cssText:s}:e._serverSheet.cssRules.push({cssText:s}),n},deleteRule:function(s){e._serverSheet.cssRules[s]=null}}},s.getSheetForTag=function(e){if(e.sheet)return e.sheet;for(var s=0;s<document.styleSheets.length;s++)if(document.styleSheets[s].ownerNode===e)return document.styleSheets[s]},s.getSheet=function(){return this.getSheetForTag(this._tags[this._tags.length-1])},s.insertRule=function(e,s){if(invariant$1(isString(e),"`insertRule` accepts only strings"),this._optimizeForSpeed){var n=this.getSheet();"number"!=typeof s&&(s=n.cssRules.length);try{n.insertRule(e,s)}catch(s){return l||console.warn("StyleSheet: illegal rule: \n\n"+e+"\n\nSee https://stackoverflow.com/q/20007992 for more info"),-1}}else{var t=this._tags[s];this._tags.push(this.makeStyleTag(this._name,e,t))}return this._rulesCount++},s.replaceRule=function(e,s){if(this._optimizeForSpeed){var n=this.getSheet();if(s.trim()||(s=this._deletedRulePlaceholder),!n.cssRules[e])return e;n.deleteRule(e);try{n.insertRule(s,e)}catch(t){l||console.warn("StyleSheet: illegal rule: \n\n"+s+"\n\nSee https://stackoverflow.com/q/20007992 for more info"),n.insertRule(this._deletedRulePlaceholder,e)}}else{var t=this._tags[e];invariant$1(t,"old rule at index `"+e+"` not found"),t.textContent=s}return e},s.deleteRule=function(e){if(this._optimizeForSpeed)this.replaceRule(e,"");else{var s=this._tags[e];invariant$1(s,"rule at index `"+e+"` not found"),s.parentNode.removeChild(s),this._tags[e]=null}},s.flush=function(){this._injected=!1,this._rulesCount=0,this._tags.forEach(function(e){return e&&e.parentNode.removeChild(e)}),this._tags=[]},s.cssRules=function(){var e=this;return this._tags.reduce(function(s,n){return n?s=s.concat(Array.prototype.map.call(e.getSheetForTag(n).cssRules,function(s){return s.cssText===e._deletedRulePlaceholder?null:s})):s.push(null),s},[])},s.makeStyleTag=function(e,s,n){s&&invariant$1(isString(s),"makeStyleTag accepts only strings as second parameter");var t=document.createElement("style");this._nonce&&t.setAttribute("nonce",this._nonce),t.type="text/css",t.setAttribute("data-"+e,""),s&&t.appendChild(document.createTextNode(s));var i=document.head||document.getElementsByTagName("head")[0];return n?i.insertBefore(t,n):i.appendChild(t),t},_defineProperties(StyleSheet.prototype,[{key:"length",get:function(){return this._rulesCount}}]),e&&_defineProperties(StyleSheet,e),StyleSheet}();function invariant$1(e,s){if(!e)throw Error("StyleSheet: "+s+".")}var stringHash=function(e){for(var s=5381,n=e.length;n;)s=33*s^e.charCodeAt(--n);return s>>>0},o={};function computeId(e,s){if(!s)return"jsx-"+e;var n=String(s),t=e+n;return o[t]||(o[t]="jsx-"+stringHash(e+"-"+n)),o[t]}function computeSelector(e,s){var n=e+s;return o[n]||(o[n]=s.replace(/__jsx-style-dynamic-selector/g,e)),o[n]}var c=function(){function StyleSheetRegistry(e){var s=void 0===e?{}:e,n=s.styleSheet,t=void 0===n?null:n,i=s.optimizeForSpeed,a=void 0!==i&&i;this._sheet=t||new r({name:"styled-jsx",optimizeForSpeed:a}),this._sheet.inject(),t&&"boolean"==typeof a&&(this._sheet.setOptimizeForSpeed(a),this._optimizeForSpeed=this._sheet.isOptimizeForSpeed()),this._fromServer=void 0,this._indices={},this._instancesCounts={}}var e=StyleSheetRegistry.prototype;return e.add=function(e){var s=this;void 0===this._optimizeForSpeed&&(this._optimizeForSpeed=Array.isArray(e.children),this._sheet.setOptimizeForSpeed(this._optimizeForSpeed),this._optimizeForSpeed=this._sheet.isOptimizeForSpeed()),this._fromServer||(this._fromServer=this.selectFromServer(),this._instancesCounts=Object.keys(this._fromServer).reduce(function(e,s){return e[s]=0,e},{}));var n=this.getIdAndRules(e),t=n.styleId,i=n.rules;if(t in this._instancesCounts){this._instancesCounts[t]+=1;return}var a=i.map(function(e){return s._sheet.insertRule(e)}).filter(function(e){return -1!==e});this._indices[t]=a,this._instancesCounts[t]=1},e.remove=function(e){var s=this,n=this.getIdAndRules(e).styleId;if(function(e,s){if(!e)throw Error("StyleSheetRegistry: "+s+".")}(n in this._instancesCounts,"styleId: `"+n+"` not found"),this._instancesCounts[n]-=1,this._instancesCounts[n]<1){var t=this._fromServer&&this._fromServer[n];t?(t.parentNode.removeChild(t),delete this._fromServer[n]):(this._indices[n].forEach(function(e){return s._sheet.deleteRule(e)}),delete this._indices[n]),delete this._instancesCounts[n]}},e.update=function(e,s){this.add(s),this.remove(e)},e.flush=function(){this._sheet.flush(),this._sheet.inject(),this._fromServer=void 0,this._indices={},this._instancesCounts={}},e.cssRules=function(){var e=this,s=this._fromServer?Object.keys(this._fromServer).map(function(s){return[s,e._fromServer[s]]}):[],n=this._sheet.cssRules();return s.concat(Object.keys(this._indices).map(function(s){return[s,e._indices[s].map(function(e){return n[e].cssText}).join(e._optimizeForSpeed?"":"\n")]}).filter(function(e){return!!e[1]}))},e.styles=function(e){var s,n;return s=this.cssRules(),void 0===(n=e)&&(n={}),s.map(function(e){var s=e[0],t=e[1];return a.default.createElement("style",{id:"__"+s,key:"__"+s,nonce:n.nonce?n.nonce:void 0,dangerouslySetInnerHTML:{__html:t}})})},e.getIdAndRules=function(e){var s=e.children,n=e.dynamic,t=e.id;if(n){var i=computeId(t,n);return{styleId:i,rules:Array.isArray(s)?s.map(function(e){return computeSelector(i,e)}):[computeSelector(i,s)]}}return{styleId:computeId(t),rules:Array.isArray(s)?s:[s]}},e.selectFromServer=function(){return Array.prototype.slice.call(document.querySelectorAll('[id^="__jsx-"]')).reduce(function(e,s){return e[s.id.slice(2)]=s,e},{})},StyleSheetRegistry}(),h=i.createContext(null);h.displayName="StyleSheetContext";var d=a.default.useInsertionEffect||a.default.useLayoutEffect,x=new c;function JSXStyle(e){var s=x||i.useContext(h);return s&&d(function(){return s.add(e),function(){s.remove(e)}},[e.id,String(e.dynamic)]),null}JSXStyle.dynamic=function(e){return e.map(function(e){return computeId(e[0],e[1])}).join(" ")},s.style=JSXStyle},65910:function(e,s,n){"use strict";e.exports=n(96139).style},26228:function(){}},function(e){e.O(0,[3220,1589,9774,2888,179],function(){return e(e.s=58672)}),_N_E=e.O()}]);