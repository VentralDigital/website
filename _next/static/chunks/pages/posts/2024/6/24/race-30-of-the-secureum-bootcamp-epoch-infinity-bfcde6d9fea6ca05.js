(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9514],{64311:function(e,s,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/2024/6/24/race-30-of-the-secureum-bootcamp-epoch-infinity",function(){return n(43337)}])},64751:function(e,s){"use strict";s.Z={src:"/_next/static/media/secureum-banner.b3ad8557.jpg",height:630,width:1200,blurDataURL:"data:image/jpeg;base64,/9j/2wBDAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYIx8lJCIfIiEmKzcvJik0KSEiMEExNDk7Pj4+JS5ESUM8SDc9Pjv/2wBDAQoLCw4NDhwQEBw7KCIoOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozv/wAARCAAEAAgDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAf/xAAbEAACAgMBAAAAAAAAAAAAAAAAAgEDBCEyE//EABUBAQEAAAAAAAAAAAAAAAAAAAQF/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAECEf/aAAwDAQACEQMRAD8AnGFcviyPjUWS1PTJuOtgAcT9auj/2Q==",blurWidth:8,blurHeight:4}},43337:function(e,s,n){"use strict";n.r(s),n.d(s,{HiddenSolution:function(){return HiddenSolution},__toc:function(){return u}});var t=n(35250),a=n(65910),i=n.n(a),r=n(47147),c=n(77298),l=n(18363),o=n(30746),h=n.n(o),d=n(64751),x=n(13423);function HiddenSolution(e){let{children:s}=e,n=Object.assign({details:"details",summary:"summary",strong:"strong",div:"div"},(0,c.a)());return(0,t.jsxs)(n.details,{closed:!0,className:"last-of-type:mb-0 rounded-lg bg-neutral-50 dark:bg-neutral-800 p-2 mt-4",children:[(0,t.jsx)(n.summary,{children:(0,t.jsx)(n.strong,{className:"text-lg",children:"Solution"})}),(0,t.jsx)(n.div,{className:"nx-p-2",children:s})]})}let u=[{depth:3,value:"Code",id:"code"},{depth:3,value:"Question 1 of 8",id:"question-1-of-8"},{depth:3,value:"Question 2 of 8",id:"question-2-of-8"},{depth:3,value:"Question 3 of 8",id:"question-3-of-8"},{depth:3,value:"Question 4 of 8",id:"question-4-of-8"},{depth:3,value:"Question 5 of 8",id:"question-5-of-8"},{depth:3,value:"Question 6 of 8",id:"question-6-of-8"},{depth:3,value:"Question 7 of 8",id:"question-7-of-8"},{depth:3,value:"Question 8 of 8",id:"question-8-of-8"}];function _createMdxContent(e){let s=Object.assign({h1:"h1",p:"p",a:"a",strong:"strong",hr:"hr",h3:"h3",pre:"pre",code:"code",span:"span",math:"math",semantics:"semantics",mrow:"mrow",mtext:"mtext",mo:"mo",mn:"mn",mfrac:"mfrac",annotation:"annotation",blockquote:"blockquote"},(0,c.a)(),e.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h1,{children:"RACE #30 Of The Secureum Bootcamp Epoch∞"}),"\n","\n",(0,t.jsxs)(h(),{children:[(0,t.jsx)("meta",{property:"og:image",content:"https://ventral.digital"+d.Z.src,className:"jsx-ea2c409626c7be76"}),(0,t.jsx)("meta",{name:"twitter:image",content:"https://ventral.digital"+d.Z.src,className:"jsx-ea2c409626c7be76"})]}),"\n",(0,t.jsxs)(s.p,{children:["This is a Write-Up of RACE-30, Quiz of the ",(0,t.jsx)(s.a,{href:"https://twitter.com/0xRajeev/status/1470910752085065731",children:"Secureum Bootcamp"})," for Ethereum Smart Contract Auditors. This month's RACE was created by Secureum Mentor ",(0,t.jsx)(s.a,{href:"https://x.com/Montyly",children:"Josselin Feist"}),", engineering director at ",(0,t.jsx)(s.a,{href:"https://x.com/trailofbits",children:"Trail of Bits"}),"."]}),"\n",(0,t.jsxs)(l.UW,{type:"info",children:[(0,t.jsxs)(s.p,{children:["Participants of this quiz had to ",(0,t.jsx)(s.strong,{children:"answer 8 questions within the strict time limit of 16 minutes"}),". If you’re reading this in preparation for participating yourself, it’s best to give it a try under the same time limit!"]}),(0,t.jsx)(s.p,{children:"As usual, I waited for submissions to close before publishing it and, to stay true to the original, I omitted syntax highlighting. Feel free to copy it into your favorite editor, but do so after starting the timer!"})]}),"\n",(0,t.jsxs)("p",{className:"jsx-ea2c409626c7be76 text-xs text-right",children:["June 24, 2024 by ",(0,t.jsx)(s.a,{href:"/about#patrickd",children:"patrickd"})]}),"\n",(0,t.jsx)(i(),{id:"ea2c409626c7be76",children:"input[type=checkbox].jsx-ea2c409626c7be76{width:15px;height:15px}li.jsx-ea2c409626c7be76{padding:.5em}"}),"\n","\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"code",children:"Code"}),"\n",(0,t.jsx)(l.UW,{type:"info",children:(0,t.jsx)(s.p,{children:"All 8 questions in this RACE are based on the below contracts."})}),"\n",(0,t.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-line-numbers":"","data-language":"plaintext","data-theme":"default","data-line-numbers-max-digits":"2",children:[(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"pragma solidity >=0.8.0;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:'import "https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/IERC20.sol";'})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"contract FixedPoint{"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    uint256 internal constant ONE = 1e18; // 18 decimal"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function div(uint256 a, uint256 b) internal pure returns (uint256) {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        uint256 aInflated = a * ONE;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        return aInflated / b;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function mul(uint256 a, uint256 b) internal pure returns (uint256) {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        uint256 product = a * b;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        return product / ONE;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"// The following implements a pool that follows Balancer’s weighted pool principle."})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"// For this Secureum RACE, only 1 swap direction is shown, and you can assume that other functions exist and are correct"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"// In particular, assume that the tokens can also be exchanged from tokenOut to tokenIn"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"// And LP providers can add/remove liquidity"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"// You can also assume that the formula’s specification in outGivenIn is correct "})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"contract BalancerLikePool is FixedPoint{"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    IERC20 tokenIn;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    IERC20 tokenOut;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"   function outGivenIn("})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        uint256 tokenBalanceIn,"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        uint256 tokenBalanceOut,"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        uint256 tokenAmountIn"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    ) internal pure returns (uint256) {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // Simplified formula (Secureum's version- assume the formula’s documentation is correct)"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        /**********************************************************************************************"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // outGivenIn                                                                                //"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // aO = tokenAmountOut                                                                       //"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // bO = tokenBalanceOut                                                                      //"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // bI = tokenBalanceIn              /      /            bI             \\                     //"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // aI = tokenAmountIn    aO = bO * |  1 - | --------------------------  |                    //"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        //                                  \\      \\       ( bI + aI )         /                     //"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        **********************************************************************************************/"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        uint256 quotient = div(tokenBalanceIn, tokenBalanceIn + tokenAmountIn);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        uint256 right_component = ONE - quotient;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        return mul(tokenBalanceOut, right_component);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    // Receive tokenOut based on the amountIn of tokenIn we sent."})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    function swapOutGivenIn(uint amountIn) public {"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        uint balanceIn = tokenIn.balanceOf(address(this));"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        uint balanceOut = tokenOut.balanceOf(address(this));"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        // Take 5% fees. We are ok to round down and receive less fees in general and no fees for small swaps"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        amountIn = amountIn * 105 / 100;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        uint amountOut = outGivenIn(balanceIn, balanceOut, amountIn);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        tokenOut.transfer(msg.sender, amountOut);"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        tokenIn.transferFrom(msg.sender, address(this), amountIn); "})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"}})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,t.jsx)(s.h3,{id:"question-1-of-8",children:"Question 1 of 8"}),"\n",(0,t.jsx)(s.p,{children:"Which of the following ERC20-related risks are applicable for this code?"}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. Missing return value checks "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. Flash minting "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. Fees on transfer "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. None of the above "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is A, C."})}),(0,t.jsxs)(s.p,{children:["Some ERC-20 tokens revert on errors, others return ",(0,t.jsx)(s.code,{children:"false"}),". This code does currently not check for return values of function calls such as ",(0,t.jsx)(s.code,{children:"tokenOut.transfer()"}),", but there's no guarantee that the token behind the ",(0,t.jsx)(s.code,{children:"tokenOut"})," variable actually reverts on error. The best practice here is using the SafeERC20 library as a wrapper for ERC20 calls."]}),(0,t.jsx)(s.p,{children:"Fees that are applied on token transfer mean that the actual balance received can be lower than the value specified during a transfer function call. This can lead to losses for the protocol or errors in the accounting logic of a contract. Usage of such tokens should be avoided when the code is not specifically prepared to handle them."})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"question-2-of-8",children:"Question 2 of 8"}),"\n",(0,t.jsxs)(s.p,{children:["For the below expressions in ",(0,t.jsx)(s.code,{children:"outGivenIn"}),":"]}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. ",(0,t.jsx)(s.code,{children:'tokenBalanceIn" + "tokenAmountIn;'})," - overflow protection must be added "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. ",(0,t.jsx)(s.code,{children:"ONE - quotient;"})," - underflow protection must be added "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. ",(0,t.jsx)(s.code,{children:"div(tokenBalanceIn, tokenBalanceIn + tokenAmountIn);"})," - div operation must round up "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. ",(0,t.jsx)(s.code,{children:"mul(tokenBalanceOut, right_component);"})," - mul operation must round up "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is C."})}),(0,t.jsx)(s.p,{children:"No overflow or underflow protection is required thanks to the used Solidity version having it natively."}),(0,t.jsx)(s.p,{children:"Rounding must be chosen in a manner that favors the protocol to avoid abuse. That means that amounts demanded as payment by the contract should be rounded up. While funds leaving the protocol should be rounded down."}),(0,t.jsx)(s.span,{className:"katex-display",children:(0,t.jsxs)(s.span,{className:"katex",children:[(0,t.jsx)(s.span,{className:"katex-mathml",children:(0,t.jsx)(s.math,{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block",children:(0,t.jsxs)(s.semantics,{children:[(0,t.jsxs)(s.mrow,{children:[(0,t.jsx)(s.mtext,{children:"tokenAmountOut"}),(0,t.jsx)(s.mo,{children:"="}),(0,t.jsx)(s.mtext,{children:"tokenBalanceOut"}),(0,t.jsx)(s.mo,{children:"⋅"}),(0,t.jsxs)(s.mrow,{children:[(0,t.jsx)(s.mo,{fence:"true",children:"("}),(0,t.jsx)(s.mn,{children:"1"}),(0,t.jsx)(s.mo,{children:"−"}),(0,t.jsxs)(s.mrow,{children:[(0,t.jsx)(s.mo,{fence:"true",children:"("}),(0,t.jsxs)(s.mfrac,{children:[(0,t.jsx)(s.mtext,{children:"tokenBalanceIn"}),(0,t.jsxs)(s.mrow,{children:[(0,t.jsx)(s.mtext,{children:"tokenBalanceIn"}),(0,t.jsx)(s.mo,{children:"+"}),(0,t.jsx)(s.mtext,{children:"tokenAmountIn"})]})]}),(0,t.jsx)(s.mo,{fence:"true",children:")"})]}),(0,t.jsx)(s.mo,{fence:"true",children:")"})]})]}),(0,t.jsx)(s.annotation,{encoding:"application/x-tex",children:"\\text{tokenAmountOut}=\\text{tokenBalanceOut}\\cdot{\\left({1}-{\\left(\\frac{\\text{tokenBalanceIn}}{{\\text{tokenBalanceIn}+\\text{tokenAmountIn}}}\\right)}\\right)}"})]})})}),(0,t.jsxs)(s.span,{className:"katex-html","aria-hidden":"true",children:[(0,t.jsxs)(s.span,{className:"base",children:[(0,t.jsx)(s.span,{className:"strut",style:{height:"0.6944em"}}),(0,t.jsx)(s.span,{className:"mord text",children:(0,t.jsx)(s.span,{className:"mord",children:"tokenAmountOut"})}),(0,t.jsx)(s.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,t.jsx)(s.span,{className:"mrel",children:"="}),(0,t.jsx)(s.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,t.jsxs)(s.span,{className:"base",children:[(0,t.jsx)(s.span,{className:"strut",style:{height:"0.6944em"}}),(0,t.jsx)(s.span,{className:"mord text",children:(0,t.jsx)(s.span,{className:"mord",children:"tokenBalanceOut"})}),(0,t.jsx)(s.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,t.jsx)(s.span,{className:"mbin",children:"⋅"}),(0,t.jsx)(s.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,t.jsxs)(s.span,{className:"base",children:[(0,t.jsx)(s.span,{className:"strut",style:{height:"2.4em",verticalAlign:"-0.95em"}}),(0,t.jsx)(s.span,{className:"mord",children:(0,t.jsxs)(s.span,{className:"minner",children:[(0,t.jsx)(s.span,{className:"mopen delimcenter",style:{top:"0em"},children:(0,t.jsx)(s.span,{className:"delimsizing size3",children:"("})}),(0,t.jsx)(s.span,{className:"mord",children:(0,t.jsx)(s.span,{className:"mord",children:"1"})}),(0,t.jsx)(s.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,t.jsx)(s.span,{className:"mbin",children:"−"}),(0,t.jsx)(s.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,t.jsx)(s.span,{className:"mord",children:(0,t.jsxs)(s.span,{className:"minner",children:[(0,t.jsx)(s.span,{className:"mopen delimcenter",style:{top:"0em"},children:(0,t.jsx)(s.span,{className:"delimsizing size3",children:"("})}),(0,t.jsxs)(s.span,{className:"mord",children:[(0,t.jsx)(s.span,{className:"mopen nulldelimiter"}),(0,t.jsx)(s.span,{className:"mfrac",children:(0,t.jsxs)(s.span,{className:"vlist-t vlist-t2",children:[(0,t.jsxs)(s.span,{className:"vlist-r",children:[(0,t.jsxs)(s.span,{className:"vlist",style:{height:"1.3714em"},children:[(0,t.jsxs)(s.span,{style:{top:"-2.314em"},children:[(0,t.jsx)(s.span,{className:"pstrut",style:{height:"3em"}}),(0,t.jsx)(s.span,{className:"mord",children:(0,t.jsxs)(s.span,{className:"mord",children:[(0,t.jsx)(s.span,{className:"mord text",children:(0,t.jsx)(s.span,{className:"mord",children:"tokenBalanceIn"})}),(0,t.jsx)(s.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,t.jsx)(s.span,{className:"mbin",children:"+"}),(0,t.jsx)(s.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,t.jsx)(s.span,{className:"mord text",children:(0,t.jsx)(s.span,{className:"mord",children:"tokenAmountIn"})})]})})]}),(0,t.jsxs)(s.span,{style:{top:"-3.23em"},children:[(0,t.jsx)(s.span,{className:"pstrut",style:{height:"3em"}}),(0,t.jsx)(s.span,{className:"frac-line",style:{borderBottomWidth:"0.04em"}})]}),(0,t.jsxs)(s.span,{style:{top:"-3.677em"},children:[(0,t.jsx)(s.span,{className:"pstrut",style:{height:"3em"}}),(0,t.jsx)(s.span,{className:"mord",children:(0,t.jsx)(s.span,{className:"mord text",children:(0,t.jsx)(s.span,{className:"mord",children:"tokenBalanceIn"})})})]})]}),(0,t.jsx)(s.span,{className:"vlist-s",children:"​"})]}),(0,t.jsx)(s.span,{className:"vlist-r",children:(0,t.jsx)(s.span,{className:"vlist",style:{height:"0.7693em"},children:(0,t.jsx)(s.span,{})})})]})}),(0,t.jsx)(s.span,{className:"mclose nulldelimiter"})]}),(0,t.jsx)(s.span,{className:"mclose delimcenter",style:{top:"0em"},children:(0,t.jsx)(s.span,{className:"delimsizing size3",children:")"})})]})}),(0,t.jsx)(s.span,{className:"mclose delimcenter",style:{top:"0em"},children:(0,t.jsx)(s.span,{className:"delimsizing size3",children:")"})})]})})]})]})]})}),(0,t.jsx)(s.p,{children:"You should be able to see that a change in the rounding direction proposed by option D would happen too late."})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"question-3-of-8",children:"Question 3 of 8"}),"\n",(0,t.jsx)(s.p,{children:"Regarding reentrancy risks (not considering potential additional functions):"}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. The ",(0,t.jsx)(s.code,{children:"nonReentrant"})," modifier must be added to prevent reentrancy between the two transfers "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. The user can re-enter through ",(0,t.jsx)(s.code,{children:"outGivenIn"})," "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. A reentrancy allows to manipulate the pool’s spot price "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. There is no reentrancy risk "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is A, C."})}),(0,t.jsxs)(s.blockquote,{children:["\n",(0,t.jsxs)(s.p,{children:["The reentrancy is tricky here, but if you re-enter on the transfer, and the callback is done after the funds have been moved, you basically end up with the pool in an transient state, where ",(0,t.jsx)(s.code,{children:"TokenOut"})," has decreased, but ",(0,t.jsx)(s.code,{children:"TokenIn"})," has not increased. ~jos"]}),"\n"]})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"question-4-of-8",children:"Question 4 of 8"}),"\n",(0,t.jsx)(s.p,{children:"Regarding fees implementation:"}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. The pool never receives any fees "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. To apply the 5% fees, the operation should be ",(0,t.jsx)(s.code,{children:"amountIn"})," * 100 / 105 "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. Rounding down on the fees allows users to steal the pool's funds "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. None of the above "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is A."})}),(0,t.jsxs)(s.blockquote,{children:["\n",(0,t.jsxs)(s.p,{children:["The fee is applied before we call ",(0,t.jsx)(s.code,{children:"outGivenIn"}),". As a result, the fee is not given the pool, but it just means that the users have a higher ",(0,t.jsx)(s.code,{children:"amountIn"})," than expected (but they will also receive more ",(0,t.jsx)(s.code,{children:"amountOut"}),"). ~jos"]}),"\n"]})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"question-5-of-8",children:"Question 5 of 8"}),"\n",(0,t.jsx)(s.p,{children:"Regarding the arithmetics:"}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. The arithmetics work regardless of the token’s name, decimals or total supply "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. Fixed point arithmetic allows for unlimited precision "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. Fixed point arithmetic prevents the rounding risks "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. None of the above "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is D."})}),(0,t.jsxs)(s.blockquote,{children:["\n",(0,t.jsxs)(s.p,{children:["For A, USDC won't work due to the decimals being 6 (ex: ",(0,t.jsx)(s.code,{children:"outGivenIn"})," uses ",(0,t.jsx)(s.code,{children:"10**18"})," for ",(0,t.jsx)(s.code,{children:"ONE"}),"). ~jos"]}),"\n"]}),(0,t.jsxs)(s.p,{children:["Fixed point arithmetic neither allows for unlimited precision (it is still restricted by the underlying datatype ",(0,t.jsx)(s.code,{children:"uint256"}),") nor does it completely prevent rounding risks for the same reason."]})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"question-6-of-8",children:"Question 6 of 8"}),"\n",(0,t.jsx)(s.p,{children:"The following statement(s) is/are true:"}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. SafeERC20 should be used to prevent issues with token transfers "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. SafeMath should be used to prevent integer overflow "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. Making ",(0,t.jsx)(s.code,{children:"swapOutGivenIn"})," external will reduce gas cost "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. Making ",(0,t.jsx)(s.code,{children:"outGivenIn"})," public would allow an attacker to steal the pool’s funds "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is A."})}),(0,t.jsxs)(s.p,{children:["At the moment the contract would not be able to support ERC20 tokens that return boolean values (",(0,t.jsx)(s.code,{children:"false"}),") in case of error, because it's not checking for any return values at all when making transfer-calls. The SafeERC20 library would wrap interactions with ERC20 tokens and ensure that both tokens that revert and return ",(0,t.jsx)(s.code,{children:"false"})," on error are handled correctly."]}),(0,t.jsx)(s.p,{children:"No overflow protection is required in this version of Solidity."}),(0,t.jsxs)(s.p,{children:["Changing a function's visibility from ",(0,t.jsx)(s.code,{children:"public"})," to ",(0,t.jsx)(s.code,{children:"external"})," does not impact its gas usage on its own. Rather, the data-location of its parameters does (by avoiding copying to memory but instead accessing parameter values directly in calldata). The function does not make use of datatypes that specify a data-location though, so gas cost can't be reduced this way here."]}),(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.code,{children:"outGivenIn"})," is a ",(0,t.jsx)(s.code,{children:"pure"})," function (ie. it does not change state, or even read chain information at all) which makes it save to set as any visibility."]})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"question-7-of-8",children:"Question 7 of 8"}),"\n",(0,t.jsxs)(s.p,{children:["Regarding slippage/front running risks for ",(0,t.jsx)(s.code,{children:"swapOutGivenIn"}),":"]}),"\n",(0,t.jsxs)("ul",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A. ",(0,t.jsx)(s.code,{children:"MinAmountIn"})," should be added as a parameter "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B. ",(0,t.jsx)(s.code,{children:"MaxAmountIn"})," should be added as a parameter "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C. ",(0,t.jsx)(s.code,{children:"MinAmountOut"})," should be added as a parameter "]}),(0,t.jsxs)("li",{className:"jsx-ea2c409626c7be76",children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. ",(0,t.jsx)(s.code,{children:"MaxAmountOut"})," should be added as a parameter "]})]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is C."})}),(0,t.jsxs)(s.p,{children:["Currently the user is only specifying an ",(0,t.jsx)(s.code,{children:"amountIn"}),", in other words, the amount he wants to exchange for the other token. The contract, based on ",(0,t.jsx)(s.code,{children:"amountIn"})," and its current ratio of token balances, computes the ",(0,t.jsx)(s.code,{children:"amountOut"})," that the user will receive of the other token. It's possible that the user's transaction is sandwiched, manipulating the ratio and profiting off the spread caused to the user. To prevent this, there should be an additional parameter that specifies a minimum ",(0,t.jsx)(s.code,{children:"amountOut"})," that the user requires for this exchange."]})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"question-8-of-8",children:"Question 8 of 8"}),"\n",(0,t.jsx)(s.p,{children:"Assuming there is no bug in the codebase (and all potential bugs highlighted in this RACE are fixed), which one of these swap invariants would be correct?"}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," A."]}),"\n",(0,t.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-language":"plaintext","data-theme":"default",children:[(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"// To be added at the end of the function"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"uint k_before = balanceIn * balanceOut;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"uint k_after = tokenIn.balanceOf(address(this)) * tokenOut.balanceOf(address(this));"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"require(k_before == k_after);"})})]})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," B."]}),"\n",(0,t.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-language":"plaintext","data-theme":"default",children:[(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"// To be added at the end of the function"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"uint k_before = balanceIn * balanceOut;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"uint k_after = tokenIn.balanceOf(address(this)) * tokenOut.balanceOf(address(this));"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"require(k_before >= k_after);"})})]})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," C."]}),"\n",(0,t.jsx)(s.pre,{"data-language":"plaintext","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-language":"plaintext","data-theme":"default",children:[(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"// To be added at the end of the function"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"uint k_before = balanceIn * balanceOut;"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"uint k_after = tokenIn.balanceOf(address(this)) * tokenOut.balanceOf(address(this));"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"require(k_before <= k_after);"})})]})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)("input",{type:"checkbox",className:"jsx-ea2c409626c7be76"})," D. None of the above"]}),"\n",(0,t.jsxs)(HiddenSolution,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Correct is C."})}),(0,t.jsx)(s.p,{children:"Assuming correct code, it must be the option where k increases thanks to collecting fees."})]}),"\n",(0,t.jsx)(s.hr,{}),"\n","\n",(0,t.jsxs)(l.oy,{children:[(0,t.jsx)(l.Zb,{icon:(0,t.jsx)(x.H8,{}),title:"← RACE #29 Of The Secureum Bootcamp Epoch∞",href:"/posts/2024/5/15/race-29-of-the-secureum-bootcamp-epoch-infinity/"}),(0,t.jsx)(l.Zb,{icon:(0,t.jsx)(x.H8,{}),title:"RACE #31 Of The Secureum Bootcamp Epoch∞ →",href:"/posts/2024/7/30/race-31-of-the-secureum-bootcamp-epoch-infinity"})]})]})}s.default=(0,r.j)({MDXContent:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:s}=Object.assign({},(0,c.a)(),e.components);return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(_createMdxContent,{...e})}):_createMdxContent(e)},pageOpts:{filePath:"pages/posts/2024/6/24/race-30-of-the-secureum-bootcamp-epoch-infinity.mdx",route:"/posts/2024/6/24/race-30-of-the-secureum-bootcamp-epoch-infinity",timestamp:1731290394e3,title:"RACE #30 Of The Secureum Bootcamp Epoch∞",headings:u},pageNextRoute:"/posts/2024/6/24/race-30-of-the-secureum-bootcamp-epoch-infinity"})},96139:function(e,s,n){var t=n(94869);n(26228);var a=n(70079),i=a&&"object"==typeof a&&"default"in a?a:{default:a};function _defineProperties(e,s){for(var n=0;n<s.length;n++){var t=s[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}var r=void 0!==t&&t.env&&!0,isString=function(e){return"[object String]"===Object.prototype.toString.call(e)},c=function(){function StyleSheet(e){var s=void 0===e?{}:e,n=s.name,t=void 0===n?"stylesheet":n,a=s.optimizeForSpeed,i=void 0===a?r:a;invariant$1(isString(t),"`name` must be a string"),this._name=t,this._deletedRulePlaceholder="#"+t+"-deleted-rule____{}",invariant$1("boolean"==typeof i,"`optimizeForSpeed` must be a boolean"),this._optimizeForSpeed=i,this._serverSheet=void 0,this._tags=[],this._injected=!1,this._rulesCount=0;var c=document.querySelector('meta[property="csp-nonce"]');this._nonce=c?c.getAttribute("content"):null}var e,s=StyleSheet.prototype;return s.setOptimizeForSpeed=function(e){invariant$1("boolean"==typeof e,"`setOptimizeForSpeed` accepts a boolean"),invariant$1(0===this._rulesCount,"optimizeForSpeed cannot be when rules have already been inserted"),this.flush(),this._optimizeForSpeed=e,this.inject()},s.isOptimizeForSpeed=function(){return this._optimizeForSpeed},s.inject=function(){var e=this;if(invariant$1(!this._injected,"sheet already injected"),this._injected=!0,this._optimizeForSpeed){this._tags[0]=this.makeStyleTag(this._name),this._optimizeForSpeed="insertRule"in this.getSheet(),this._optimizeForSpeed||(r||console.warn("StyleSheet: optimizeForSpeed mode not supported falling back to standard mode."),this.flush(),this._injected=!0);return}this._serverSheet={cssRules:[],insertRule:function(s,n){return"number"==typeof n?e._serverSheet.cssRules[n]={cssText:s}:e._serverSheet.cssRules.push({cssText:s}),n},deleteRule:function(s){e._serverSheet.cssRules[s]=null}}},s.getSheetForTag=function(e){if(e.sheet)return e.sheet;for(var s=0;s<document.styleSheets.length;s++)if(document.styleSheets[s].ownerNode===e)return document.styleSheets[s]},s.getSheet=function(){return this.getSheetForTag(this._tags[this._tags.length-1])},s.insertRule=function(e,s){if(invariant$1(isString(e),"`insertRule` accepts only strings"),this._optimizeForSpeed){var n=this.getSheet();"number"!=typeof s&&(s=n.cssRules.length);try{n.insertRule(e,s)}catch(s){return r||console.warn("StyleSheet: illegal rule: \n\n"+e+"\n\nSee https://stackoverflow.com/q/20007992 for more info"),-1}}else{var t=this._tags[s];this._tags.push(this.makeStyleTag(this._name,e,t))}return this._rulesCount++},s.replaceRule=function(e,s){if(this._optimizeForSpeed){var n=this.getSheet();if(s.trim()||(s=this._deletedRulePlaceholder),!n.cssRules[e])return e;n.deleteRule(e);try{n.insertRule(s,e)}catch(t){r||console.warn("StyleSheet: illegal rule: \n\n"+s+"\n\nSee https://stackoverflow.com/q/20007992 for more info"),n.insertRule(this._deletedRulePlaceholder,e)}}else{var t=this._tags[e];invariant$1(t,"old rule at index `"+e+"` not found"),t.textContent=s}return e},s.deleteRule=function(e){if(this._optimizeForSpeed)this.replaceRule(e,"");else{var s=this._tags[e];invariant$1(s,"rule at index `"+e+"` not found"),s.parentNode.removeChild(s),this._tags[e]=null}},s.flush=function(){this._injected=!1,this._rulesCount=0,this._tags.forEach(function(e){return e&&e.parentNode.removeChild(e)}),this._tags=[]},s.cssRules=function(){var e=this;return this._tags.reduce(function(s,n){return n?s=s.concat(Array.prototype.map.call(e.getSheetForTag(n).cssRules,function(s){return s.cssText===e._deletedRulePlaceholder?null:s})):s.push(null),s},[])},s.makeStyleTag=function(e,s,n){s&&invariant$1(isString(s),"makeStyleTag accepts only strings as second parameter");var t=document.createElement("style");this._nonce&&t.setAttribute("nonce",this._nonce),t.type="text/css",t.setAttribute("data-"+e,""),s&&t.appendChild(document.createTextNode(s));var a=document.head||document.getElementsByTagName("head")[0];return n?a.insertBefore(t,n):a.appendChild(t),t},_defineProperties(StyleSheet.prototype,[{key:"length",get:function(){return this._rulesCount}}]),e&&_defineProperties(StyleSheet,e),StyleSheet}();function invariant$1(e,s){if(!e)throw Error("StyleSheet: "+s+".")}var stringHash=function(e){for(var s=5381,n=e.length;n;)s=33*s^e.charCodeAt(--n);return s>>>0},l={};function computeId(e,s){if(!s)return"jsx-"+e;var n=String(s),t=e+n;return l[t]||(l[t]="jsx-"+stringHash(e+"-"+n)),l[t]}function computeSelector(e,s){var n=e+s;return l[n]||(l[n]=s.replace(/__jsx-style-dynamic-selector/g,e)),l[n]}var o=function(){function StyleSheetRegistry(e){var s=void 0===e?{}:e,n=s.styleSheet,t=void 0===n?null:n,a=s.optimizeForSpeed,i=void 0!==a&&a;this._sheet=t||new c({name:"styled-jsx",optimizeForSpeed:i}),this._sheet.inject(),t&&"boolean"==typeof i&&(this._sheet.setOptimizeForSpeed(i),this._optimizeForSpeed=this._sheet.isOptimizeForSpeed()),this._fromServer=void 0,this._indices={},this._instancesCounts={}}var e=StyleSheetRegistry.prototype;return e.add=function(e){var s=this;void 0===this._optimizeForSpeed&&(this._optimizeForSpeed=Array.isArray(e.children),this._sheet.setOptimizeForSpeed(this._optimizeForSpeed),this._optimizeForSpeed=this._sheet.isOptimizeForSpeed()),this._fromServer||(this._fromServer=this.selectFromServer(),this._instancesCounts=Object.keys(this._fromServer).reduce(function(e,s){return e[s]=0,e},{}));var n=this.getIdAndRules(e),t=n.styleId,a=n.rules;if(t in this._instancesCounts){this._instancesCounts[t]+=1;return}var i=a.map(function(e){return s._sheet.insertRule(e)}).filter(function(e){return -1!==e});this._indices[t]=i,this._instancesCounts[t]=1},e.remove=function(e){var s=this,n=this.getIdAndRules(e).styleId;if(function(e,s){if(!e)throw Error("StyleSheetRegistry: "+s+".")}(n in this._instancesCounts,"styleId: `"+n+"` not found"),this._instancesCounts[n]-=1,this._instancesCounts[n]<1){var t=this._fromServer&&this._fromServer[n];t?(t.parentNode.removeChild(t),delete this._fromServer[n]):(this._indices[n].forEach(function(e){return s._sheet.deleteRule(e)}),delete this._indices[n]),delete this._instancesCounts[n]}},e.update=function(e,s){this.add(s),this.remove(e)},e.flush=function(){this._sheet.flush(),this._sheet.inject(),this._fromServer=void 0,this._indices={},this._instancesCounts={}},e.cssRules=function(){var e=this,s=this._fromServer?Object.keys(this._fromServer).map(function(s){return[s,e._fromServer[s]]}):[],n=this._sheet.cssRules();return s.concat(Object.keys(this._indices).map(function(s){return[s,e._indices[s].map(function(e){return n[e].cssText}).join(e._optimizeForSpeed?"":"\n")]}).filter(function(e){return!!e[1]}))},e.styles=function(e){var s,n;return s=this.cssRules(),void 0===(n=e)&&(n={}),s.map(function(e){var s=e[0],t=e[1];return i.default.createElement("style",{id:"__"+s,key:"__"+s,nonce:n.nonce?n.nonce:void 0,dangerouslySetInnerHTML:{__html:t}})})},e.getIdAndRules=function(e){var s=e.children,n=e.dynamic,t=e.id;if(n){var a=computeId(t,n);return{styleId:a,rules:Array.isArray(s)?s.map(function(e){return computeSelector(a,e)}):[computeSelector(a,s)]}}return{styleId:computeId(t),rules:Array.isArray(s)?s:[s]}},e.selectFromServer=function(){return Array.prototype.slice.call(document.querySelectorAll('[id^="__jsx-"]')).reduce(function(e,s){return e[s.id.slice(2)]=s,e},{})},StyleSheetRegistry}(),h=a.createContext(null);h.displayName="StyleSheetContext";var d=i.default.useInsertionEffect||i.default.useLayoutEffect,x=new o;function JSXStyle(e){var s=x||a.useContext(h);return s&&d(function(){return s.add(e),function(){s.remove(e)}},[e.id,String(e.dynamic)]),null}JSXStyle.dynamic=function(e){return e.map(function(e){return computeId(e[0],e[1])}).join(" ")},s.style=JSXStyle},65910:function(e,s,n){"use strict";e.exports=n(96139).style},26228:function(){}},function(e){e.O(0,[3220,1589,9774,2888,179],function(){return e(e.s=64311)}),_N_E=e.O()}]);